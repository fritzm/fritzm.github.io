<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>fritzm.github.io - Retro-Computing</title>
    <meta name="description" content="">
    <meta name="author" content="Fritz Mueller">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="https://fritzm.github.io/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="https://fritzm.github.io/theme/bootstrap.min.css" rel="stylesheet">
    <link href="https://fritzm.github.io/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="https://fritzm.github.io/theme/local.css" rel="stylesheet">
    <link href="https://fritzm.github.io/theme/pygments.css" rel="stylesheet">

    <!-- Photoswipe -->
    <link rel="stylesheet" href="https://fritzm.github.io/theme/photoswipe.css">
    <link rel="stylesheet" href="https://fritzm.github.io/theme/default-skin/default-skin.css">
    <script src="https://fritzm.github.io/theme/photoswipe.min.js"></script>
    <script src="https://fritzm.github.io/theme/photoswipe-ui-default.min.js"></script>
    <script src="https://fritzm.github.io/galleries.js"></script>
    <script type="text/javascript">
        var pswipe = function(gname, index) {
            var pswpElement = document.querySelectorAll('.pswp')[0];
            var items = galleries[gname];
            var options = { index: index };
            var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
            gallery.init();
        };
    </script>

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="https://fritzm.github.io/feeds/all.rss.xml" rel="alternate" title="fritzm.github.io" type="application/rss+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="https://fritzm.github.io">fritzm.github.io</a>

        <div class="nav-collapse">
        <ul class="nav">
            
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
        

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/gt40.html"><h1>GT40 Terminal</h1></a>
Mon 21 August 2023

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>A while ago my friend Scott approached me with an idea to collaborate on restoration of a DEC GT40 graphic
display terminal of unknown status, belonging to a third collector friend of ours; the idea was to restore the
machine to working order for exhibition at the various summer/fall vintage computer shows. The GT40 ran an
early (pre-Atari) graphical version of the lunar lander game which was released in 1973. The 50th anniversary
of this code seemed a nice theme for the exhibit.</p>
<p>The GT40 was an integrated product consisting of a PDP-11/05 (KD11-B) CPU, a VT11 vector display processor,
a VR14 X-Y monitor, a light pen, keyboard, and a DL11 serial interface:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/GT40.png" title="The DEC GT40"/></p>
<p>Scott retrieved the terminal, which had a fairly bad case of screen rot. We agreed that Scott would work on
restoration of the monitor while I dug in on the system unit. Scott got to work while I dealt with
distractions of ongoing home renovations, a ton of work-related travel, and my first bout of COVID (blaargh!)</p>
<p>The screen rot is caused by a deterioriation of a polyvinyl acetate (PVA) layer sandwiched between the front
surface of the CRT glass and an outer protective implosion shield. All of this is held together by a retaining
ring affixed to the CRT with silicone adhesive. The only fix for this is to disassemble the monitor, separate
the sandwich, and clean out and replace the deteriorated PVA layer.</p>
<p>After chatting with some folks who had successfully conducted a similar VR14 restoration at the <a href="https://www.ricomputermuseum.org/">Rhode Island
Computer Museum</a>, Scott obtained some <a href="https://prosoco.com/product/dicone-nc9/">silicone
digester</a> to aid in separation of the retaining ring.  The terminal
was disassembled and then digester was repeatedly injected under the ring with a syringe, allowed to sit, and
the resulting softened silicone scraped away over the course of a week.</p>
<p>Scott then worked to conform a lexan sheet to the interior of the implosion shield as a replacement for the
PVA layer, as RICM had done.  This process, conducted in a home oven, proved to be quite fiddly.  But
persistence paid off, and the end result looks very nice!</p>
<p>After a precautionary reform of the larger power supply electrolytics, careful reassembly, and a gradual
bringup on a variac, the monitor showed proof of life on the bench, hooked up to a signal generator source.</p>
<p><img src='/images/pdp11/VR14-screen-rot_thumbnail_tall.JPG' title='GT40 display (VR14) with screen rot' onclick='pswipe("pdp11",105);'/>
<img src='/images/pdp11/VR14-digesting_thumbnail_tall.JPG' title='Silicone digester repeatedly injected beneath the retaining ring, and softened silicone sraped away a layer at a time.' onclick='pswipe("pdp11",106);'/>
<img src='/images/pdp11/VR14-apart_thumbnail_tall.JPG' title='After a week of work the retaining ring was freed and the layers were able to be separated and cleaned.' onclick='pswipe("pdp11",107);'/>
<img src='/images/pdp11/VR14-plexi_thumbnail_tall.JPG' title='Conforming plexiglass in the oven to fill the gap between the display tube and the implosion shield where the PVA used to be.' onclick='pswipe("pdp11",108);'/>
<img src='/images/pdp11/VR14-working_thumbnail_tall.png' title='Display re-assembled and working, driven by a test oscillator, and looking nice!' onclick='pswipe("pdp11",109);'/></p>
<p>In the meantime, starting to feel better, I began to look at the CPU unit.  Power supply electrolytics
appeared to be in good shape, and the supply came up on the bench without much difficulty.</p>
<p>The module utilization for this backplane is as follows:</p>
<style>
.module-utilization {
  font-size: smaller;
  width: 50em;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1rem;
  margin-bottom: 2rem;
  border-collapse: true;
}
.module-utilization th {
  padding: .5em;
  font-weight: normal;
}
.module-utilization tr:first-child th {
  width: 16.67%;
}
.module-utilization td {
  border: 1px solid black;
  padding: .5em;
  text-align: center;
}
.module-utilization td:empty {
  background-color: LightGray;
}
.module-utilization tr:first-child td:first-child {
  border: none;
  visibility: hidden;
}
</style>

<table class="module-utilization">
  <tr><td></td><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th></tr>
  <tr><th>1</td><td colspan=6>A320 VT40 Display Generator</td></tr>
  <tr><th>2</td><td colspan=6>M7013 VT40 Display Control</td></tr>
  <tr><th>3</td><td colspan=6>M7014 VT40 Bus Control</td></tr>
  <tr><th>4</td><td colspan=2></td><td colspan=4>M7800 DL11 Serial</td></tr>
  <tr><th>5</td><td colspan=2>M930 Term. / UNIBUS out</td><td colspan=4>H214 Core Stack (8K x 16)</td></tr>
  <tr><th>6</td><td colspan=6>G231 Core Memory Driver</td></tr>
  <tr><th>7</td><td colspan=6>G110 Core Memory Control</td></tr>
  <tr><th>8</td><td colspan=6>M7261 KD11-B Control</td></tr>
  <tr><th>9</td><td colspan=6>M7260 KD11-B Data Paths</td></tr>
</table>

<p>On the assumption (later proved wrong) that this was effectively the same as a PDP-11/05 setup, I began debug
with just the two CPU cards, an M9301 boot/terminator in position 5A-B, and a grant continuity "knuckle
buster" in position 4D.  Some problems were immediately apparent from the front console: deposit and examine
operations to various memory-mapped CPU registers seemed to work as expected, but when examining contents the
M9301 ROM locations bit 13 was always displaying zero.  The CPU would not enter run mode, nor could it be
single stepped.</p>
<p>Docs suggested that the GT40 would accomodate a KM11 debug module in postion 1B, so in this went.  The machine
behaved even more strangely when the KM11 was in, hanging up entirely unless the KM11 was put in manual clock
mode, and even then stepping microstates at unexpected times.  It took a little probing of the CPU clock
circuits to discover why:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/GT40-CPU-clock.png" title="GT40 CPU clock circuit"/></p>
<p>Here we see the RC clock at E019.  CONJ MAN CLK L is wired to KM11 switch S2, and inhibits the RC clock when
pulled low.  With the RC clock thus disabled, NOR gate E027 admits manual clocking via CONJ S CLK ON L,
connected to KM11 (momentary) switch S4.  The output at E027 pin 11 continues downstream from here as the
basis of the main processor clock signal.</p>
<p>As it happened, momentary switch S4 was wired on my KM11 replica with opposite sense from that expected. Thus
in its resting postion CONJ S CLK ON L was <em>asserted</em> (low), which meant the clock output at E027 pin 11 was
forced constantly high, regardless of the state of the RC clock.  This was verified by leaving S2 "off" and
pulling S4 over to its momentary position, whence the CPU clock immediately picked up again.</p>
<p>I had never noticed this switch reversal when using the KM11 with the 11/45, the RK11-C, or the 11/34 -- all
of these have different clocking circuits unaffected by the default postion of S4.  Desoldered and rotated S4
180 degrees, and the problem was fixed.</p>
<p>After having addressed this, I single stepped through a few of the console microcode flows and was able to
match the microcode listings to what was displayed on the KM11 and the console lights with some success.  An
action shot of the KM11:</p>
<p><img src='/images/pdp11/GT40-KM11_thumbnail_tall.JPG' title='GT40 system unit with KM11 replica board and microcode control board out on debug extender below.  The next microcode address is displayed in the bottom two rows of LEDs, with the LSB at the bottom right. Dark LEDs are logic 1, and lit are logic 0.  The next address displayed here is octal 316. From the microcode listings, we can see we are about to branch to micro-state CCS-1 (console continue switch), and can deduce that we are currently in micro-state H-2, about to branch out of the halt microcode loop to the continue switch handler.' onclick='pswipe("pdp11",110);'/></p>
<p>A few tips for anybody else who might be micro-stepping the KD11-B CPU, while we are here:</p>
<ul>
<li>
<p>The MPC address displayed on the KM11 is <em>negated</em> -- dark LEDs are ones, and lit LEDs are zeros. This
  definitely takes a little getting used to...</p>
</li>
<li>
<p>The MPC address displayed on the KM11 is the address of the <em>next</em> micro-instruction, not the current
  one.  This is also pretty tricky until you get the hang of it.  One nice thing about it, though, is that
  the displayed next address does include the wired-or outputs of micro-branches.</p>
</li>
<li>
<p>Each manual clock toggle is one <em>bus clock</em>, and typically, a micro-instruction will take two bus clocks to
  execute.  An exception is the inner part (single shifts) of the micro-flows for shift and rotate
  instructions, which only take a single bus clock.  Generally, it is useful to go ahead and advance two bus
  clocks at a time, as it is easy to get confused probing for signals that by design aren't clocked until the
  second bus clock within the micro-instruction.</p>
</li>
<li>
<p>The console lights are hard-wired to always display the ALU B-leg input.  Useful intermediate information is
  often displayed there intentionally by the microcode flows.</p>
</li>
</ul>
<p>Now it was possible to put the data paths board out on extenders and step the microcode for a console
examine of a ROM location with bit 13 set, and see why bit 13 never showed up on the console lights.  To
understand this properly, we need to see an excerpt of the KD11-B data paths:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/KD11-B-datapath.png" title="KD11-B data path (excerpt)" width="70%"/></p>
<p>Here you see the ALU in the middle, fed by its B-leg and A-leg inputs. B-leg is fed from the B-register, with
provisions for shifting, sign-extension, or forcing the constant +1. B-leg is also continuously displayed on
the console lights. A-leg contains, significantly, the 16-location scratch-pad memory (SPM). The first eight
locations of this hold processor registers R0 through R7; the remaining eight locations serve as temporary
registers for use by the microcode. A-leg can also provide misceallaneous constants from a small ROM.</p>
<p>The A-mux, below the ALU, determines whether the main processor data path is fed from the ALU output, or from
the UNIBUS data lines.</p>
<p>With this in mind, the relevant microcode source sequence (taken from the listings in the engineering
drawings) is as follows:</p>
<div class="highlight"><pre><span></span>LOC  NXT  * CONSOLE EXAMINE SWITCH- FIRST TIME IN SEQUENCE (DON&#39;T INC R[17])
          / GET TO CE1-1 FROM H-2 VIA BUT SWITCH
          / GET TO CE1-1 FROM CE2-2 VIA GOTO
317  307  CE1-1 BA,B←R[17]; BUT SWITCH
          / DISPLAY ADDRESS BY PUTTING INTO THE B REGISTER WHILE EXAMINE IS DOWN
          / LOOP ON CE1-1 UNTIL SWITCH IS RELEASED
307  326  CE1-2 DATI; CKOFF
326  302  CE1-3 B←UNIBUS DATA; GOTO H-2
</pre></div>


<p>At micro-location 317 (state CE-1, "console examine 1"), the bus address register and B-register are loaded
from SPM location 17, which holds the current console load/examine address.  BUT SWITCH ("branch micro-test
switch") causes the microcode to loop here as long as the examine switch is depressed.  During this time, the
fetch address is displayed on the console lights since it has been loaded into the B-register.  This was all
observed to be functioning normally.</p>
<p>When the examine switch is released, we branch to micro-location 307.  Here, a UNIBUS read (DATI) bus cycle is
initiated, and the processor clock and microcode execution are suspended until the bus target asyncrohonously
asserts SSYN (indicating valid data on the bus) or alternatively times out.  The bus cycle was observed to
occur normally, leaving SSYN and the correct data (including a correct bit 13) asserted on the UNIBUS.</p>
<p>Proceeding to micro-location 326, we see that the A-mux should be set up there to admit the data from the
UNIBUS to the main processor data path and then the B-register should be latched for display. Here a problem
was apparent. Sheet DPD of the GT40 engineering drawings covers bits 15:12 of the data paths; package E015
there is an 8266 2x4 mux which implements that slice of the A-mux.  E015 was seen via logic probe to be set up
with correct select codes and correct input from the UNIBUS. UNIBUS bit 13 was not being correctly passed on
to its corresponding output, however -- a failed part.</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/GT40-bad-amux.png" title="KD11-B AMUX 15:12"/></p>
<p>The 8266 is out of production and somewhat rare; for the time being a functioning 8266 was "borrowed" from a
spare GT40 data paths board that we obtained from our fellow collector.  Removed the bad part, socketed, and
replaced with the borrowed part, and the bit 13 display problem was fixed!</p>
<p>Moving next to the run/step problem, the machine was seen to be hanging up in micro-state F-3, after
initiating the DATI bus cycle to fetch an instruction. This lead to investigation of some of the the bus
control logic, as detailed on sheet CONC of the engineering drawings:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/KD11-B-DATI-bus-control.png" title="GT40 DATI bus control logic (excerpt)"/></p>
<p>The CPU must negotiate for control of the UNIBUS and assert BBSY if successful.  Here I could see the DATI
request being successfully latched, but BBSY assertion was blocked at E014 by CONC NPR GRANT H, a
non-processor request (DMA) bus grant.  Sure enough, some more probing indicated the the processor had issued
a NPR grant because it was reading an NPR request over the UNIBUS.  Where was that coming from with nothing
else in the system?</p>
<p>Well, it turns out in the GT40 the near-side bus termination is integrated onto the M7014 GT40 bus control
board that must but in slot 3, so you can't really debug without this card in place!  (It <em>could</em> be that an
additional M930 terminator in 3-A,B would work, as in a stock 11/05, but I haven't checked the backplane wire
list in detail to be certain of this.)  In any case, slotted in the M7014, and the machine began to behave
much more rationally with a properply configured bus...</p>
<p>Went for broke and slotted in the rest of the display interface boards and (why not?) the core memory and DL11
as well.  The machine was showing very promising signs of life.  The terminal emulator in the bootstrap ROM
ran and was able to render recevied characters on the display!  Characters typed on the keyboard were also
successfully forwarded out the DL11.  A line feed character typed to the terminal emulator seemed to crash it,
so that still needed to be looked into.  Took the time to toggle in a small test program from the user guide,
and this executed correctly rendering a square on the display, indicating most of the logic in the display
interface boards was also functioning correctly:</p>
<p><img src='/images/pdp11/GT40-good-sign_thumbnail_tall.jpeg' title='First sign of end-to-end life on the GT40: terminal emulator boostrap running, and rendering received characters.' onclick='pswipe("pdp11",111);'/>
<img src='/images/pdp11/GT40-square_thumbnail_tall.jpeg' title='GT40 display list processor running, rendering a square.' onclick='pswipe("pdp11",112);'/></p>
<p>Tried to get some program uploads going over the built-in binary loader in the bootstrap terminal emulator,
but this didn't seem to be quite working, either.  Took a short break for dinner, returned to examine this
further, ran for a few minutes, then disaster...  Something in the CPU let go, and the machine was once
again unable to execute code.</p>
<p>Digging in on this new failure a little, when attempting to single step ROM code from the front panel, the
PC was seen to increment by +1 instead of the expected +2; this resulted in an immediate bus error that
halted the machine.  Back in goes the KM11, then, and the same microcode stepping technique was used to
begin investigating.</p>
<p>So how does the KD11-B (ostensibly) increment the PC by 2?  It turns out this is done by selecting the PC (SPM
location 7) onto the ALU A-leg, constant +1 on the ALU B-leg, and introducing the additional +1 at the carry
input of the least significant bit slice of the ALU on sheet DPA of the engineering diagrams:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/KD11-B-plus-2.png" title="KD11-B ALU least-significant slice"/></p>
<p>Signal CONF CIN H comes from microcode, wire-or'd with output of operation decode ROMs in the ALU aux control
circuitry.  In this case, the logic probe revealed that this signal was erroneously low; further investigation
revealed that microcode PROM CONF E094 had failed:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/KD11-B-CONF-E094.png" title="KD11-B faile microcode PROM CONF E094" width="75%"/></p>
<p>Alright, this is an IM5603 (equiv. 82S126N) bipolar PROM, and I don't happen to have that in stock.  So now
we're stuck until we can source one.  At this point, the day job once again intervened, and I needed to
prepare to head off to the Rubin Observatory in Chile for a couple of weeks.  Scott came by to pick up the
work in progress; had time to share a short demonstration of microcode debug techniques, then off to pack and
prepare for my trip...</p>
<p>[ to be continued... ]</p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/apple-power-lang.html"><h1>Apple II Plus: power supply and language card</h1></a>
Mon 21 March 2022

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>Okay, so the Apple II Plus I was using to test the VM4209 monitor worked fine for about a half hour, then
smoked a RIFA cap in its power supply.  These are a very common known failure in various old microcomputer
power supplies, and I really should have already caught this on inspection and shotgunned it.  Boy, do they
generate a lot of smoke and stink when they go...</p>
<p>Electrolytics in here are also all pushing 40 years at this point and Astec opted for only 85C parts for many
of these, so I went ahead and ordered a <a href="https://console5.com/store/apple-2-power-supply-cap-kit-p-n-605-5703-astec-aa11040b-aa11040-b.html">whole replacement
kit</a> from
Console5.  I replaced the front end filters and anything on the back end that was 85C or looked even slightly
bulgy, which ended up being most of them:</p>
<p><img src='/images/micros/apple-ii-rifa_thumbnail_tall.jpeg' title='Blown RIFA capacitor from Apple II Plus power supply' onclick='pswipe("micros",5);'/>
<img src='/images/micros/apple-ii-pwr-before_thumbnail_tall.jpeg' title='Apple II Plus power supply before cap replacements' onclick='pswipe("micros",6);'/>
<img src='/images/micros/apple-ii-pwr-after_thumbnail_tall.jpeg' title='Apple II Plus power supply after cap replacements' onclick='pswipe("micros",7);'/></p>
<p>Put it all back together and back in business, except noticed an additional problem: DOS 3.3 booted but
neither recognized nor loaded the "language card" (soft ROM) present in the machine.  Since my machine has
Applesoft BASIC in system ROM, this meant no Integer BASIC (and no ROM mini-assembler) for me until this was
fixed.</p>
<p>For those who might not be familiar with the Apple II language card, it provides several features.  An Apple
II or II Plus can have at most 48K of RAM on the system board.  The overall memory map looks like this:</p>
<style>
.memmap {
  font-family: monospace;
  width: 30em;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1rem;
  margin-bottom: 2rem;
  border-collapse: true; 
}
.memmap td {
  border: 1px solid black;
  padding: .5em;
  text-align: center;
}
</style>

<table class="memmap">
  <tr><td>$0000-$BFFF</td><td>RAM (48K)</td></tr>
  <tr><td>$C000-$CFFF</td><td>IO space (4K)</td></tr>
  <tr><td>$D000-$FFFF</td><td>ROM (12K)</td></tr>
</table>

<p>The first thing the language card provides is a 2K ROM which by default overlays whatever ROM is in the system
board socket for addresses <code>$F800</code> to <code>$FFFF</code>. This ROM holds the 6502 reset vector and the boot monitor; the
version provided on the language card has an "autostart" capability that will search for and boot off an
attached Disk II floppy.  I am not sure why Apple provided this ROM on the language card since the same ROM
could be upgraded directly on the fully-socketed system board, and indeed everything after the Apple II Plus
came with this autostart ROM pre-installed. Possibly this was done for maximum backward compatibility with
Apple's previously-offered "Firmware Card", which also contained this ROM?  Third-parties would later offer
clones of the language card that did <em>not</em> contain the additional/redundant F8 ROM, and nobody seems to have
particularly cared or noticed...</p>
<p>The second thing the language card provides is an additional 16K of RAM.  This can be loaded, then
write-protected and mapped over the entire ROM space of the machine from <code>$D000</code> to <code>$FFFF</code>, providing a "soft
ROM" capability.  Since the available ROM address space is only 12K, the leftover 4K or RAM on the language
card is bank switchable at address range <code>$D000</code> to <code>$DFFF</code>.</p>
<p>Advanced software which doesn't depend on the system ROMs at all can also map the RAM over the system ROM
address space and leave it in read/write mode, thus gaining access to a full 64K of RAM (with the caveat of
the switched bank at <code>$D000</code>.)</p>
<p>The language card programming interface presents as follows:</p>
<p><br><img style="display:block; margin-left:auto; margin-right:auto" src="/images/micros/apple-ii-lang-controls.png" title="Apple II language card control codes"/><br></p>
<p>My goal is to be able to run the initial (1980) release of Apple DOS 3.3. This version loads up the language
card at boot in soft ROM mode with Integer BASIC and an older version of the F8 monitor ROM, which contains a
few extra niceties like a built in mini-assembler and primitive step/trace capabilities.  A system so loaded
can then be conveniently switched back and forth between BASIC and monitor versions with the DOS "INT" and
"FP" commands.  But detection of my language card seemed to be failing, so it was never loaded up at boot.
Attempts to manually load and activate it also came to naught.</p>
<p>So, time to dig in and see what's going wrong... DOS 3.3 does initial checks and setup of the language card
via a small machine language program, loaded into RAM at boot by the DOS master disk's <code>HELLO</code> BASIC program.
Machine code is used for this part rather than BASIC so the probe/setup code can be placed and run from RAM
outside the mapping range of the language card (the BASIC interpreter itself running from ROM addresses
<em>within</em> this mapping range). Here is the machine language program, after being <code>POKE</code>d into RAM by <code>HELLO</code>,
listed via the ROM monitor:</p>
<div style="text-align: center"><img style="display:inline-block" src="/images/micros/dos33-hello-1.jpeg"
title="DOS 3.3 language probe, part 1/2"/> <img style="display:inline-block"
src="/images/micros/dos33-hello-2.jpeg" title="DOS 3.3 language probe, part 2/2"/></div>

<p>I interpret the actions of this code as follows:</p>
<ul>
<li>
<p>The code first retrieves and stashes the contents of location <code>$E000</code>, within the mappable address range. A
  read of <code>$C081</code> then maps the ROMs on the system board (see programming interface above), and the contents
  of <code>$E000</code> are checked again.  If the contents now differ, the code assumes the card, now in mapped ROM
  mode, was previously in mapped RAM mode, and it jumps to address <code>$0332</code> to put things back the way it found
  them and bail out.</p>
</li>
<li>
<p>If not, the code reads from address <code>$C083</code> twice, which puts the card, if present, in writable mapped RAM
  mode.  Two different values are written to and compared back from location <code>$D000</code>.  If a language card is
  <em>not</em> present, this location will still be mapped to ROM on the system board, and at least one of these
  compares will fail; if either one does, the code jumps to <code>$0332</code> to bail out.</p>
</li>
<li>
<p>Otherwise, we've verified that a card is present and wasn't already in active play.  The program now reads
  from address <code>$C081</code> twice to move back to mapped ROM mode, but leaving RAM writable to be loaded by the
  remainder of the <code>HELLO</code> program after return (in this mode, reads will come from system ROMs, but writes
  will go to the corresponding locations in language card RAM). A success return code is loaded, and the code
  jumps forward to the exit code at <code>$0334</code> to return to the caller.</p>
</li>
<li>
<p>The bail out routine at <code>$0332</code> just sets up a fail return code, then falls through to <code>$0334</code>.  Code here
  stores the return code to the return code location and does one last compare between the stashed and current
  values at <code>$E000</code> to determine if mapped RAM mode must be restored; if so this is done via a read from
  location <code>$C080</code> (RAM is left write-protected).  Control is then returned to BASIC.</p>
</li>
</ul>
<p>In any case, the above is what the code <em>does</em>, even if I may have misinterpreted some of its motivations.  On
my system, the ROM on the language card seemed to be working correctly (monitor ran fine, but if ROM on
language card was pulled the machine failed to boot, indicating the monitor was in fact running successfully
out of ROM on the card). However, mapped RAM mode seemed never to engage.  The machine code snippet above
returned "00" without crashing, and the DOS <code>HELLO</code> program assumed no card present.  Manually accessing the
appropriate control registers also had no effect.</p>
<p>The language card design does not seem to be documented in detail, but a schematic is available and it is not
too hard to suss out.  The first thing to check would seem to be the register interface.  Here is an excerpt
from the schematic, with a couple of annotations added:</p>
<p><br><img style="display:block; margin-left:auto; margin-right:auto" src="/images/micros/apple-ii-lang-schem.png" title="Apple II language card schematic excerpt"/><br></p>
<p>The register interface is principally implemented by a 74LS175 quad flip-flop at D4.  These flip-flops share a
common reset at power-on, and a common clock based on the expansion slot DEV_L signal; DEV_L is a
slot-specific signal strobed by the system on any bus cycles to IO address space allocated to that slot.
Examination of the programming interface along with address line decodes feeding the D inputs here leads to
the conclusion that the top-most flip-flop holds RAM/ROM mapping mode, the next one down is RAM bank select,
the next is RAM write-enable, and the last is a one-bit count to support write-enable after only two
successive reads.</p>
<p>Put a chipclip on at D4, and observed behavior of the flip-flops on the logic analyzer while exercising the
control registers via the monitor.  Problems were apparent right away: while the bank select and count
flip-flops were responding as expected, the mapping mode and wite-enable flip-flops were not.  The shared
reset and clock appeared correct, and all flip-flops themselves were responding logically correctly with
respect to their inputs.  The issue was apparently with the incoming D lines to two of the flip-flops.
Starting with the ROM/RAM enable flip-flop, then, that D line is fed via C3 and C4.  And a visual inspection
in preparation for clipping these up for the analyzer revealed that, surprisingly, these two chips had
actually been reversed on the board!</p>
<p>The language card is fully socketed, so presumeably this reversal had occured during previous troubleshooting
or service by the former owner?  In any case, it was easy to swap the chips back to their correct locations,
and the logic analyzer showed that the entire register interface seemed to be behaving according to design
after that.  DOS 3.3 now recognized the card at boot (yay!), but the system would crash after loading and
mapping the RAM.  So, maybe a bad RAM chip as well?</p>
<p>To troubleshoot the RAM, I followed a technique described in <a href="https://www.youtube.com/watch?v=wVUWaodwNNI&amp;t=1309s">this
video</a> on the "Adrian's Digital Basement" YouTube
channel.  Basically, a couple short machine language programs, entered and executed via the monitor, to copy
ROM contents into the language card RAM, then copy back out to another location in system RAM.  This allows a
comparison of source data in ROM and round-tripped data in system RAM; a mismatch indicates a RAM problem on
the card.  Here are the two programs I used and, and dumps of the resulting data:</p>
<div style="text-align: center">
  <img style="display:inline-block" src="/images/micros/apple-ii-copy-in.jpeg" title="Copy ROM to language card RAM"/>
  <img style="display:inline-block" src="/images/micros/apple-ii-copy-out.jpeg" title="Copy language card RAM to system RAM"/>
  <img style="display:inline-block" src="/images/micros/apple-ii-data-comp.jpeg" title="ROM data vs round-trip language card data"/>
</div>

<p>And sure enough, it's quite visible here that bit 7 is having problems.  Swapped out the 4116 at A2, and
that seems to have done it for this one.  Now I need to go find a copy of Choplifter...</p>
<p><img src='/images/micros/apple-ii-lang-card_thumbnail_tall.jpeg' title='Apple II Plus language card repairs: yellow indicates two chips that were found swapped on the card; red indicates a failed 4116 RAM chip that was replaced.' onclick='pswipe("micros",8);'/>
<img src='/images/micros/apple-ii-repaired_thumbnail_tall.jpeg' title='Apple II Plus: Successful DOS 3.3 boot after language card repairs' onclick='pswipe("micros",9);'/></p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/vm4209.html"><h1>Sanyo VM4209</h1></a>
Sun 13 March 2022

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>Some time back I purchased a Sanyo VM4209 B&amp;W video monitor on eBay.  Sold as working, it arrived with
apparently working horizontal but no vertical deflection.  The price had been right, however, so it was just
shelved into the repair queue.</p>
<p><br><img style="display:block; margin-left:auto; margin-right:auto" src="/images/micros/vm4209.png" title="VM4209 video monitor"/><br></p>
<p>I now have a few DEC VT series terminals to work on and would like to have a small video monitor available on
the bench for this, so I pulled down the VM4209 to give it a look.  Given the lack of vertical deflection, the
first thing to check would be the vertical deflection power transistors, Q105 and Q106 here:</p>
<p><br><img style="display:block; margin-left:auto; margin-right:auto" src="/images/micros/vm4209-vert-schem.png" title="VM4209 vertical deflection"/><br></p>
<p>It turns out these transistors are quite well buried in the guts of the monitor on a small aluminum heat sink.
Took a while to work my way in to them, and required unsoldering a few leads and removing the CRT:</p>
<p><img src='/images/micros/vm4209-crt_thumbnail_tall.jpeg' title='VM4209: CRT' onclick='pswipe("micros",0);'/>
<img src='/images/micros/vm4209-chassis_thumbnail_tall.jpeg' title='VM4209: chassis with CRT removed' onclick='pswipe("micros",1);'/>
<img src='/images/micros/vm4209-bottom_thumbnail_tall.jpeg' title='VM4209: underside of main board' onclick='pswipe("micros",2);'/>
<img src='/images/micros/vm4209-vtrans_thumbnail_tall.jpeg' title='VM4209: vertical deflection heat sink, with Q106 replacement' onclick='pswipe("micros",3);'/></p>
<p>Sure enough, the lead connecting Q106 collector to ground had been broken, and the part tested bad. Q105
appeared healthy, and there were no other apparent signs of distress in the surrounding circuitry. Q106 is an
out of production 2SB474 germanium PNP in the less common TO66 package; I opted to replace it with the
"modern" equivalent NTE226.  Re-assembled, and was greeted immediately with a functioning raster.  Pulled out
an Apple II Plus to test with:</p>
<p><img src='/images/micros/vm4209-appleii_thumbnail_tall.jpeg' title='VM4209: repaired, with Apple II Plus' onclick='pswipe("micros",4);'/></p>
<p>This was quite fun for a short while, until a RIFA cap in the Apple II power supply let go, filling the dining
room with acrid smoke.  So, expect an additional article on that one in the near future :-)</p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/rt11-basic.html"><h1>BASIC-11 under RT11</h1></a>
Sun 15 August 2021

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>I figured it might be fun to play around a little bit with BASIC-11 under RT11 on the newly-restored
PDP-11/34.  If I got that working, it could also be included on the RK05 RT11 disk image that I use regularly
for demos on the larger PDP-11/45.</p>
<p>The first thing to do was to find a compatible disk image and get it running under simh.  Bitsavers had
<code>BASIC-11_V2.1_RX02.DSK.zip</code>, which would seem to fit the bill, but the contained image would not mount
successfully on simh's RY device.  Looking through a dump of the image, there was an apparent "RT11A"
signature, so that looked promising.  Tried <code>putr</code> under dosbox as well, but it would hang mounting the image.
So, off to the cctalk mailing list for some advice...</p>
<p>Glen Slick on the list first noticed a file size discrepancy:</p>
<blockquote>
<p>That BASIC.DSK image file has a size of 486,400 bytes. I don't know where that size would come from.</p>
<p>A physical RX-02 floppy should have a sector size of 256 bytes, with 26 sectors per track, and 77 tracks,
which would be a total of 512,512 bytes, or 505,856 bytes if the first physical track is ignored.</p>
<p>Indeed, the other RX-02 floppy images available here do have a size of 505,856 bytes:
http://www.bitsavers.org/bits/DEC/pdp11/floppyimages/rx02/</p>
<p>Hmm, maybe that BASIC.DSK image file was created by something that only copied the initial allocated logical
sectors and ignored unused logical sectors at the end of the floppy, and maybe PUTR doesn't handle disk
image files that are not the expected full size?</p>
<p>Example of padding the 486,400 byte BASIC.DSK image file to a size of 512,512 bytes on a Windows system:</p>
<div class="highlight"><pre><span></span><span class="n">FSUTIL</span><span class="w"> </span><span class="k">FILE</span><span class="w"> </span><span class="n">CREATENEW</span><span class="w"> </span><span class="n">BLANK</span><span class="w"> </span><span class="mi">26112</span>
<span class="n">COPY</span><span class="w"> </span><span class="o">/</span><span class="n">B</span><span class="w"> </span><span class="n">BASIC</span><span class="p">.</span><span class="n">DSK</span><span class="o">+</span><span class="n">BLANK</span><span class="w"> </span><span class="n">TEST</span><span class="p">.</span><span class="n">DSK</span>

<span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">PUTR</span><span class="o">&gt;</span><span class="n">DIR</span><span class="w"> </span><span class="n">TEST</span><span class="p">.</span><span class="n">DSK</span>
<span class="n">Volume</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">label</span><span class="p">.</span>
<span class="n">Volume</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">14</span><span class="n">CE</span><span class="o">-</span><span class="mi">1</span><span class="n">A29</span>
<span class="n">Directory</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">PUTR</span>
<span class="mi">08</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2021</span><span class="w">  </span><span class="mi">12</span><span class="err">:</span><span class="mi">55</span><span class="n">p</span><span class="w">             </span><span class="mi">512</span><span class="p">,</span><span class="mi">512</span><span class="w"> </span><span class="n">TEST</span><span class="p">.</span><span class="n">DSK</span>

<span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">PUTR</span><span class="o">&gt;</span><span class="n">PUTR</span>
<span class="n">PUTR</span><span class="w"> </span><span class="n">V2</span><span class="mf">.01</span><span class="w">  </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="mi">1995</span><span class="o">-</span><span class="mi">2001</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">John</span><span class="w"> </span><span class="n">Wilson</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wilson</span><span class="nv">@dbit</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span><span class="p">.</span>
<span class="ow">All</span><span class="w"> </span><span class="n">rights</span><span class="w"> </span><span class="n">reserved</span><span class="p">.</span><span class="w">  </span><span class="n">See</span><span class="w"> </span><span class="n">www</span><span class="p">.</span><span class="n">dbit</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="k">DEC</span><span class="o">-</span><span class="n">related</span><span class="w"> </span><span class="n">software</span><span class="p">.</span>

<span class="n">COPY</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nf">ASCII</span><span class="p">,</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">COPY</span><span class="w"> </span><span class="nc">BINARY</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">change</span>
<span class="p">(</span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">PUTR</span><span class="p">)</span><span class="o">&gt;</span><span class="n">MOUNT</span><span class="w"> </span><span class="nl">RX</span><span class="p">:</span><span class="w"> </span><span class="n">TEST</span><span class="p">.</span><span class="n">DSK</span><span class="w"> </span><span class="o">/</span><span class="n">RX02</span><span class="w"> </span><span class="o">/</span><span class="n">RT11</span><span class="w"> </span><span class="o">/</span><span class="n">RONLY</span>
<span class="p">(</span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">PUTR</span><span class="p">)</span><span class="o">&gt;</span><span class="n">DIR</span><span class="w"> </span><span class="nl">RX</span><span class="p">:</span>

<span class="n">Volume</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">RX</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">RT11A</span>
<span class="n">Directory</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">RX</span><span class="p">:</span><span class="err">\</span><span class="o">*</span><span class="p">.</span><span class="o">*</span>

<span class="mi">11</span><span class="o">-</span><span class="n">Aug</span><span class="o">-</span><span class="mi">2021</span>
<span class="n">BSOT0D</span><span class="p">.</span><span class="n">EAE</span><span class="w">    </span><span class="mi">12</span><span class="w">  </span><span class="mi">04</span><span class="o">-</span><span class="n">Apr</span><span class="o">-</span><span class="mi">1983</span>
<span class="n">BSOT0S</span><span class="p">.</span><span class="n">EAE</span><span class="w">    </span><span class="mi">10</span><span class="w">  </span><span class="mi">04</span><span class="o">-</span><span class="n">Apr</span><span class="o">-</span><span class="mi">1983</span>
<span class="n">BSOT1D</span><span class="p">.</span><span class="n">EAE</span><span class="w">     </span><span class="mi">9</span><span class="w">  </span><span class="mi">04</span><span class="o">-</span><span class="n">Apr</span><span class="o">-</span><span class="mi">1983</span>
<span class="n">BSOT1S</span><span class="p">.</span><span class="n">EAE</span><span class="w">     </span><span class="mi">6</span><span class="w">  </span><span class="mi">04</span><span class="o">-</span><span class="n">Apr</span><span class="o">-</span><span class="mi">1983</span>
<span class="n">BSOT0D</span><span class="p">.</span><span class="n">EIS</span><span class="w">    </span><span class="mi">12</span><span class="w">  </span><span class="mi">04</span><span class="o">-</span><span class="n">Apr</span><span class="o">-</span><span class="mi">1983</span>
<span class="p">...</span>
</pre></div>


</blockquote>
<p>...etc.  Nice.  Still no luck mounting under simh, though.  Glen further offers:</p>
<blockquote>
<p>As far as I can tell by default PUTR expects to work with logical sector order RX-02 disk images that are
512,512 bytes in size. The BASIC-11 RX-02 disk image available here is in logical sector order, but is less
than 512,512 bytes in size: http://www.bitsavers.org/bits/DEC/pdp11/floppyimages/rx02/ PUTR appears to be
unhappy with the disk image unless it is padded to 512,512 bytes in size.</p>
<p>On the other hand as far as I can tell by default SIMH expects to work with physical sector order RX-02 disk
images. If I mount the logical sector order RX-02 disk image that works with PUTR in SIMH, then RT-11 gives
a "?DIR-F-Invalid directory" error. If I translate the logical sector order RX-02 disk image back into a
physical sector order disk image (dealing with track shifting, sector interleaving, and track to track
sector skewing) then RT-11 on SIMH is happy with the disk image.</p>
</blockquote>
<p>and:</p>
<blockquote>
<p>One bit of information that I found helpful as a reference when I looked at this quite a while ago was the
2.11BSD RX02 floppy disk device driver source code, which can be viewed online here:</p>
<p>https://minnie.tuhs.org/cgi-bin/utree.pl?file=2.11BSD/sys/pdpuba/rx.c</p>
<p>In particular, the routine rxfactr(), which as the comment says it calculates the physical sector and
physical track on the disk for a given logical sector.</p>
<p>I used that as a starting point to write a simple utility to read an RX-02 disk image file in logical sector
order and output an RX-02 disk image file in physical sector order.</p>
<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">*  rxfactr -- calculates the physical sector and physical</span>
<span class="cm">*  track on the disk for a given logical sector.</span>
<span class="cm">*  call:</span>
<span class="cm">*      rxfactr(logical_sector,&amp;p_sector,&amp;p_track);</span>
<span class="cm">*  the logical sector number (0 - 2001) is converted</span>
<span class="cm">*  to a physical sector number (1 - 26) and a physical</span>
<span class="cm">*  track number (0 - 76).</span>
<span class="cm">*  the logical sectors specify physical sectors that</span>
<span class="cm">*  are interleaved with a factor of 2. thus the sectors</span>
<span class="cm">*  are read in the following order for increasing</span>
<span class="cm">*  logical sector numbers (1,3, ... 23,25,2,4, ... 24,26)</span>
<span class="cm">*  There is also a 6 sector slew between tracks.</span>
<span class="cm">*  Logical sectors start at track 1, sector 1; go to</span>
<span class="cm">*  track 76 and then to track 0.  Thus, for example, unix block number</span>
<span class="cm">*  498 starts at track 0, sector 25 and runs thru track 0, sector 2</span>
<span class="cm">*  (or 6 depending on density).</span>
<span class="cm">*/</span>
<span class="k">static</span>
<span class="n">rxfactr</span><span class="p">(</span><span class="n">sectr</span><span class="p">,</span><span class="w"> </span><span class="n">psectr</span><span class="p">,</span><span class="w"> </span><span class="n">ptrck</span><span class="p">)</span>
<span class="w">   </span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sectr</span><span class="p">;</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">psectr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ptrck</span><span class="p">;</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">;</span>

<span class="w">   </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sectr</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">   </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sectr</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* 2 to 1 interleave */</span>
<span class="w">   </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">?</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* 6 sector per track slew */</span>
<span class="w">   </span><span class="o">*</span><span class="n">psectr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">77</span><span class="p">)</span>
<span class="w">       </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="o">*</span><span class="n">ptrck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


</blockquote>
<p>An RX02 image shuffled into physical sector order generated by Glen and suitable for use with simh is
attached <a href="https://fritzm.github.io/PHYS.zip">here</a>.</p>
<p>Jerry Weiss further suggested that the original, logically ordered image may work as is under simh if attached
as an MSCP device rather than RX02.  This turns out also to be the case:</p>
<blockquote>
<blockquote>
<p>On Fri, Aug 13, 2021 at 9:46 AM Jerry Weiss wrote:<br>
Could you attach logical sector (block?) image as MSCP disk in SIMH?   Other than some minor image
manipulation for removing track 0 if present, is there any reason this would not be readable?</p>
</blockquote>
<p>Hmm, it didn't occur to me to try that. Mounting the logical sector order RX-02 disk image, without any
modification necessary, as a raw MSCP disk does indeed appear to work!</p>
<div class="highlight"><pre><span></span><span class="nf">sim</span><span class="err">&gt;</span><span class="w"> </span><span class="no">ATTACH</span><span class="w"> </span><span class="no">RQ1</span><span class="w"> </span><span class="no">BASIC.DSK</span>
<span class="nl">RQ1:</span><span class="w"> </span><span class="err">&#39;</span><span class="nf">BASIC.DSK</span><span class="err">&#39;</span><span class="w"> </span><span class="no">Contains</span><span class="w"> </span><span class="no">RT11</span><span class="w"> </span><span class="no">partitions</span>
<span class="err">1</span><span class="w"> </span><span class="nf">valid</span><span class="w"> </span><span class="no">partition</span><span class="p">,</span><span class="w"> </span><span class="no">Type</span><span class="p">:</span><span class="w"> </span><span class="no">V05</span><span class="p">,</span><span class="w"> </span><span class="no">Sectors</span><span class="w"> </span><span class="no">On</span><span class="w"> </span><span class="no">Disk</span><span class="p">:</span><span class="w"> </span><span class="mi">950</span>

<span class="nf">sim</span><span class="err">&gt;</span><span class="w"> </span><span class="no">SHOW</span><span class="w"> </span><span class="no">RQ1</span>
<span class="nf">RQ1</span><span class="w">     </span><span class="mi">486</span><span class="no">KB</span><span class="p">,</span><span class="w"> </span><span class="no">attached</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="no">BASIC.DSK</span><span class="p">,</span><span class="w"> </span><span class="no">write</span><span class="w"> </span><span class="no">locked</span>
<span class="w">       </span><span class="nf">RD54</span><span class="p">,</span><span class="w"> </span><span class="no">UNIT</span><span class="err">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="no">autosize</span>
<span class="w">       </span><span class="nf">RAW</span><span class="w"> </span><span class="no">format</span>

<span class="na">.DIR</span><span class="w"> </span><span class="no">DU1</span><span class="p">:</span>

<span class="nf">BSOT0D.EAE</span><span class="w">    </span><span class="mi">12</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span><span class="w">      </span><span class="no">BSOT0S.EAE</span><span class="w">    </span><span class="mi">10</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span>
<span class="nf">BSOT1D.EAE</span><span class="w">     </span><span class="mi">9</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span><span class="w">      </span><span class="no">BSOT1S.EAE</span><span class="w">     </span><span class="mi">6</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span>
<span class="nf">BSOT0D.EIS</span><span class="w">    </span><span class="mi">12</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span><span class="w">      </span><span class="no">BSOT0S.EIS</span><span class="w">     </span><span class="mi">9</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span>
<span class="nf">BSOT1D.EIS</span><span class="w">     </span><span class="mi">9</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span><span class="w">      </span><span class="no">BSOT1S.EIS</span><span class="w">     </span><span class="mi">6</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span>
<span class="nf">BSOT0S.FIS</span><span class="w">     </span><span class="mi">7</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span><span class="w">      </span><span class="no">BSOT1S.FIS</span><span class="w">     </span><span class="mi">6</span><span class="w">  </span><span class="mi">04</span><span class="p">-</span><span class="no">Apr-83</span>
<span class="na">...</span>
</pre></div>


</blockquote>
<p>...etc.  Armed with the above, I was able to get BASIC-11 into an RT11 image in the Unibone card, and running
on the new PDP-11/34.  Here's output from the <a href="https://rosettacode.org/wiki/Mandelbrot_set#DEC_BASIC-PLUS">DEC BASIC mandelbrot
program</a> at rosetta code:</p>
<p><img src='/images/pdp11/basic-mandel-output_thumbnail_tall.jpeg' title='BASIC-11 Mandelbrot program on a PDP-11/34, program output' onclick='pswipe("pdp11",103);'/>
<img src='/images/pdp11/basic-mandel-list_thumbnail_tall.jpeg' title='BASIC-11 Mandelbrot program on a PDP-11/34, program listing' onclick='pswipe("pdp11",104);'/></p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/unibone.html"><h1>Unibone</h1></a>
Wed 24 March 2021

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>I have been keeping an eye on Jörg Hoppe's interesting <a href="http://retrocmp.com/projects/unibone">Unibone project</a>
for some time -- it is a general-purpose Unibus device emulator and diagnostic tool, built around a
<a href="https://beagleboard.org/black">BeagleBone Black</a> compute module running embedded real-time Linux. The
PDP-11/34 restoration project finally provided enough impetus for me to pull the trigger on getting one.</p>
<p>Sent Jörg an email to order a kit, which arrived some weeks later complete with bundled BeagleBone. The kit is
pretty well thought-out and was enjoyable to put together.  Had to throw in a few of my own pin headers and
jumpers to complete the assembly.  The only other small confusions were a few of the resistor packs which did
not match the schematic (Jörg informed me these are non-critical values.)</p>
<p>The kit did not include card handles.  I decided to try having some 3D printed by Shapeways, using their
"processed versatile plastic" process, which is a laser sintered nylon, color dyed and smoothed.  I used a
card handle model by Vince Slyngstad found <a href="https://so-much-stuff.com/pdp8/cad/3d.php">here</a>.  The results
were nice, sturdy, and dimensionally correct. The chosen "purple" color is a rather intense magenta in real
life.  Not exactly cheap for just a couple parts, but I had been wanting to try their print service.</p>
<p><img src='/images/pdp11/unibone-kit_thumbnail_tall.jpeg' title='Unibone: unassembled kit' onclick='pswipe("pdp11",100);'/>
<img src='/images/pdp11/unibone-handles_thumbnail_tall.jpeg' title='Unibone: 3d printed handles' onclick='pswipe("pdp11",101);'/>
<img src='/images/pdp11/unibone-assembled_thumbnail_tall.jpeg' title='Unibone assembled' onclick='pswipe("pdp11",102);'/></p>
<p>The Unibone has all sorts of capabilities, and proved itself <em>very</em> useful during the '11/34 restoration:</p>
<ul>
<li>
<p>Ability to bus master to probe the Unibus address space and run diagnostics on memory found there.  This was
  very useful for debugging the memory card that came with the -11/34 and sussing out its undocumented
  configuration switch settings.</p>
</li>
<li>
<p>Ability to directly load and execute MAINDEC diagnostics, without needing a functioning console emulator or
  storage subsystem.  This is a convenient and speedier alternative to PDP11GUI.</p>
</li>
<li>
<p>Subsequently, the ability to emulate entire storage subsystems, very useful for loading and running full
  operating systems on this -11/34 which otherwise has no storage of its own.</p>
</li>
</ul>
<p>The Unibone goes in a quad SPC slot; I opted for slot 9 on the -11/34, and this entailed removing the NPG
jumper on the backplane there to allow the Unibone to bus master.  The device worked well straight-away after
assembly.</p>
<p>There are, alas, a couple small frustrations with the current design:</p>
<ul>
<li>
<p>It is desireable to configure the Unibone and backplane to allow the Unibone to bus master and interrupt.
  However, this leaves grant chain(s) open at boot until the Unibone's own embedded software can boot and take
  control of the card (which takes on the order of a minute or so).  During this time the host system is
  non-functional or may hang, and it needs to be subsequently reset (this reset can be scripted from the
  Unibone, but all of this does significantly increase end-to-end boot time of the machine). It would be nice
  if the Unibone had something like some normally-closed relays on the grant chains, to preserve grant
  continuity until control is actively assumed.</p>
</li>
<li>
<p>It would be desireable to be able to power the embedded BeagleBone in isolation, in place in a
  system, without having to having to have the entire host system powered at the same time (e.g. for
  maintenance of the Unibone's embedded software stack, maintenance of locally stored storage system media
  images, etc.)  There is a relay on the Unibone which switches in Unibus power when available, but
  unfortunately, the design is such that if the BeagleBone is also externally powered the relay remains
  engaged when the host system is shut down.  This could lead to the BeagleBone trying to power then entire
  Unibus via its 5V supply/connector, which could obviously be problematic...  For now it seems best just to
  pull the card in order to run it in isolation, which is a little less than convenient.</p>
</li>
</ul>
<p>That said, the designs and software are open source, and the card comes with some generous prototyping areas
built right in, so some mods to address these issues could be a fun project.  All in all, Jörg has put
together a fantasically useful bit of kit, and I'm certainly glad to have it in my toolbox!</p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/1134.html"><h1>PDP-11/34</h1></a>
Tue 09 March 2021

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>This spring I worked on repair/restoration of a friend's PDP-11/34.  The system was in fairly good shape, but
missing a few bits and pieces and with the usual sorts of issues for 45-year-old kit. Started per usual with
disassembly, cleaning, and inspection.  The BA11-K chassis was in pretty decent shape; just a few scratches
requiring some sanding and a little touch-up paint to inhibit future corrosion.</p>
<p>Date codes on the chassis and CPU cards are from 1976, but other components in the chassis are a bit of
mix-and-match (a KY11-LB console interface and a third-party Monolithic systems memory board date from 1981,
and a DL11-W SLU/RTC card is from 1977). Serial number is 2001. There is also a sticker for "OHIO NUCLEAR",
which was an <a href="https://en.wikipedia.org/wiki/Technicare">early manufacturer of CT devices</a>.</p>
<p><img src='/images/pdp11/1134-serial_thumbnail_tall.jpeg' title='PDP-11/34: serial number tag' onclick='pswipe("pdp11",88);'/>
<img src='/images/pdp11/1134-chassis-sticker_thumbnail_tall.jpeg' title='PDP-11/34: BA11-K chassis sticker dating the system to 1976' onclick='pswipe("pdp11",89);'/>
<img src='/images/pdp11/1134-ohio-nuclear_thumbnail_tall.jpg' title='PDP-11/34: partial sticker for 'Ohio Nuclear' -- manufacturers of CT systems' onclick='pswipe("pdp11",90);'/></p>
<p>Foam problems here were limited to a decayed air pre-filter at the front of the chassis and some padding on
the cable retaining bar at the rear.  A heat gun and a paint scraper are your friend for removing the leftover
cellophane adhesive strips that were used to secure the foam.  For the replacement pre-filter, I opted for 3M
Filtrete carbon pre-filter sheet (part FAPF-UCTF2PAMZ) which comes in sheets large enough to cover the front
of the chassis and is easily cut to size with scissors.</p>
<p>The front panel brackets ended up being a bit of a puzzle to reassemble -- I unfortunately failed to pay close
attention to how exactly the lower fasteners were configured during disassembly.  Most of the wisdom out in
the restoration community seems to pertain to a newer, and much more convenient, version of these brackets (or
the ones that arrived on this system were mismatched?)  Here's a picture of the brackets that I have, and a
shot of the arrangement I finally opted for for the flange-blinded mounting hole at the bottom of the chassis:
machine screws driven from the back of the bracket with Keps nuts toward the front.  I also added some 1/8"
nylon spacers so the pre-filter could be extended across the entire front of the chassis, behind the brackets,
and everything still remains square when tightened up. A serviceable replacement power knob was tracked down
<a href="https://www.millsupply.com/knob-fan-speed-grumman-olson-53777.php?p=324629">here</a>.</p>
<p><img src='/images/pdp11/1134-brackets-2_thumbnail_tall.jpg' title='PDP-11/34: BA11-K front panel mounting bracket' onclick='pswipe("pdp11",91);'/>
<img src='/images/pdp11/1134-brackets-3_thumbnail_tall.jpeg' title='PDP-11/34: BA11-K front panel mounting detail, with nylon spacers to make room for pre-filter' onclick='pswipe("pdp11",92);'/>
<img src='/images/pdp11/1134-brackets-4_thumbnail_tall.jpeg' title='PDP-11/34: Front panel mounted with replacement air pre-filter in place behind brackets and replacement power knob' onclick='pswipe("pdp11",93);'/></p>
<p>The BA11-K chassis has an integrated H765 power supply.  The power-controller unit was in pretty good shape,
but I replaced the line cord since the old one had some fairly serious nicks in its outer jacket.  Also
replaced cap C1 (50uF) which seemed to be drifting off value.  Replaced the .1uF across-the-line caps mounted
on the power transformer with modern X2 safety caps.  The DC regulator modules (2x H744 +5V and 1x H745 -15V)
were disassembled and cleaned.  Reformed all the large electrolytics, then load tested the reassembled
regulators individually.  Nothing out of sorts here except the usual replacement of burnt out incandescent
indicator bulbs.</p>
<p><img src='/images/pdp11/H765-power-controller_thumbnail_tall.jpeg' title='PDP-11/34: H765 power controller module cleaned with new line cord' onclick='pswipe("pdp11",94);'/>
<img src='/images/pdp11/H765-transformer_thumbnail_tall.jpeg' title='PDP-11/34: H765 power supply main transformer, with modern X2 safety caps (orange) installed' onclick='pswipe("pdp11",95);'/>
<img src='/images/pdp11/H744-load-test_thumbnail_tall.png' title='PDP-11/34: Load testing an H744 DC regulator module; 'scope displays switching waveform' onclick='pswipe("pdp11",96);'/></p>
<p>I filled out the system with a near-side M9301 bootstrap-terminator (recent eBay purchase), some G727 "knuckle
buster" grant continuity cards, and an M9302 SACK turnaround far-side terminator.  New on this restoration was
a <a href="http://retrocmp.com/projects/unibone">UniBone Linux-to-Unibus bridge</a>, used to emulate storage devices
among other things (more on this in a separate article soon).  Checked/adjusted NPR continuity on the
backplane (continuity wire wraps in place for all slots except slot 9, to accommodate the UniBone).  Module
utilization as follows:</p>
<style>
.module-utilization {
  font-size: smaller;
  width: 50em;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1rem;
  margin-bottom: 2rem;
  border-collapse: true; 
}
.module-utilization th {
  padding: .5em;
  font-weight: normal;
}
.module-utilization tr:first-child th {
  width: 16.67%;
}
.module-utilization td {
  border: 1px solid black;
  padding: .5em;
  text-align: center;
}
.module-utilization td:empty {
  background-color: LightGray;
}
.module-utilization tr:first-child td:first-child {
  border: none;
  visibility: hidden;
}
</style>

<table class="module-utilization">
  <tr><td></td><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th></tr>
  <tr><th>1</td><td colspan=6>M7266 CPU control</td></tr>
  <tr><th>2</td><td colspan=6>M7265 CPU data path</td></tr>
  <tr><th>3</td><td colspan=2>M9301 boot term</td><td colspan=4>M7859 console</td></tr>
  <tr><th>4</td><td colspan=6>Monolithic Systems 303-0158 64 KiB memory</td></tr>
  <tr><th>5</td><td colspan=2></td><td colspan=4>M7856 serial / line clock</td></tr>
  <tr><th>6</td><td colspan=3></td><td colspan=1>G727</td><td colspan=2></td></tr>
  <tr><th>7</td><td colspan=3></td><td colspan=1>G727</td><td colspan=2></td></tr>
  <tr><th>8</td><td colspan=3></td><td colspan=1>G727</td><td colspan=2></td></tr>
  <tr><th>9</td><td colspan=2>M9302 SACK term</td><td colspan=4>UniBone</td></tr>
</table>

<p>Connected up a VT100 to the serial card, and fired things up.  Good signs of life from the front panel, but
the machine immediately halted without producing a boot monitor prompt.  Was able to reset the machine from
the front panel, though, and then examine and deposit various memory locations from there.</p>
<p>Boot ROM memory locations were readable, and the contents looked correct.  RAM addresses were generally
readable and writable, but bit 10 appeared incorrect (sometimes always set; sometimes always clear).  I was
also able to successfully write to the console XBUF register from the front panel and see characters appear on
the VT100.</p>
<p>A bus init from the front panel followed by manually punching in the boot ROM entry point produced a
functional ROM monitor on the VT100.  Deposits and examines to RAM done from the boot monitor produced results
identical to those seen using the front panel (same bit 10 problem).</p>
<p>One of the cool features of the KY11-LB console is a maintenance mode that can run Unibus bus cycles on its
own without a CPU.  This gives a way to do limited testing of cards in isolation: just set up the M7859 on a
powered, terminated backplane segment and plug in cards to be tested one at a time.  Deposits and examines can
then be done using the buttons and display on the front panel.</p>
<p>Interestingly, when running this way with just the console and memory cards in place the bit 10 errors were no
longer apparent.  Some other card was apparently corrupting bit 10 on the bus; by checking one at a time the
problem was quickly isolated to the M9301 boot terminator card.</p>
<p>The M9301 drives the implicated bit onto the Unibus via an 8881 bus driver at position E9, as seen below.  The
signal coming in from the bottom here is ENAB DATA H, which is meant to enable these drivers only when
the M9301 detects a valid address decode.  Verified that data was being incorrectly driven on BUS D10 L at E9
pin 13, regardless of the state of pin 12, indicating a faulty driver.  Pulled this, socketed, and replaced
(with a compatible ECG 7439), and the bit 10 problem was fixed.</p>
<p><br><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/m9301-data-drivers.png" title="Part of the data drivers for the M9301 bootstrap terminator"/><br></p>
<p>There was still some problem with auto-boot to the M9301 monitor, however; the monitor prompt would now begin
to print at power up, but the machine would halt a few characters in.  The front panel bus init plus manual
jump to monitor entry point workaround was still working though, so put off further investigation of this
issue until later.</p>
<p>At this point, given the workaround, the system was working well enough to begin loading and running MAINDEC
diagnostics over the serial line with PDP11GUI.  Relevant diagnostics, from the PDP-11/34 System User's
Manual:</p>
<p><br><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/1134-diags.png" title="PDP 11/34 Diagnostics"/><br></p>
<p>DFKAA, DFKAB, and DKFAC all ran without issue.  DFKTG, DZKMA, and DZQMC all reported various errors, so 
time to look into the memory board.</p>
<p>The board is a Monolithic Systems 303-0158:</p>
<p><img src='/images/pdp11/1134-memory_thumbnail_tall.jpeg' title='PDP-11/34: Monolithic Systems memory card' onclick='pswipe("pdp11",97);'/></p>
<p>I could not find any information on the board on the internet, but much can be figured out by inspection and
testing.  First, the board is using 4116 (16Kx1) DRAMs, pretty usual for the era.  There is space for 4 banks
of 18; each bank would be 16K words (16 data bits plus two parity bits per word.)  Here we see two banks
populated, minus one of the parity chips. So we'd expect to see 32K words (64 KiB) mappable (or 28K words [56
KiB] with address translation disabled, to accommodate the 4K word [8 KiB] I/O page.)  The missing parity chip
is unlikely to cause any trouble in this application; in an '11/34, there is no memory parity support without
the optional M7850 parity board installed, and this system does not have one.</p>
<p>One of the capabilities of the Unibone is to probe the full 18-bit Unibus address space, looking for active
pages.  These tests indicated that the memory board as configured was responding to the lower 128 KiB of
addresses, even though only 64 KiB was populated.  One would suppose that the mapped address range was
configured via the DIP switches on the board.  Some experimentation with various switch settings yielded the
following:</p>
<style>
.dipswitch {
  font-size: smaller;
  width: 30em;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1rem;
  margin-bottom: 2rem;
  border-collapse: true; 
}
.dipswitch th {
  padding: .5em;
  font-weight: normal;
}
.dipswitch td {
  border: 1px solid black;
  padding: .5em;
  text-align: center;
}
</style>

<table class="dipswitch">
  <caption>SW1: Memory start addr, 000000 + values as follows</caption>
  <tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th></th></tr>
  <tr><td>0</td><td>.</td><td>.</td><td>.</td><td>.</td><td>400000</td></tr>
  <tr><td>.</td><td>0</td><td>.</td><td>.</td><td>.</td><td>200000</td></tr>
  <tr><td>.</td><td>.</td><td>0</td><td>.</td><td>.</td><td>100000</td></tr>
  <tr><td>.</td><td>.</td><td>.</td><td>0</td><td>.</td><td>040000</td></tr>
  <tr><td>.</td><td>.</td><td>.</td><td>.</td><td>0</td><td>020000</td></tr>
</table>

<table class="dipswitch">
  <caption>SW2: Memory size, 020000 + values as follows</caption>
  <tr><th>4</th><th>3</th><th>2</th><th>1</th><th></th></tr>
  <tr><td>0</td><td>.</td><td>.</td><td>.</td><td>200000</td></tr>
  <tr><td>.</td><td>0</td><td>.</td><td>.</td><td>100000</td></tr>
  <tr><td>.</td><td>.</td><td>0</td><td>.</td><td>040000</td></tr>
  <tr><td>.</td><td>.</td><td>.</td><td>0</td><td>020000</td></tr>
</table>

<p>After setting the switches appropriately for the amount of memory physically present, memory test errors went
away and the MAINDEC memory diagnostics (excepting parity tests) also ran successfully.</p>
<p>So the Last thing to fix was the problem with the boot monitor at startup.  For this, the boot ROM card went
back out on an extender so I could get at it with a logic analyzer.</p>
<p><img src='/images/pdp11/1134-M9301_thumbnail_tall.jpeg' title='A troublesome M9301 boot ROM card in a PDP-11/34, out on a card extender for troubleshooting.  This one was acting strangely at power-up; the problem is actually visible in this picture...' onclick='pswipe("pdp11",98);'/></p>
<p>A PDP-11 generates power down and power up traps, through location 024, based on transitions of the AC LO and
DC LO Unibus signals.  In handling this trap, the processor first reads the PC from location 024, then the PSW
from location 026.  Many PDP-11s had core memory or battery-backed RAM; this allowed for orderly recovery from
power failure events.</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/ACLO-DCLO.png" title="Power up/down signals"/></p>
<p>PDP-11 boot ROM cards like the M9301 or its younger cousin the M9312 use a hack to obtain control at boot.
They monitor AC LO and DC LO, and when detecting a boot condition they jam higher order address bits on the
Unibus for a the first couple bus cycles.  This causes the PC and PSW to be fetched from locations within the
address space of the boot ROM card.  Here is most of the circuitry responsible for this:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/M9301-boot-logic.png" title="M9301 boot logic"/></p>
<p>The bus drivers that jam the address bus are seen on the right.  The central player here is E21, a 9602 
one-shot. CLEAR ADDR L is supposed to arrive after the first two bus cycles (fetch of PC and PSW) and
release the bus; the one-shot is set up to timeout after about 300ms and release the bus in any case.</p>
<p>On the logic analyzer, we can see an issue here:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/M9301-bad-boot.png" title="M9301 at boot with bus release issue"/></p>
<p>MSYN delimits bus cycles mastered by the CPU.  Here we can see that CLEAR ADDR L never arrives, and so the
higher-order address bits remained jammed by the M9301 for the full duration of the one-shot timeout.  This is
okay for the first few instructions, which are executing out of the ROM anyway, but things quickly go awry...</p>
<p>Here is the circuitry responsible for CLEAR ADDR L:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/M9301-transfer-logic.png" title="M9301 bus release logic"/></p>
<p>The desired pulse is mediated by 270 uF capacitor C36 in one leg of gate E20, so this is a good thing to check
first, and... it is actually missing from the board!  (Visible in the M9301 gallery picture above.)  Replaced
this cap, and now we are in good shape:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/M9301-repaired-boot.png" title="M9301 at boot with bus release issue repaired"/></p>
<p>With this, the machine is fully repaired.  Spent a little time with it, booting and running various operating
systems from emulated storage on the Unibone card.  Frieda also approves:</p>
<p><img src='/images/pdp11/1134-frieda_thumbnail_tall.jpeg' title='Frieda approved PDP-11/34' onclick='pswipe("pdp11",99);'/></p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/dl11-bodge.html"><h1>PDP-11/45: Reversing a vintage DL11 hack</h1></a>
Fri 27 November 2020

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p>I recently had need to assess and repair several DL11 serial interfaces in my stock of spares. One of these
had had some sort of end-user hack applied; in the course of putting the board back to factory condition, I
did some analysis of the hack and its intended purpose, documented here.</p>
<p><img src='/images/pdp11/dl11-user-hack_thumbnail_tall.jpg' title='DL11 with end-user hack' onclick='pswipe("pdp11",85);'/>
<img src='/images/pdp11/dl11-hack-front_thumbnail_tall.png' title='DL11 user hack front' onclick='pswipe("pdp11",86);'/>
<img src='/images/pdp11/dl11-hack-back_thumbnail_tall.png' title='DL11 user hack back' onclick='pswipe("pdp11",87);'/></p>
<p>Easy enough to beep this out and reverse to a schematic:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/dl11-hack-schem.png" 
title="Schematic of DL11 hack"/></p>
<p>So, the hack appears to dynamically alter the CSR address and interrupt vector of the card, choosing between
two hard-wired presets, based on whether P1A/P1B are connected together or not.</p>
<p>The CSR jumpers on a stock DL11 operate with pull-ups upstream of the address decode logic, so these can be
directly driven by the hack so long as the jumpers for the bits-to-be-hacked are left open on the board.  The
vector address bits, however, must be driven by the DL11 onto to the Unibus contingent on an appropriate
global enable. On a stock DL11, drivers for <em>all</em> configurable vector bits are activated by a single global
enable, and jumpers downstream of the drivers control which of these activated bits will be admitted to bus.
So, for the vector address part of the hack to function, hack control must be asserted instead of the global
enable for each of the to-be-driven bits, and the corresponding jumpers for these bits must be left in.  And
indeed, upon inspection of the DL11 there are trace cuts that have been done (marked here with "X") to lift
the global enable and allow individual hack control of each of the affected bits:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/dl11-hack-cuts.png" 
title="Trace cuts for DL11 hack"/></p>
<p></br></p>
<p>Last, we can look at the board jumpering and the wiring of the hack to determine the specific CSR and
vector addresses at play:</p>
<style>
.bitlist { border-collapse: collapse; margin-left: auto; margin-right: auto; margin-bottom: 2ex; }
.bitlist caption { font-weight: bold; }
.bitlist .hacked { font-weight: bold; }
.bitlist tr:nth-child(even) :not(th) { background-color: #f2f2f2; }
.bitlist td:nth-child(3n+2) { border-left-color: #000000; }
.bitlist td:nth-child(3n+1) { border-right-color: #000000; }
.bitlist th, .bitlist td { padding: 5px; }
.bitlist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
.bitlist tr:first-child td { border-top-color: #000000; }
.bitlist tr:last-child td { border-bottom-color: #000000; }
</style>

<table class="bitlist">
<thead><tr>
    <th></th>
    <th>A11</th><th>A10</th><th>A9</th>
    <th>A8</th><th>A7</th><th>A6</th>
    <th>A5</th><th>A4</th><th>A3</th>
    <th>A2</th><th>A1</th><th>A0</th>
    <th></th>
</tr></thead>
<tbody><tr>
    <th>P1 Open</th>
    <td>1</td>
    <td>1</td>
    <td class="hacked">0</td>
    <td>1</td>
    <td>0</td>
    <td>1</td>
    <td class="hacked">0</td>
    <td class="hacked">0</td>
    <td class="hacked">1</td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
    <th>776510</th>
</tr><tr>
    <th>P1 Closed</th>
    <td>1</td>
    <td>1</td>
    <td class="hacked">1</td>
    <td>1</td>
    <td>0</td>
    <td>1</td>
    <td class="hacked">1</td>
    <td class="hacked">1</td>
    <td class="hacked">0</td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
    <th>777560</th>
</tr></tbody>
</table>

<table class="bitlist">
<thead><tr>
    <th></th>
    <th>V8</th><th>V7</th><th>V6</th>
    <th>V5</th><th>V4</th><th>V3</th>
    <th>V2</th><th>V1</th><th>V0</th>
    <th></th>
</tr></thead>
<tbody><tr>
    <th>P1 Open</th>
    <td>0</td>
    <td class="hacked">1</td>
    <td class="hacked">1</td>
    <td class="hacked">0</td>
    <td class="hacked">0</td>
    <td class="hacked">1</td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
    <th>310</th>
</tr><tr>
    <th>P1 Closed</th>
    <td>0</td>
    <td class="hacked">0</td>
    <td class="hacked">0</td>
    <td class="hacked">1</td>
    <td class="hacked">1</td>
    <td class="hacked">0</td>
    <td>0</td>
    <td>0</td>
    <td>0</td>
    <th>060</th>
</tr></tbody>
</table>

<p><br/></p>
<p>We see from these specific addresses that closing the contacts of P1 would dynamically re-jumper the board
from assignment as the 2nd non-console interface to assignment as the console interface.  So perhaps this was
once used (in conjunction with another similarly hacked interface?) to swap console terminals with the flip of
a single switch.</p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/fp11-again.html"><h1>PDP-11/45: Some more floating point trouble</h1></a>
Sat 21 November 2020

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p><em>[A catch-up article, documenting events of April/May 2020]</em></p>
<p>In late April, I offered to give a video demonstration of the '11/45 to some interested work colleagues. Since
I hadn't had it on in a while, I fired it up to make sure everything was still in working order. The machine
behaved well from the front panel and was able to boot both V6 Unix and RSTS V06C. Great! Typed a very simple
demo program in to RSTS (print a multiplication table) and that ran, but produced some very strange results.
Uh oh... </p>
<p>Asked RSTS to <code>PRINT PI</code>, and it spat out a value somewhere around 3.7... :-)</p>
<p>So, time to try the floating point MAINDECS...  Sure enough, failures all over the place, starting with the
very first diagnostic in the floating point suite, CFPAB0. This diagnostic covers utility operations like
LDFPS/STFPS, SETI/SETL, SETF/SETD, etc.</p>
<p>I do not have listings for the diagnostics in this suite, but it is usually simple enough to reproduce
failures with short toggle-in programs given the names and descriptions of the failing diagnostics. In this
case, the following simple code to exercise an LDFPS/STFPS sequence from the front panel switches and lights
showed that bits 10 and 11 of the floating point status/control word would come back erroneously toggled:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><span class="mf">001000</span><span class="w">  </span><span class="mf">170137</span><span class="w">  </span><span class="n">START</span><span class="p">:</span><span class="w">  </span><span class="n">LDFPS</span><span class="w">   </span><span class="err">@#</span><span class="mf">177570</span><span class="w">        </span><span class="p">;</span><span class="kr">LOAD</span><span class="w"> </span><span class="n">FPS</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">SWITCH</span><span class="w"> </span><span class="n">REGISTER</span>
<span class="w">        </span><span class="mf">177570</span>
<span class="mf">001004</span><span class="w">  </span><span class="mf">170237</span><span class="w">          </span><span class="n">STFPS</span><span class="w">   </span><span class="err">@#</span><span class="mf">177570</span><span class="w">        </span><span class="p">;</span><span class="ow">AND</span><span class="w"> </span><span class="n">STORE</span><span class="w"> </span><span class="n">BACK</span><span class="w"> </span><span class="kr">TO</span><span class="w"> </span><span class="n">DISPLAY</span><span class="w"> </span><span class="n">REGISTER</span>
<span class="w">        </span><span class="mf">177570</span>
<span class="mf">001010</span><span class="w">  </span><span class="mf">000773</span><span class="w">          </span><span class="n">BR</span><span class="w">      </span><span class="n">START</span><span class="w">           </span><span class="p">;</span><span class="n">REPEAT</span>
</pre></div></td></tr></table></div>


<p>First things first, check power to the FPU and its clock; these look fine.  Next, plug the KM11 into the
floating point slot and check the FPU microcode sequences while executing LDFPS and STFPS instructions.
These also look fine:</p>
<ul>
<li>
<p>For <code>LDFPS @#177570</code> I see <code>RDY.00</code>, <code>RDY.10</code>, <code>RDY.20</code>, <code>RDY.30</code>, <code>RDY.70</code>, <code>LD.50</code></p>
</li>
<li>
<p>For <code>STFPS @#177570</code> I see <code>RDY.00</code>, <code>RDY.10</code>, <code>RDY.20</code>, <code>RDY.30</code>, <code>RDY.80</code>, <code>STR.30</code>, <code>STR.08</code></p>
</li>
</ul>
<p>Most of the data paths of interest regarding the FPS register are on the fraction low (FRL) board, so this
goes out on extenders so the microcode can be stepped and gate-level logic inspected with a logic probe.</p>
<p>Here is the block diagram of data paths in the FPU, for reference in discussion below:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/fp11-data-paths.png" 
title="FP11-B data paths"/>
<p style="text-align: center;"><em>FP11-B data paths</em></p></p>
<p>So, one thing to note with regard to the FPS register is that it is gated through the ACMX multiplexer and
written into scratch pad register AC7[0] during microcode state <code>RDY.00</code> which is the first state in the
common prolog of every FPU instruction:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/fp11-ucode-prolog.png" 
title="FP11-B microcode prolog" width="200px"/>
<p style="text-align: center;"><em>FP11-B microcode prolog</em></p></p>
<p>Stopping in state <code>RDY.00</code> and examining the ACMX inputs, selects, and outputs for bits 10 and 11 immediately
reveals a problem.  These bits of ACMX are implemented by a 74153 dual 4-input mux, E71 on sheet FRLB of the
FP11-B engineering drawings:</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/fp11-acmx-e71.png" 
title="FP11-B ACMX &gt;11:10&lt;" width="400px"/>
<p style="text-align: center;"><em>FP11-B ACMX &lt;11:10&gt;</em></p></p>
<p>Inputs from the FPS register on pins 6 and 10 appear correct, as do the selector signals on pins 14 and 2.
But outputs on pins 7 and 9 appear to be inverted.  So E71 appears bad.  Pulled this, socketed, and replaced.
After this fix, LDFPS/STFPS function correctly in the toggle-in test program, and MAINDEC CFPAB0 passes.</p>
<p>Not out of the woods yet, though...  Progressing down the sequence of MAINDECS, diagnostic CFPDC0
(add/subtract) now fails :-(  For this, we bring back the simple "add two floats" diagnostic used during
previous FP11 debug:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><span class="w">        </span><span class="nt">000000</span><span class="w">                          </span><span class="nt">AC0</span><span class="o">=%</span><span class="nt">0</span>
<span class="w">        </span><span class="nt">000001</span><span class="w">                          </span><span class="nt">AC1</span><span class="o">=%</span><span class="nt">1</span>
<span class="nt">000000</span><span class="w">                                  </span><span class="p">.</span><span class="nc">ASECT</span>
<span class="w">        </span><span class="nt">001000</span><span class="w">                          </span><span class="o">.=</span><span class="nt">1000</span>
<span class="nt">001000</span><span class="w">  </span><span class="nt">170011</span><span class="w">                  </span><span class="nt">START</span><span class="o">:</span><span class="w">  </span><span class="nt">SETD</span><span class="w">                </span><span class="o">;</span><span class="nt">SET</span><span class="w"> </span><span class="nt">DOUBLE</span><span class="w"> </span><span class="nt">PRECISION</span><span class="w"> </span><span class="nt">MODE</span>
<span class="nt">001002</span><span class="w">  </span><span class="nt">172467</span><span class="w">  </span><span class="nt">000014</span><span class="w">                  </span><span class="nt">LDD</span><span class="w">     </span><span class="nt">D1</span><span class="o">,</span><span class="nt">AC0</span><span class="w">      </span><span class="o">;</span><span class="nt">FETCH</span><span class="w"> </span><span class="nt">FIRST</span><span class="w"> </span><span class="nt">ADDEND</span><span class="w"> </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">D1</span>
<span class="nt">001006</span><span class="w">  </span><span class="nt">172567</span><span class="w">  </span><span class="nt">000020</span><span class="w">                  </span><span class="nt">LDD</span><span class="w">     </span><span class="nt">D2</span><span class="o">,</span><span class="nt">AC1</span><span class="w">      </span><span class="o">;</span><span class="nt">FETCH</span><span class="w"> </span><span class="nt">SECOND</span><span class="w"> </span><span class="nt">ADDEND</span><span class="w"> </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">D2</span>
<span class="nt">001012</span><span class="w">  </span><span class="nt">172100</span><span class="w">                          </span><span class="nt">ADDD</span><span class="w">    </span><span class="nt">AC0</span><span class="o">,</span><span class="nt">AC1</span><span class="w">     </span><span class="o">;</span><span class="nt">ADD</span><span class="w"> </span><span class="nt">THEM</span><span class="w"> </span><span class="o">(</span><span class="nt">RESULT</span><span class="w"> </span><span class="nt">IN</span><span class="w"> </span><span class="nt">AC1</span><span class="o">)</span>
<span class="nt">001014</span><span class="w">  </span><span class="nt">174167</span><span class="w">  </span><span class="nt">000022</span><span class="w">                  </span><span class="nt">STD</span><span class="w">     </span><span class="nt">AC1</span><span class="o">,</span><span class="nt">D3</span><span class="w">      </span><span class="o">;</span><span class="nt">STORE</span><span class="w"> </span><span class="nt">RESULT</span><span class="w"> </span><span class="nt">TO</span><span class="w"> </span><span class="nt">D3</span>
<span class="nt">001020</span><span class="w">  </span><span class="nt">000000</span><span class="w">                          </span><span class="nt">HALT</span>
<span class="nt">001022</span><span class="w">  </span><span class="nt">040200</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">D1</span><span class="o">:</span><span class="w">     </span><span class="p">.</span><span class="nc">WORD</span><span class="w">   </span><span class="nt">040000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="w"> </span><span class="o">;</span><span class="nt">0</span><span class="p">.</span><span class="nc">5</span>
<span class="nt">001030</span><span class="w">  </span><span class="nt">000000</span>
<span class="nt">001032</span><span class="w">  </span><span class="nt">040200</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">D2</span><span class="o">:</span><span class="w">     </span><span class="p">.</span><span class="nc">WORD</span><span class="w">   </span><span class="nt">040000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="w"> </span><span class="o">;</span><span class="nt">0</span><span class="p">.</span><span class="nc">5</span>
<span class="nt">001040</span><span class="w">  </span><span class="nt">000000</span>
<span class="nt">001042</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">000000</span><span class="w">  </span><span class="nt">D3</span><span class="o">:</span><span class="w">     </span><span class="p">.</span><span class="nc">WORD</span><span class="w">   </span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span>
<span class="nt">001050</span><span class="w">  </span><span class="nt">000000</span>
<span class="w">        </span><span class="nt">001000</span><span class="w">                          </span><span class="p">.</span><span class="nc">END</span><span class="w">    </span><span class="nt">START</span>
</pre></div></td></tr></table></div>


<p>Sure enough, this is producing incorrect results.  The microcode flows for add/subtract/compare are a bit more
involved than the simple load/store sequences above.  The sequence starts with common prolog <code>RDY.00</code>,
<code>RDY.10</code>, <code>RDY.20</code>, <code>RDY.30</code>, same as above.  The first fork after <code>RDY.30</code> goes to <code>RDY.60</code>, since
add/subtract/compare are "no memory class" instructions (FP accumulator register operands only).  The second
fork after <code>RDY.60</code> takes us to <code>ADD.00</code> on sheet FP11 FLOWS 8.</p>
<p>The left side if FLOWS 8 is a decision tree for zero operands and/or whether or not we are executing a compare
instruction.  Traversal of these states sets up fraction and exponent operands and, if necessary, a comparison
of operand exponents in the EALU.  In our case (addition of two double-precision non-zero operands), the
sequence is: <code>ADD.00</code>, <code>ADD.04</code>, <code>ADD.06</code>, <code>ADD.02</code>, <code>ADD.08</code>, <code>ADD.12</code>.</p>
<p>We then end up at state <code>ADD.22</code> at the top of the right side of FLOWS 8.  The previously set up exponent
difference is used to index into a 256x4 "range ROM"; output bits from this ROM inform the subsequent
microcode fork which determines which operand shift, if any, to apply before the upcoming fraction ALU
operation.</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/fp11-exp-compare.png" 
title="FP11-B Exponent Comparison Flow"/></p>
<p>Here a problem is evident.  We should fork to <code>ADD.24</code>, for equal exponents, but instead we end up add
<code>ADD.30</code>, for destination exponent less than source exponent.  Putting the FXP board out on the extender and
pausing in this state, the operands and operation codes on the EALU bit-slices appear to be correct, but
signal FRMH ALU CIN L is erroneously asserted at E34 pin 7 (sheet FXPA).  This extra carry (borrow, really,
since the operation is a subtract) into the least significant bit-slice causes the EALU output to be -1
instead of 0.</p>
<p>Moving back to the source of this signal on the FRM board, it turns out that FRM E20, a 74H40 dual quad-input
NAND, is outputting an invalid logic level at pin 8.  Pulled this, socketed, replaced, and the problem appears
to be fixed.</p>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/FRM-E20.png" 
title="FP11-B FRMH ALU CIN L"/></p>
<p>After this second repair, the full suite of FP11-B diagnostics is passing again.  And RSTS/E has a much less
fanciful interpretation of <code>PI</code>...</p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/unix-v6-trouble-2.html"><h1>PDP-11/45: V6 Unix Troubleshooting, Part II</h1></a>
Sun 25 October 2020

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p><em>[A catch-up article, documenting discoveries of Feb 2019]</em></p>
<p>In early 2019, I made a V6 Unix pack from the Ken Wellsch tape image, as mentioned in <a href="https://fritzm.github.io/unix-and-ms11.html">this blog
entry</a>.  It booted on my machine, but dumped core on the first <code>ls</code> in single-user
mode, or as soon as I did any heavy lifting in multi-user mode.</p>
<p>The following is the conclusion of a chronology of the troubleshooting campaign that took place over the next
month and a half, culminating in a hardware fix and successful operation of V6 Unix on the machine (part I is
<a href="https://fritzm.github.io/unix-v6-trouble-1.html">here</a>.)  This was largely a collaborative effort between Noel Chiappa an
myself via direct email correspondence, though some help was received from others via the cctalk mailing list
as well.</p>
<p>By this point, the nature of the <code>ls</code> problem had been fairly well characterized: part of the <code>ls</code> process
address space ended up holding an incorrect portion of its program text; subsequently, when execution jumped
to some of these unexpected bits, an out-of-bounds memory access would occur triggering a memory management
trap.  Efforts now focus on understanding how and why the bad bits got there...</p>
<h3>February 7</h3>
<p>[Here and below, block-quoted content is excerpted from email correspondence.]</p>
<p>Fritz:</p>
<blockquote>
<p>Noel, is it possible for you deduce where Unix <em>should</em> be placing these  "bad" bits (from file offset octal
4220)? Maybe a comparison of addresses where the bits should be, with addresses where the "bad" copy ends
up, could point us at some particular failure modes to check in the KT11, CPU, or RK11...</p>
</blockquote>
<p>Noel:</p>
<blockquote>
<p>Yes, it's quite simple: just add the virtual address in the code to the physical address of the bottom of
the text segment (given in UISA0). The VA is actually 04200, though: the 04220 includes 020 to hold the
a.out header at the start of the command file.</p>
<p>So, with UISA0 containing 01614, that gives us PA:161400 + 04200 = PA:165600, I think. And it wound up at
PA:171600 - off by 04000 (higher) - which is obviously an interesting number.</p>
</blockquote>
<hr>
<blockquote>
<p>Here's where it gets 'interesting'.</p>
<p>Executing a command with pure text on V6 is a very complicated process. The shells fork()s a copy of itself,
and does an exec() system call to overlay the entire memory in the new process with a copy of the command
(which sounds fairly simple, at a high level) - but the code path to do the exec() with a pure text is
incredibly hairy, in detail. In particular, for a variety of reasons, the memory of the process can get
swapped in and out several times during that. I apparently used to understand how this all worked, see this
message:</p>
<p><a href="https://minnie.tuhs.org/pipermail/tuhs/2018-February/014299.html">https://minnie.tuhs.org/pipermail/tuhs/2018-February/014299.html</a></p>
<p>but it's so complicated it's going to take a while to really comprehend it again. (The little grey cells are
aging too, sigh...)</p>
<p>The interesting point is that when V6 first copies the text in from the file holding the command (using
readi(), Lions 6221 for anyone who's masochistic enough to try and actually follow this :-), it reads it in
starting from the bottom, one disk block at a time (since in V6, files are not stored contiguously).</p>
<p>So, if it starts from the bottom, and copies the wrong thing from low in the file <em>up</em> to VA:010200, when it
later gets to VA:010200 in the file contents, that <em>should</em> over-write the stuff that got put there in the
wrong place <em>earlier</em>. Unless there's <em>another</em> problem which causes that later write to <em>also</em> go somewhere
wrong...</p>
<p>So, I'm not sure when this trashage is happening, but because of the above, my <em>guess</em> is that it's in one
of the two swap operations on the text (out, and then back in). (Although it might be interesting to look at
PA:165600 and see what's actually <em>there</em>.) Unix does swapping of pure texts in a single, multi-block
transfer (although not always as an integral number of blocks, as we found out the hard way with the QSIC
:-).</p>
<p>So my suspicions have now switched back to the RK11... One way to proceed would be to stop the system after
the pure text is first read in (say around Lions 4465), and look to see what the text looks like in main
memory at <em>that</em> point. (This will require looking at KT11 registers to see where it's holding the text
segment, first.)</p>
<p>If that all looks good, we'll have to figure out how to stop the system after the pure text is read back in
(which does not happen in exec(), it's done by the normal system operation to swap in the text and data of a
process which is ready to run).</p>
<p>We could also stop the system after the text is swapped out, and key in a short (~ a dozen words) program to
read the text back in from the swap device, and examine it - although we'd have to grub around in the system
a bit to figure out where it got written to. (It might be just easier to stop it at, say, Lions 5196 and
look at the arguments on the kernel stack.)</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<blockquote>
<p>...it might be interesting to look at PA:165600 and see what's actually <em>there</em></p>
</blockquote>
<p>A sea of zeros, as it turns out.</p>
</blockquote>
<hr>
<blockquote>
<blockquote>
<p>The most valuable thing ... would be to look at the text segment, after it's read in and before it's
swapped out. I can work out where to put a halt, if you want to try that.</p>
</blockquote>
<p>Yes, this sounds like a good plan to me!  Is this as simple as dropping a HALT at VA:0 in the text? </p>
</blockquote>
<p>Noel:</p>
<blockquote>
<p>No; actually, probably easier! :-) Probably easiest is to, just before you type 'ls', put a HALT in the OS
just after 4467 in Lions. Halt the machine momentarily, patch the kernel, and CONT. (Basically the same as
your patch to the trap vector, just a different address.) That'll be at 021320 (should contain 062706),
physical or virtual. :-)</p>
<p>When the system halts, you'll need to look at the text in memory. Two ways to find the location: look on the
kernel stack, the address should be the second thing down:</p>
<div class="highlight"><pre><span></span>mov 16(r3),-(sp)
add $20,(sp)
mov (r4),-(sp)
jsr pc,*$_swap
</pre></div>


<p>(i.e. the thing that 020 got added to). Probably easier, though, is just to look in UISA0 (which at this
point is pointing to the block of memory that's been allocated to read the text into, Lions 4459-60).</p>
<p>That number in UISA0, T, will be the click address of the text. So PA:T00 should be the start of the text
(170011 010600, etc). So then PA:(T00+010200) should be the trashed chunk of text: 110024 010400 000167
000016 010500 etc (right) or 016162 004767 000224 000414 016700 (wrong).</p>
</blockquote>
<h3>February 8</h3>
<p>Noel:</p>
<blockquote>
<p>In addition to the info I already sent about how to [set the breakpoint], if you could note down the top 3
words on the kernel stack, and the contents of the RK registers, those would be really useful; the first
will allow us to work out what <em>should</em> be in the RK registers after the swap I/O operation completes - I
don't think the RK11 will be asked to do anything after that finishes and before the system hits that halt
in xalloc().</p>
<p>To find the kernel stack.... read out KISA6, S. This value will point to the 'user' area of that process,
plus the kernel stack. The kernel SP should be something like 01417xx; subtract 140000 (the segment number),
and add what's left to S00.  Alternatively, you can probably use the rotating switch on the front panel to
just look up VA:1417xx (whatever's in R6) directly.</p>
<p>Oh, if you need some bed-time reading to put you to sleep, check out the bottom section ("exec() and
pure-text images") in:</p>
<p><a href="http://gunkies.org/wiki/Unix_V6_internals">http://gunkies.org/wiki/Unix_V6_internals</a></p>
<p>which will explain what's going on here with the swapping in and out, which is sorta complicated.</p>
</blockquote>
<h3>February 9</h3>
<p>Noel:</p>
<blockquote>
<blockquote>
<p>just halt the machine after the text is swapped in</p>
</blockquote>
<p>The code we need is at Lions 2034, where the pure text of a process is swapped in (and this should only be
traversed once; I don't think the system will need to swap in the text of the shell); just put a HALT in (in
the usual manner, just before trying 'ls') at 015406, which should contain a 062706 (again).</p>
<p>At that point, since the text size is 010400, and the location of the text in physical memory is 0161400,
the BAR <em>should</em> contain 0172000. If not, and it's 0232000 (note that the 0200000 bit will be in the CSR,
the lower XM bit) instead, Bazinga!, it's nailed (unless the system somehow snuck another RK operation in
there, but I don't see anything that could do that).</p>
</blockquote>
<p>I finally get some time back in front of the machine, after a few days in bed with a cold:</p>
<blockquote>
<blockquote>
<p>...put a HALT in the OS just after 4467 in Lions. Halt the machine momentarily, patch the kernel, and CONT.
(Basically the same as your patch to the trap vector, just a different address.) That'll be at 021320
(should contain 062706)...</p>
</blockquote>
<p>But alas, it does not.  [PA:021320] = 010246.  Furthermore, [PA:015406] = 016504.</p>
</blockquote>
<hr>
<blockquote>
<p>I just tried under SIMH, also, and got consistent results:</p>
<div class="highlight"><pre><span></span>[PA:015406] = 016504
[PA:021320] = 010246
</pre></div>


<p>...so, one would think, my rkunix and yours are different?</p>
</blockquote>
<p>Noel:</p>
<blockquote>
<p>That must be it. I thought we were both working from the V6 distribution? Oh, yours prints out that Western
Electric copyright notice, I don't think mine has that...</p>
</blockquote>
<h3>February 10</h3>
<p>The first part of the day is spent sorting out and comparing the "Wellsch" V6 distribution that I have been
using, and the "Ritchie" version that Noel has been using.  Noel comes to the conclusion that the only
differences in the kernel sources are in fact the four <code>printfs</code> for the copyright notice, but this is enough
to perturb the locations of various symbols of interest between the two kernels.  He also finds the binaries
<code>ls</code>, <code>cc</code>, <code>as</code>, <code>as2</code>, <code>ld</code> <code>c0</code>, <code>c1</code>, and <code>c2</code> all match; as do liba.a, libc.a and crt0.o.</p>
<p>Getting back on the trail of the bug:</p>
<blockquote>
<p>So the first place I'd like to try HALTing is just after the call to swap, Lions 4467; at that point, the
text should be in main memory, and also just written to disk. Should be at 021320 (old contents should be
062706).</p>
<p>Fun things to do here: look at the text in main memory (0161400 and up), see if it's correct at this point.
Also: pull the arguments off the top of the stack, and write a small program to read it back in...</p>
</blockquote>
<p>This turns out to be one last typo ("rkunix" vs. "rrkunix" on Noel's part) resulting in incorrect symbol
addresses for my kernel, but I'm hip to Noel's curveballs now so:</p>
<blockquote>
<p>Okay, using today's newly acquired 'db' skillz :-), in my rkunix, that spot is at PA:21420.  Firing up the
machine again and trying that now...</p>
</blockquote>
<p>It works; I end up stopped at the breakpoint and start extracting data:</p>
<blockquote>
<p>Hmmm:</p>
<div class="highlight"><pre><span></span><span class="n">PA</span><span class="o">:</span><span class="mi">161400</span><span class="o">:</span><span class="w"> </span><span class="mi">141644</span><span class="w"> </span><span class="mi">141660</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span>
<span class="n">PA</span><span class="o">:</span><span class="mi">161420</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span>
</pre></div>


</blockquote>
<p>Noel:</p>
<blockquote>
<p>The text is probably at a different location in PA at this point. Read out UISA0 for its base.</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">UISA0</span><span class="o">:</span><span class="w"> </span><span class="mi">001654</span>

<span class="n">PA</span><span class="o">:</span><span class="mi">165400</span><span class="o">:</span><span class="w"> </span><span class="mi">170011</span><span class="w"> </span><span class="mi">010600</span><span class="w"> </span><span class="mi">011046</span><span class="w"> </span><span class="mi">005720</span><span class="w"> </span><span class="mi">010066</span><span class="w"> </span><span class="mi">000002</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000010</span>

<span class="n">KSP</span><span class="o">:</span><span class="w"> </span><span class="mi">141656</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">PA</span><span class="o">:</span><span class="mi">165256</span>

<span class="n">PA</span><span class="o">:</span><span class="mi">165256</span><span class="o">:</span><span class="w"> </span><span class="mi">007656</span><span class="w"> </span><span class="mi">001654</span><span class="w"> </span><span class="mi">000104</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">101602</span><span class="w"> </span><span class="mi">066312</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">141726</span>
<span class="n">PA</span><span class="o">:</span><span class="mi">175600</span><span class="o">:</span><span class="w"> </span><span class="mi">110024</span><span class="w"> </span><span class="mi">010400</span><span class="w"> </span><span class="mi">000167</span><span class="w"> </span><span class="mi">000016</span><span class="w"> </span><span class="mi">010500</span><span class="w"> </span><span class="mi">010605</span><span class="w"> </span><span class="mi">101446</span><span class="w"> </span><span class="mi">010346</span>
</pre></div>


<p>So far so good -- both beginning and eventually-bogus sections of text check out at this point!</p>
</blockquote>
<p>Noel:</p>
<blockquote>
<p>Woo-Hoo!!!! YEAH!!!!</p>
<p>So that part of the text <em>is</em> right at this point.</p>
<p>Needless to say, this is <em>very</em>, very important data.</p>
<p>So chances are very strong, at this point, that it's the RK11.</p>
<p>What did you want to do next? You could start with the RK11 registers. Also, use PDP11GUI to read the copy
off the swap device, once I decipher the stack?</p>
</blockquote>
<hr>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">PA</span><span class="o">:</span><span class="mi">165256</span><span class="o">:</span><span class="w"> </span><span class="mi">007656</span><span class="w"> </span><span class="mi">001654</span><span class="w"> </span><span class="mi">000104</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">101602</span><span class="w"> </span><span class="mi">066312</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">141726</span>
</pre></div>


<p>OK, so the 01654 is the start address in PA (in clicks) for the area to swap out, and that matches UISA0.
0104 is the text length (also in clicks), and that also matches. The 0 is a flag which says it's a write
(read is 01). And the 07656 is the block number (4014.).</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<p>I should have a valid swap on the disk from before I shut down... Going to fire up PDP11GUI and grab it now
to have a look. We want blocks 4014-4022, then? (9 x 512-byte blocks = 0110 clicks if I got that right?)</p>
</blockquote>
<p>Noel:</p>
<blockquote>
<p>4014.-4023., I think...</p>
<blockquote>
<p>(9 x 512-byte blocks = 0110 clicks if I got that right?)</p>
</blockquote>
<p>I think 8-1/2 or so; text is 010400 bytes (a little less, actually, but that's what the system is using),
01000 bytes/block, = 010.4 blocks.</p>
</blockquote>
<p>Fritz:</p>
<p>Hmm, the beginning looks good, but it seems to cut off to soon:</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="mf">0000000</span><span class="w">    </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span>
<span class="o">*</span>
<span class="mf">7656000</span><span class="w">    </span><span class="mf">170011</span><span class="w">  </span><span class="mf">010600</span><span class="w">  </span><span class="mf">011046</span><span class="w">  </span><span class="mf">005720</span><span class="w">  </span><span class="mf">010066</span><span class="w">  </span><span class="mf">000002</span><span class="w">  </span><span class="mf">004767</span><span class="w">  </span><span class="mf">000010</span>
<span class="mf">7656020</span><span class="w">    </span><span class="mf">010016</span><span class="w">  </span><span class="mf">004737</span><span class="w">  </span><span class="mf">006374</span><span class="w">  </span><span class="mf">104401</span><span class="w">  </span><span class="mf">004567</span><span class="w">  </span><span class="mf">010154</span><span class="w">  </span><span class="mf">162706</span><span class="w">  </span><span class="mf">000044</span>
<span class="mf">7656040</span><span class="w">    </span><span class="mf">012716</span><span class="w">  </span><span class="mf">000001</span><span class="w">  </span><span class="mf">004737</span><span class="w">  </span><span class="mf">004652</span><span class="w">  </span><span class="mf">010067</span><span class="w">  </span><span class="mf">022314</span><span class="w">  </span><span class="mf">010516</span><span class="w">  </span><span class="mf">062716</span>
<span class="mf">7656060</span><span class="w">    </span><span class="mf">177762</span><span class="w">  </span><span class="mf">004737</span><span class="w">  </span><span class="mf">006346</span><span class="w">  </span><span class="mf">016500</span><span class="w">  </span><span class="mf">177762</span><span class="w">  </span><span class="mf">062700</span><span class="w">  </span><span class="mf">177413</span><span class="w">  </span><span class="mf">010067</span>
<span class="w">   </span><span class="err">|</span>
<span class="mf">7660320</span><span class="w">    </span><span class="mf">000137</span><span class="w">  </span><span class="mf">002346</span><span class="w">  </span><span class="mf">016516</span><span class="w">  </span><span class="mf">000004</span><span class="w">  </span><span class="mf">012746</span><span class="w">  </span><span class="mf">020452</span><span class="w">  </span><span class="mf">004737</span><span class="w">  </span><span class="mf">003562</span>
<span class="mf">7660340</span><span class="w">    </span><span class="mf">005726</span><span class="w">  </span><span class="mf">000137</span><span class="w">  </span><span class="mf">002542</span><span class="w">  </span><span class="mf">005067</span><span class="w">  </span><span class="mf">017552</span><span class="w">  </span><span class="mf">012704</span><span class="w">  </span><span class="mf">022336</span><span class="w">  </span><span class="mf">005003</span>
<span class="mf">7660360</span><span class="w">    </span><span class="mf">012716</span><span class="w">  </span><span class="mf">021050</span><span class="w">  </span><span class="mf">004737</span><span class="w">  </span><span class="mf">005042</span><span class="w">  </span><span class="mf">110024</span><span class="w">  </span><span class="mf">005203</span><span class="w">  </span><span class="mf">022703</span><span class="w">  </span><span class="mf">000020</span>
<span class="mf">7660400</span><span class="w">    </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span>
<span class="o">*</span>
<span class="mf">11410000</span>
</pre></div>


</blockquote>
<p>Noel:</p>
<blockquote>
<blockquote>
<div class="highlight"><pre><span></span><span class="mf">7656000</span><span class="w">    </span><span class="mf">170011</span><span class="w">  </span><span class="mf">010600</span><span class="w">  </span><span class="mf">011046</span><span class="w">  </span><span class="mf">005720</span><span class="w">  </span><span class="mf">010066</span><span class="w">  </span><span class="mf">000002</span><span class="w">  </span><span class="mf">004767</span><span class="w">  </span><span class="mf">000010</span>
</pre></div>


</blockquote>
<p>Yup, good start; SETD, etc.</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="mf">7660360</span><span class="w">    </span><span class="mf">012716</span><span class="w">  </span><span class="mf">021050</span><span class="w">  </span><span class="mf">004737</span><span class="w">  </span><span class="mf">005042</span><span class="w">  </span><span class="mf">110024</span><span class="w">  </span><span class="mf">005203</span><span class="w">  </span><span class="mf">022703</span><span class="w">  </span><span class="mf">000020</span>
<span class="mf">7660400</span><span class="w">    </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span><span class="w">  </span><span class="mf">000000</span>
</pre></div>


</blockquote>
<p>Hunh; not good. (Might be worth looking at that location in main memory, see if it's zeros or not.)</p>
<p>That's so odd that it's all zeros - I wonder where they came from? Maybe they were already on the disk, and
the write stopped way early? (At 01000 bytes per block, it stopped after 2-1/2 blocks; 056000s, 057000s,
stopped half-way through the 060000's.)</p>
<p>Would be useful to have the RK register contents after the swap() call returns...</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<p>Okay, the write should be from PA:165400 - PA:175777, to sectors 07656 - 07667.  Block 7667 encodes to an
RKDA value of 012363.</p>
<p>After the halt, I find:</p>
<div class="highlight"><pre><span></span><span class="n">RKDS</span><span class="o">:</span><span class="w"> </span><span class="mi">004707</span><span class="w"> </span><span class="o">(</span><span class="n">OK</span><span class="o">)</span>
<span class="n">RKER</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="o">(</span><span class="n">OK</span><span class="o">)</span>
<span class="n">RKCS</span><span class="o">:</span><span class="w"> </span><span class="mi">000322</span><span class="w"> </span><span class="o">(</span><span class="n">BOGUS</span><span class="o">!</span><span class="w"> </span><span class="n">EX</span><span class="o">.</span><span class="na">MEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">01</span><span class="o">)</span>
<span class="n">RKWC</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="o">(</span><span class="n">OK</span><span class="o">)</span>
<span class="n">RKBA</span><span class="o">:</span><span class="w"> </span><span class="mi">176000</span><span class="w"> </span><span class="o">(</span><span class="n">OK</span><span class="o">)</span>
<span class="n">RKDA</span><span class="o">:</span><span class="w"> </span><span class="mi">012363</span><span class="w"> </span><span class="o">(</span><span class="n">OK</span><span class="o">)</span>
</pre></div>


<p>So, EX.MEM are the smoking bits here!  I will review the associated designs and come up with things the
try/check.</p>
</blockquote>
<hr>
<blockquote>
<p>Okay, taking a look:</p>
<p>RKBA is implemented in the M795 module in slots AB07, as detailed on sheet RK11-C-15.  The M795 is a generic
WC/BA Unibus interfacing module.  The BA part only covers 16 bits, but generates an overflow out "D15
RKBA=ALL 1 L".</p>
<p>EX MEM 01 and EX MEM 02 are maintained on the M239 module in slot A17, as detailed on sheet RK11-C-03.  The
M239 is a 3x 4-bit counter/register module, so this also implements counting up these bits, when triggered
by "D15 RKBA = ALL 1 L".</p>
<p>Based on where we see the data on disk fall off (offset 2400) and the start PA (165400), I'm guessing we get
a false trigger on this "ALL 1" at RKBA 167777.  So that looks like a false "1" detect on RKBA bit 12.</p>
<p>So I think the thing to do is to put the M795 out on an extender, load RKBA with 167777, and have a check at
E28 pin 5, and E34 pin 8!</p>
<p>And we leave the cliffhanger there, for now, at least until tomorrow evening.  Because due to the way the
RK11-C is mounted, in order to do the above I'm going to have to spin the whole machine around (its a dual
H960), extend the RK05's so there is room to physically climb in the back, rig a work light, and get on in
there...</p>
</blockquote>
<h3>February 11</h3>
<blockquote>
<p>SUCCESS!!</p>
<p>Put the M795 out on an extender, loaded 167777 in RKBAR, and had a look around with a logic probe.  Narrowed
it down to E34 (a 7430 8-input NAND).  Pulled, socketed, replaced, and off she goes!</p>
<p>I can now successfully boot and run both V6 Unix and RSTS/E V06C from disk.</p>
<p><em>THAT</em> was a really fun and rewarding hunt :-)  First message in the thread was back on Dec 30, 2018.  Lots
of debugging and DRAM repairs, then the final long assault to this single, failed gate...</p>
<p>Thanks to all here for the help and resources, and particular shout-outs for Noel and Paul who gave
generously of their time and attention working through the densest bits, both on and off the list.</p>
<p>I predict a long happy weekend and a big power bill at the end of the month :-)</p>
</blockquote>
<p><img style="display:block; margin-left:auto; margin-right:auto" src="/images/pdp11/M795.png" 
title="M795 WC/BAModule"/>
<p style="text-align: center;"><em>M795 module and the single failed gate</em></p></p></div>
    <hr />
</div>
    

        

<div class='article'>
    <div class="content-title">
        <a href="https://fritzm.github.io/unix-v6-trouble-1.html"><h1>PDP-11/45: V6 Unix Troubleshooting</h1></a>
Sat 24 October 2020

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


 
    </div>
    
    <div><p><em>[A catch-up article, documenting discoveries of Jan/Feb 2019]</em></p>
<p>In early 2019, I made a V6 Unix pack from the Ken Wellsch tape image, as mentioned in <a href="https://fritzm.github.io/unix-and-ms11.html">this blog
entry</a>.  It booted on my machine, but dumped core on the first <code>ls</code> in single-user
mode, or as soon as I did any heavy lifting in multi-user mode.</p>
<p>The following is the first part of a chronology of the troubleshooting campaign that took place over the next
month and a half, culminating in a smoking gun hardware fix and successful operation of V6 Unix on the
machine.  This was largely a collaborative effort between Noel Chiappa an myself via direct email
correspondence, though help was received from others via the cctalk mailing list as well.</p>
<h3>January 8-9</h3>
<p>Initial experiments.  Described the <code>ls</code> crashes to Noel.  He theorizes that <code>ls</code> works in one case and
crashes in another is because it lands in a different spot in memory in each case.</p>
<p>Luckily, a subsequent <code>od</code> on the core file does not crash, and a core file is successfully extracted:</p>
<div class="highlight"><pre><span></span><span class="mf">140004</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141710</span><span class="w"> </span><span class="mf">141724</span><span class="w"> </span>
<span class="err">$</span><span class="n">DK</span>
<span class="err">@</span><span class="n">rkunix</span>
<span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1035</span>
<span class="n">RESTRICTED</span><span class="w"> </span><span class="n">RIGHTS</span>

<span class="n">Use</span><span class="p">,</span><span class="w"> </span><span class="n">duplication</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">disclosure</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="kr">to</span>
<span class="n">restrictions</span><span class="w"> </span><span class="n">stated</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="kr">Cont</span><span class="n">ract</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Western</span>
<span class="n">Electric</span><span class="w"> </span><span class="n">Company</span><span class="p">,</span><span class="w"> </span><span class="n">Inc</span><span class="mf">.</span>
<span class="err">#</span><span class="w"> </span><span class="n">LS</span>
<span class="n">MEMORY</span><span class="w"> </span><span class="n">FAULT</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">CORE</span><span class="w"> </span><span class="n">DUMPED</span>
<span class="err">#</span><span class="w"> </span><span class="n">OD</span><span class="w"> </span><span class="n">CORE</span>
<span class="mf">0000000</span><span class="w"> </span><span class="mf">141552</span><span class="w"> </span><span class="mf">141562</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000020</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000060</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">140076</span>
<span class="mf">0000100</span><span class="w"> </span><span class="mf">001700</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000104</span><span class="w"> </span><span class="mf">066112</span><span class="w"> </span><span class="mf">067543</span><span class="w"> </span><span class="mf">062562</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000120</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">060221</span><span class="w"> </span><span class="mf">000567</span><span class="w"> </span><span class="mf">067543</span><span class="w"> </span><span class="mf">062562</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000140</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">066112</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000160</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">177701</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000200</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">177701</span><span class="w"> </span><span class="mf">041402</span><span class="w"> </span><span class="mf">016006</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000220</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">066016</span><span class="w"> </span><span class="mf">041402</span><span class="w"> </span><span class="mf">016006</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000240</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">066016</span><span class="w"> </span><span class="mf">075120</span><span class="w"> </span><span class="mf">075120</span><span class="w"> </span><span class="mf">075120</span>
<span class="mf">0000260</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000300</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">010400</span><span class="w"> </span><span class="mf">001050</span><span class="w"> </span><span class="mf">002366</span>
<span class="mf">0000320</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000104</span><span class="w"> </span><span class="mf">000035</span><span class="w"> </span><span class="mf">000024</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141732</span><span class="w"> </span><span class="mf">141742</span><span class="w"> </span><span class="mf">141664</span>
<span class="mf">0000340</span><span class="w"> </span><span class="mf">141674</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000360</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000400</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000012</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000420</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141772</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000440</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0001500</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">025334</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">001236</span><span class="w"> </span><span class="mf">025334</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">002454</span><span class="w"> </span><span class="mf">003602</span>
<span class="mf">0001520</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">177716</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141542</span><span class="w"> </span><span class="mf">016070</span><span class="w"> </span><span class="mf">001176</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">003602</span>
<span class="mf">0001540</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">177716</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141562</span><span class="w"> </span><span class="mf">016070</span><span class="w"> </span><span class="mf">001176</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">030300</span>
<span class="mf">0001560</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">025334</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">077572</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">107564</span><span class="w"> </span><span class="mf">141626</span><span class="w"> </span><span class="mf">000512</span>
<span class="mf">0001600</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141604</span><span class="w"> </span><span class="mf">141616</span><span class="w"> </span><span class="mf">000300</span><span class="w"> </span><span class="mf">074616</span><span class="w"> </span><span class="mf">025334</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">000217</span>
<span class="mf">0001620</span><span class="w"> </span><span class="mf">000203</span><span class="w"> </span><span class="mf">107404</span><span class="w"> </span><span class="mf">020276</span><span class="w"> </span><span class="mf">000512</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141634</span><span class="w"> </span><span class="mf">141640</span><span class="w"> </span><span class="mf">003602</span>
<span class="mf">0001640</span><span class="w"> </span><span class="mf">000007</span><span class="w"> </span><span class="mf">000135</span><span class="w"> </span><span class="mf">107454</span><span class="w"> </span><span class="mf">141662</span><span class="w"> </span><span class="mf">014314</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">005674</span>
<span class="mf">0001660</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141712</span><span class="w"> </span><span class="mf">013640</span><span class="w"> </span><span class="mf">074616</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">001000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0001700</span><span class="w"> </span><span class="mf">001000</span><span class="w"> </span><span class="mf">074616</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141726</span><span class="w"> </span><span class="mf">023730</span><span class="w"> </span><span class="mf">066352</span>
<span class="mf">0001720</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141742</span><span class="w"> </span><span class="mf">023502</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">177760</span>
<span class="mf">0001740</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141756</span><span class="w"> </span><span class="mf">022050</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000034</span>
<span class="mf">0001760</span><span class="w"> </span><span class="mf">000444</span><span class="w"> </span><span class="mf">000031</span><span class="w"> </span><span class="mf">177760</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">030351</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">010210</span><span class="w"> </span><span class="mf">170010</span>
<span class="mf">0002000</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">177777</span><span class="w"> </span><span class="mf">177777</span><span class="w"> </span><span class="mf">023436</span><span class="w"> </span><span class="mf">023436</span><span class="w"> </span><span class="mf">020264</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000262</span>
<span class="mf">0002020</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000202</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000256</span><span class="w"> </span><span class="mf">000210</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000250</span><span class="w"> </span><span class="mf">000262</span>
<span class="mf">0002040</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000216</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000224</span>
<span class="mf">0002060</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">000234</span><span class="w"> </span><span class="mf">000242</span><span class="w"> </span><span class="mf">000003</span><span class="w"> </span><span class="mf">100000</span><span class="w"> </span><span class="mf">000144</span><span class="w"> </span><span class="mf">040000</span><span class="w"> </span><span class="mf">000142</span>
<span class="mf">0002100</span><span class="w"> </span><span class="mf">020000</span><span class="w"> </span><span class="mf">000143</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000400</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span>
<span class="mf">0002120</span><span class="w"> </span><span class="mf">000200</span><span class="w"> </span><span class="mf">000167</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000002</span><span class="w"> </span><span class="mf">004000</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">000100</span><span class="w"> </span><span class="mf">000170</span>
<span class="mf">0002140</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000167</span>
<span class="mf">0002160</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000002</span><span class="w"> </span><span class="mf">002000</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">000010</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span>
<span class="mf">0002200</span><span class="w"> </span><span class="mf">000004</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000002</span><span class="w"> </span><span class="mf">000167</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span>
<span class="mf">0002220</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">010000</span><span class="w"> </span><span class="mf">000164</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">020066</span>
<span class="mf">0002240</span><span class="w"> </span><span class="mf">020106</span><span class="w"> </span><span class="mf">020116</span><span class="w"> </span><span class="mf">020126</span><span class="w"> </span><span class="mf">020142</span><span class="w"> </span><span class="mf">020152</span><span class="w"> </span><span class="mf">020162</span><span class="w"> </span><span class="mf">020176</span><span class="w"> </span><span class="mf">020206</span>
<span class="mf">0002260</span><span class="w"> </span><span class="mf">020216</span><span class="w"> </span><span class="mf">020226</span><span class="w"> </span><span class="mf">000056</span><span class="w"> </span><span class="mf">062457</span><span class="w"> </span><span class="mf">061564</span><span class="w"> </span><span class="mf">070057</span><span class="w"> </span><span class="mf">071541</span><span class="w"> </span><span class="mf">073563</span>
<span class="mf">0002300</span><span class="w"> </span><span class="mf">000144</span><span class="w"> </span><span class="mf">062457</span><span class="w"> </span><span class="mf">061564</span><span class="w"> </span><span class="mf">063457</span><span class="w"> </span><span class="mf">067562</span><span class="w"> </span><span class="mf">070165</span><span class="w"> </span><span class="mf">005000</span><span class="w"> </span><span class="mf">071445</span>
<span class="mf">0002320</span><span class="w"> </span><span class="mf">005072</span><span class="w"> </span><span class="mf">072000</span><span class="w"> </span><span class="mf">072157</span><span class="w"> </span><span class="mf">066141</span><span class="w"> </span><span class="mf">022440</span><span class="w"> </span><span class="mf">005144</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">062065</span>
<span class="mf">0002340</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">031045</span><span class="w"> </span><span class="mf">020144</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">033055</span><span class="w"> </span><span class="mf">033056</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">026445</span>
<span class="mf">0002360</span><span class="w"> </span><span class="mf">062066</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">062063</span><span class="w"> </span><span class="mf">022454</span><span class="w"> </span><span class="mf">062063</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">071467</span><span class="w"> </span><span class="mf">020000</span>
<span class="mf">0002400</span><span class="w"> </span><span class="mf">026445</span><span class="w"> </span><span class="mf">027067</span><span class="w"> </span><span class="mf">071467</span><span class="w"> </span><span class="mf">022440</span><span class="w"> </span><span class="mf">032055</span><span class="w"> </span><span class="mf">032056</span><span class="w"> </span><span class="mf">020163</span><span class="w"> </span><span class="mf">020000</span>
<span class="mf">0002420</span><span class="w"> </span><span class="mf">026445</span><span class="w"> </span><span class="mf">031061</span><span class="w"> </span><span class="mf">030456</span><span class="w"> </span><span class="mf">071462</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">032045</span><span class="w"> </span><span class="mf">020144</span><span class="w"> </span><span class="mf">022400</span>
<span class="mf">0002440</span><span class="w"> </span><span class="mf">005163</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">030456</span><span class="w"> </span><span class="mf">071464</span><span class="w"> </span><span class="mf">000012</span><span class="w"> </span><span class="mf">071445</span><span class="w"> </span><span class="mf">072440</span><span class="w"> </span><span class="mf">071156</span>
<span class="mf">0002460</span><span class="w"> </span><span class="mf">060545</span><span class="w"> </span><span class="mf">060544</span><span class="w"> </span><span class="mf">066142</span><span class="w"> </span><span class="mf">005145</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">020163</span><span class="w"> </span><span class="mf">067556</span><span class="w"> </span><span class="mf">020164</span>
<span class="mf">0002500</span><span class="w"> </span><span class="mf">067546</span><span class="w"> </span><span class="mf">067165</span><span class="w"> </span><span class="mf">005144</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">003750</span><span class="w"> </span><span class="mf">000144</span><span class="w"> </span><span class="mf">004076</span><span class="w"> </span><span class="mf">000157</span>
<span class="mf">0002520</span><span class="w"> </span><span class="mf">004070</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">004172</span><span class="w"> </span><span class="mf">000146</span><span class="w"> </span><span class="mf">004210</span><span class="w"> </span><span class="mf">000145</span><span class="w"> </span><span class="mf">004026</span><span class="w"> </span><span class="mf">000143</span>
<span class="mf">0002540</span><span class="w"> </span><span class="mf">004044</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">003764</span><span class="w"> </span><span class="mf">000154</span><span class="w"> </span><span class="mf">004226</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0002560</span><span class="w"> </span><span class="mf">177774</span><span class="w"> </span><span class="mf">177760</span><span class="w"> </span><span class="mf">177775</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">104404</span><span class="w"> </span><span class="mf">022376</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">104405</span>
<span class="mf">0002600</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">104403</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">001000</span><span class="w"> </span><span class="mf">104405</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0002620</span><span class="w"> </span><span class="mf">104421</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">023436</span><span class="w"> </span><span class="mf">104423</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">104422</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0002640</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000034</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span>
<span class="mf">0002660</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">043120</span><span class="w"> </span><span class="mf">020712</span><span class="w"> </span><span class="mf">020716</span>
<span class="mf">0002700</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000005</span><span class="w"> </span><span class="mf">000515</span><span class="w"> </span><span class="mf">000072</span><span class="w"> </span><span class="mf">000457</span><span class="w"> </span><span class="mf">051505</span><span class="w"> </span><span class="mf">000124</span><span class="w"> </span><span class="mf">042105</span>
<span class="mf">0002720</span><span class="w"> </span><span class="mf">000124</span><span class="w"> </span><span class="mf">060504</span><span class="w"> </span><span class="mf">020171</span><span class="w"> </span><span class="mf">067515</span><span class="w"> </span><span class="mf">020156</span><span class="w"> </span><span class="mf">030060</span><span class="w"> </span><span class="mf">030040</span><span class="w"> </span><span class="mf">035060</span>
<span class="mf">0002740</span><span class="w"> </span><span class="mf">030060</span><span class="w"> </span><span class="mf">030072</span><span class="w"> </span><span class="mf">020060</span><span class="w"> </span><span class="mf">034461</span><span class="w"> </span><span class="mf">030060</span><span class="w"> </span><span class="mf">000012</span><span class="w"> </span><span class="mf">072523</span><span class="w"> </span><span class="mf">046556</span>
<span class="mf">0002760</span><span class="w"> </span><span class="mf">067157</span><span class="w"> </span><span class="mf">072524</span><span class="w"> </span><span class="mf">053545</span><span class="w"> </span><span class="mf">062145</span><span class="w"> </span><span class="mf">064124</span><span class="w"> </span><span class="mf">043165</span><span class="w"> </span><span class="mf">064562</span><span class="w"> </span><span class="mf">060523</span>
<span class="mf">0003000</span><span class="w"> </span><span class="mf">000164</span><span class="w"> </span><span class="mf">060512</span><span class="w"> </span><span class="mf">043156</span><span class="w"> </span><span class="mf">061145</span><span class="w"> </span><span class="mf">060515</span><span class="w"> </span><span class="mf">040562</span><span class="w"> </span><span class="mf">071160</span><span class="w"> </span><span class="mf">060515</span>
<span class="mf">0003020</span><span class="w"> </span><span class="mf">045171</span><span class="w"> </span><span class="mf">067165</span><span class="w"> </span><span class="mf">072512</span><span class="w"> </span><span class="mf">040554</span><span class="w"> </span><span class="mf">063565</span><span class="w"> </span><span class="mf">062523</span><span class="w"> </span><span class="mf">047560</span><span class="w"> </span><span class="mf">072143</span>
<span class="mf">0003040</span><span class="w"> </span><span class="mf">067516</span><span class="w"> </span><span class="mf">042166</span><span class="w"> </span><span class="mf">061545</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0003060</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0010060</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">177774</span><span class="w"> </span><span class="mf">177777</span><span class="w"> </span><span class="mf">071554</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0010100</span><span class="w"> </span>
<span class="err">#</span>
</pre></div>


<p>Noel prepares to analyze the core file (block quotes here and further below taken from email correspondence):</p>
<blockquote>
<p>I just checked, and the binary for the 'ls' command is what's called 'pure code'; i.e. the instructions are
in a separate (potentially shared) block of memory from the process' data (un-shared).</p>
</blockquote>
<hr>
<blockquote>
<p>On another front, that error message ("Memory error") is produced when a process gets a 'memory management
trap' (trap to 0250). This could be caused by any number of things (it's a pity we don't know the contents
of SR0 when the trap happened, that would tell us exactly what the cause was).</p>
</blockquote>
<hr>
<blockquote>
<p>[Memory management registers in the core dump] are 'prototypes', later modified for actual use by adding in
the actual address in main memory. Still trying to understand how that works - the code (in sureg() in
main.c) is kind of obscure.</p>
</blockquote>
<h3>January 10-24</h3>
<p>Further communication with Noel and the cctalk list raises some suspicion about the memory in my machine.
Though I had done spot checks and repairs on this in the past, which had been sufficient to pass most MAINDEC
diagnostics and to boot and run RT11, in fact the memory had not yet been exhaustively tested.</p>
<p>Over the course of some days, memory test codes are developed and run, and several additional failed DRAMs in
the MS11 memory system are isolated and repaired.  These efforts have previously been reported in detail in
<a href="https://fritzm.github.io/unix-and-ms11.html">this blog entry</a>.</p>
<p>After these repairs, the MAINDEC MS11 memory diagnostics and KT11-C MMU diagnostics, both of which are beastly
and exhaustive, are found to pass robustly with one caveat: memory parity tests.  A deep-dive into the design
and implementation of memory parity on the PDP-11/45 follows.  At the end it is concluded that the machine, a
very early serial no. in its line, is in fact functioning per-design. These efforts are documented in <a href="https://fritzm.github.io/parity-handling.html">this
blog entry</a>.</p>
<p>Even though the memory system looks solid after this, the V6 Unix crash behavior remains exactly the same...</p>
<h3>January 27-29</h3>
<p>With the KT11 and memory now verified, Noel takes up the core dump again:</p>
<blockquote>
<p>The problem is that Unix does not save enough info in the core dump for me to thoroughly diagnose the MM
fault; e.g. 'ls' is a 'pure text' program/command, and the code's not included in the core dump (in normal
operation, there's no need/use for it), so I don't have the code that was running at the time, just the data
and swappable per-process kernel data - which is not all the per-process data, e.g. it doesn't include the
location of the process's code and data segments in main memory.</p>
<p>Also, I'll look at the V6 code that sets up the KT11 registers to make sure I understand what it's doing.
(The dump contains the 'prototype' for those contents, but the values are modified, by adding the actual
memory location, before being stored in the KT11.)</p>
</blockquote>
<hr>
<blockquote>
<p>I did find out that the PC at the time of the segmentation fault was 010210, which I thought looked awfully
big (so I was wondering if somehow it went crazy), but in fact the text size is 010400, so it's just inside
the pure text.</p>
</blockquote>
<p>We agree to use
<a href="https://en.wikipedia.org/wiki/Lions%27_Commentary_on_UNIX_6th_Edition,_with_Source_Code"><em>Lions</em></a> as a common
reference point for detailed discussion of the loading and running of "ls" and what may be seen in the core
dump.</p>
<h3>January 30</h3>
<p>Noel:</p>
<blockquote>
<p>So, a bit more from my examination of the swappable per-process kernel data (the 'user' structure - not sure
how much of a Unix internals person you are).</p>
<p>It gives the following for the text, data and stack sizes:</p>
<div class="highlight"><pre><span></span>tsize 000104
dsize 000035
ssize 000024
</pre></div>


<p>which seems reasonable/correct, because looking at the header for 'ls' we see:</p>
<div class="highlight"><pre><span></span><span class="mf">000410</span><span class="w"> </span><span class="mf">010400</span><span class="w"> </span><span class="mf">001050</span><span class="w"> </span><span class="mf">002366</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000001</span>
</pre></div>


<p>'0410' says it's pure text, non-split; the 010400 is the text size, which matches (those sizes above are in
'clicks', i.e. the 0100 byte quantum used in the PDP-11 memory management).</p>
<p>The data size also appears to be correct:</p>
<div class="highlight"><pre><span></span><span class="mf">001050</span><span class="w"> </span><span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
<span class="mf">002366</span><span class="w"> </span><span class="p">(</span><span class="n">BSS</span><span class="p">)</span>
<span class="o">------</span>
<span class="mf">003436</span>
</pre></div>


<p>which again matches (round up and divide by 0100).</p>
<p>I have yet to dig around through the system sources and see what the initial stack allocation is, to see if
that's reasonable (of course, it may have been extended during execution).</p>
<p>And here are the 'prototype' segmentation register contents:</p>
<div class="highlight"><pre><span></span>UISA 000000 000020 000000 000000 000000 000000 000000 177701
UDSA 000000 000020 000000 000000 000000 000000 000000 177701
UISD 041402 016006 000000 000000 000000 000000 000000 066016
UDSD 041402 016006 000000 000000 000000 000000 000000 066016
</pre></div>


<p>Since it's not split, the D-space ones are clones of the I-space (which is what the code does - I don't
think it turns user D off and on, depending on what the process has: I'd have made context switching faster
by not having to set up the D-space registers for non-split processes, but I guess the extra overhead is
pretty minimal).</p>
<p>I have yet to check all the contents to make sure they look good, but the U?SA registers look OK; the '020'
is for the data, and that's kept contiguous with the 'user' area, so the '020' is to offset past that.</p>
<p>The PC at fault time of 010210 seems to point to the following code (assuming what was in main memory was
actually the same as the binary on the disk):</p>
<div class="highlight"><pre><span></span>        mov r4,r0
        jmp 10226
210:    mov r5,r0 
        mov sp,r5
</pre></div>


<p>We don't have SSR2, which points to the failing instruction, and I forget whether the saved PC on an MMU
fault points to the failing instruction, or the next one; I'm going to assume the latter.</p>
<p>But either way, this is very puzzling, because I don't see an instruction there that could have gotten an
MMU fault! The jump is to a location within the text segment (albeit at the end), and everything else it
just register-register moves!</p>
<p>And how could the fault depend on the location in main memory?!?!</p>
<p>If you want to poke around in the core dump yourself, to verify that I haven't made a mistake, see this
page:</p>
<p><a href="http://gunkies.org/wiki/Unix_V6_dump_analysis">http://gunkies.org/wiki/Unix_V6_dump_analysis</a></p>
<p>which gives useful offsets. (The ones in the user table I verified by writing a short program which did
things like 'printf("%o", &amp;0-&gt;u_uisa)', and the data at those locations looks like what should be there, so
I'm pretty sure that table is good. For the other one, core(5) (in the V6 man pages) gives the register
offsets (albeit in a different form), so you can check that I worked them out correctly.</p>
<p>Two things you could try to get rid of potential pattern sensitivities: before doing the 'ls', say 'sleep
360 &amp;' first; that running in the background <em>should</em> cause the 'ls' to be loaded and run from a different
address in main memory. The other thing you could try is 'cp /bin/ls xls' and then 'xls', to load the
command from a different disk location. (Both of these assume that you don't get another fault, of course!)</p>
</blockquote>
<hr>
<blockquote>
<p>[Initial stack size] is 20. clicks, which is what it still is (024 clicks) in the process core dump, so
the stack has <em>not</em> been extended. So any MM fault you see after starting 'ls' will <em>probably</em> be the one
that's causing the process to blow out.</p>
</blockquote>
<hr>
<blockquote>
<p>I tried to re-create that exact version of the 'ls' binary, because the one in the distro is stripped, and I
wanted one with symbols to look at. I failed, because a library routine (for dates) has changed on my
machine, see here:</p>
<p><a href="http://www.chiappa.net/~jnc/tech/V6Unix.html#Issues">http://www.chiappa.net/~jnc/tech/V6Unix.html#Issues</a></p>
<p>However, I did verify that the binary for ls.o is identical to what I can produce (using the -O flag). It's
just that library routine which is different. I don't think it's worth backing out my library; I did manage
to hand-produce a stub of the symbol table for where the error is happening in the old 'ls' binary:</p>
<div class="highlight"><pre><span></span><span class="mf">010210</span><span class="n">T</span><span class="w"> </span><span class="n">csv</span>
<span class="mf">010226</span><span class="n">T</span><span class="w"> </span><span class="n">cret</span>
<span class="mf">010244</span><span class="n">T</span><span class="w"> </span><span class="n">cerror</span>
<span class="mf">010262</span><span class="n">T</span><span class="w"> </span><span class="n">_ldiv</span>
<span class="mf">010304</span><span class="n">T</span><span class="w"> </span><span class="n">_lrem</span>
<span class="mf">010324</span><span class="n">T</span><span class="w"> </span><span class="n">_dpadd</span>
</pre></div>


<p>The fault does indeed seem to be happening at either the last instruction in the previous routine (ct_year,
in ctime.c), or the first of csv.</p>
<p>(I should explain that PDP-11 C uses two small chunks of code, CSV and CRET, to construct and take down
stack frames on procedure entry and exit. So on exit from <em>any</em> C procedure, the last instruction is always
an PC-relative jump to CRET.)</p>
<p>It looks like that's what's blowing up - but it apparently works with the command at a different location in
main memory! So it pretty much has to be a pattern sensitivity.</p>
<p>However, I think the KT11 does the bounds checking <em>before</em> it does the relocation - the bounds checking is
done on virtual, un-relocated addresses. So <em>that</em> part of it <em>should</em> be the same for both locations! So
here's my analysis:</p>
<p>Is it actually an indexed jump that's blowing up? I've been looking at the command binary, but that might
not be what's in main memory. Or the CPU might be looking somewhere else (because of a KT error). (If we
don't find the problem soon, we might want to put in that breakpoint so we can look in main memory and see
what inst is actually at the location where SSR2 says the failing inst was; that can rule out a whole bunch
of potential causes in one go - e.g. RK11 errors.)</p>
<p>If it is actually that jump that's failing - how? The PC hasn't been updated yet, so it can't be the fetch
of the next instruction that's failing. Is the fetch of the index word producing the MM fault?</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<p>It occurs to me that we don't even <em>really</em> know if the fault occurs from the same address every time, since
we have a core sample size of 1; I should duplicate the fail and extract another core file to compare.</p>
</blockquote>
<hr>
<blockquote>
<p>Another thing I thought I might try tonight: deposit a trap catcher in the memory mgmt trap location from
the front panel, just before issuing the 'ls' command.  I can then check the PSW, PC, SP, and KT11 regs
right at the time of fault.</p>
</blockquote>
<p>Experiments begin from the front panel, and continue on into the early hours, producing:</p>
<p>Core #2:</p>
<div class="highlight"><pre><span></span><span class="mf">140004</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141710</span><span class="w"> </span><span class="mf">141724</span>
<span class="err">$</span><span class="n">DK</span>
<span class="err">@</span><span class="n">rkunix</span>
<span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1035</span>
<span class="n">RESTRICTED</span><span class="w"> </span><span class="n">RIGHTS</span>

<span class="n">Use</span><span class="p">,</span><span class="w"> </span><span class="n">duplication</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">disclosure</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="kr">to</span>
<span class="n">restrictions</span><span class="w"> </span><span class="n">stated</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="kr">Cont</span><span class="n">ract</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Western</span>
<span class="n">Electric</span><span class="w"> </span><span class="n">Company</span><span class="p">,</span><span class="w"> </span><span class="n">Inc</span><span class="mf">.</span>
<span class="err">#</span><span class="w"> </span><span class="n">RM</span><span class="w"> </span><span class="n">CORE</span>
<span class="err">#</span><span class="w"> </span><span class="n">LS</span>
<span class="n">MEMORY</span><span class="w"> </span><span class="n">FAULT</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">CORE</span><span class="w"> </span><span class="n">DUMPED</span>
<span class="err">#</span><span class="w"> </span><span class="n">OD</span><span class="w"> </span><span class="n">CORE</span>
<span class="mf">0000000</span><span class="w"> </span><span class="mf">141552</span><span class="w"> </span><span class="mf">141562</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000020</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000060</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">140076</span>
<span class="mf">0000100</span><span class="w"> </span><span class="mf">001700</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000104</span><span class="w"> </span><span class="mf">066112</span><span class="w"> </span><span class="mf">067543</span><span class="w"> </span><span class="mf">062562</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000120</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">060221</span><span class="w"> </span><span class="mf">000571</span><span class="w"> </span><span class="mf">067543</span><span class="w"> </span><span class="mf">062562</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000140</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">066112</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000160</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">177701</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000200</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">177701</span><span class="w"> </span><span class="mf">041402</span><span class="w"> </span><span class="mf">016006</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000220</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">066016</span><span class="w"> </span><span class="mf">041402</span><span class="w"> </span><span class="mf">016006</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000240</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">066016</span><span class="w"> </span><span class="mf">075120</span><span class="w"> </span><span class="mf">075120</span><span class="w"> </span><span class="mf">075120</span>
<span class="mf">0000260</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000300</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">010400</span><span class="w"> </span><span class="mf">001050</span><span class="w"> </span><span class="mf">002366</span>
<span class="mf">0000320</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000104</span><span class="w"> </span><span class="mf">000035</span><span class="w"> </span><span class="mf">000024</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141732</span><span class="w"> </span><span class="mf">141742</span><span class="w"> </span><span class="mf">141664</span>
<span class="mf">0000340</span><span class="w"> </span><span class="mf">141674</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000360</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000400</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000011</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000420</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141772</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0000440</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0001500</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">003602</span>
<span class="mf">0001520</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">177716</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141542</span><span class="w"> </span><span class="mf">016070</span><span class="w"> </span><span class="mf">001176</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">003602</span>
<span class="mf">0001540</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">177716</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141562</span><span class="w"> </span><span class="mf">016070</span><span class="w"> </span><span class="mf">001176</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">030300</span>
<span class="mf">0001560</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">141576</span><span class="w"> </span><span class="mf">000005</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">001612</span><span class="w"> </span><span class="mf">074376</span><span class="w"> </span><span class="mf">044516</span>
<span class="mf">0001600</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">025334</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000443</span><span class="w"> </span><span class="mf">107144</span><span class="w"> </span><span class="mf">141646</span><span class="w"> </span><span class="mf">000512</span>
<span class="mf">0001620</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141624</span><span class="w"> </span><span class="mf">141640</span><span class="w"> </span><span class="mf">000300</span><span class="w"> </span><span class="mf">020276</span><span class="w"> </span><span class="mf">020356</span><span class="w"> </span><span class="mf">030000</span><span class="w"> </span><span class="mf">003602</span>
<span class="mf">0001640</span><span class="w"> </span><span class="mf">000007</span><span class="w"> </span><span class="mf">000135</span><span class="w"> </span><span class="mf">107454</span><span class="w"> </span><span class="mf">141662</span><span class="w"> </span><span class="mf">014314</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">004404</span>
<span class="mf">0001660</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">141712</span><span class="w"> </span><span class="mf">013640</span><span class="w"> </span><span class="mf">074616</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">001000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0001700</span><span class="w"> </span><span class="mf">001000</span><span class="w"> </span><span class="mf">074616</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">066352</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141726</span><span class="w"> </span><span class="mf">023730</span><span class="w"> </span><span class="mf">066352</span>
<span class="mf">0001720</span><span class="w"> </span><span class="mf">063260</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141742</span><span class="w"> </span><span class="mf">023502</span><span class="w"> </span><span class="mf">003602</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">177760</span>
<span class="mf">0001740</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141756</span><span class="w"> </span><span class="mf">022050</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000034</span>
<span class="mf">0001760</span><span class="w"> </span><span class="mf">000444</span><span class="w"> </span><span class="mf">000031</span><span class="w"> </span><span class="mf">177760</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">030351</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">010210</span><span class="w"> </span><span class="mf">170010</span>
<span class="mf">0002000</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">177777</span><span class="w"> </span><span class="mf">177777</span><span class="w"> </span><span class="mf">023436</span><span class="w"> </span><span class="mf">023436</span><span class="w"> </span><span class="mf">020264</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000262</span>
<span class="mf">0002020</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000202</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000256</span><span class="w"> </span><span class="mf">000210</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000250</span><span class="w"> </span><span class="mf">000262</span>
<span class="mf">0002040</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000216</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000262</span><span class="w"> </span><span class="mf">000224</span>
<span class="mf">0002060</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">000234</span><span class="w"> </span><span class="mf">000242</span><span class="w"> </span><span class="mf">000003</span><span class="w"> </span><span class="mf">100000</span><span class="w"> </span><span class="mf">000144</span><span class="w"> </span><span class="mf">040000</span><span class="w"> </span><span class="mf">000142</span>
<span class="mf">0002100</span><span class="w"> </span><span class="mf">020000</span><span class="w"> </span><span class="mf">000143</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000400</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span>
<span class="mf">0002120</span><span class="w"> </span><span class="mf">000200</span><span class="w"> </span><span class="mf">000167</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000002</span><span class="w"> </span><span class="mf">004000</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">000100</span><span class="w"> </span><span class="mf">000170</span>
<span class="mf">0002140</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000167</span>
<span class="mf">0002160</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000002</span><span class="w"> </span><span class="mf">002000</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">000010</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span>
<span class="mf">0002200</span><span class="w"> </span><span class="mf">000004</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000002</span><span class="w"> </span><span class="mf">000167</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span>
<span class="mf">0002220</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">000055</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">010000</span><span class="w"> </span><span class="mf">000164</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">020066</span>
<span class="mf">0002240</span><span class="w"> </span><span class="mf">020106</span><span class="w"> </span><span class="mf">020116</span><span class="w"> </span><span class="mf">020126</span><span class="w"> </span><span class="mf">020142</span><span class="w"> </span><span class="mf">020152</span><span class="w"> </span><span class="mf">020162</span><span class="w"> </span><span class="mf">020176</span><span class="w"> </span><span class="mf">020206</span>
<span class="mf">0002260</span><span class="w"> </span><span class="mf">020216</span><span class="w"> </span><span class="mf">020226</span><span class="w"> </span><span class="mf">000056</span><span class="w"> </span><span class="mf">062457</span><span class="w"> </span><span class="mf">061564</span><span class="w"> </span><span class="mf">070057</span><span class="w"> </span><span class="mf">071541</span><span class="w"> </span><span class="mf">073563</span>
<span class="mf">0002300</span><span class="w"> </span><span class="mf">000144</span><span class="w"> </span><span class="mf">062457</span><span class="w"> </span><span class="mf">061564</span><span class="w"> </span><span class="mf">063457</span><span class="w"> </span><span class="mf">067562</span><span class="w"> </span><span class="mf">070165</span><span class="w"> </span><span class="mf">005000</span><span class="w"> </span><span class="mf">071445</span>
<span class="mf">0002320</span><span class="w"> </span><span class="mf">005072</span><span class="w"> </span><span class="mf">072000</span><span class="w"> </span><span class="mf">072157</span><span class="w"> </span><span class="mf">066141</span><span class="w"> </span><span class="mf">022440</span><span class="w"> </span><span class="mf">005144</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">062065</span>
<span class="mf">0002340</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">031045</span><span class="w"> </span><span class="mf">020144</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">033055</span><span class="w"> </span><span class="mf">033056</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">026445</span>
<span class="mf">0002360</span><span class="w"> </span><span class="mf">062066</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">062063</span><span class="w"> </span><span class="mf">022454</span><span class="w"> </span><span class="mf">062063</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">071467</span><span class="w"> </span><span class="mf">020000</span>
<span class="mf">0002400</span><span class="w"> </span><span class="mf">026445</span><span class="w"> </span><span class="mf">027067</span><span class="w"> </span><span class="mf">071467</span><span class="w"> </span><span class="mf">022440</span><span class="w"> </span><span class="mf">032055</span><span class="w"> </span><span class="mf">032056</span><span class="w"> </span><span class="mf">020163</span><span class="w"> </span><span class="mf">020000</span>
<span class="mf">0002420</span><span class="w"> </span><span class="mf">026445</span><span class="w"> </span><span class="mf">031061</span><span class="w"> </span><span class="mf">030456</span><span class="w"> </span><span class="mf">071462</span><span class="w"> </span><span class="mf">000040</span><span class="w"> </span><span class="mf">032045</span><span class="w"> </span><span class="mf">020144</span><span class="w"> </span><span class="mf">022400</span>
<span class="mf">0002440</span><span class="w"> </span><span class="mf">005163</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">030456</span><span class="w"> </span><span class="mf">071464</span><span class="w"> </span><span class="mf">000012</span><span class="w"> </span><span class="mf">071445</span><span class="w"> </span><span class="mf">072440</span><span class="w"> </span><span class="mf">071156</span>
<span class="mf">0002460</span><span class="w"> </span><span class="mf">060545</span><span class="w"> </span><span class="mf">060544</span><span class="w"> </span><span class="mf">066142</span><span class="w"> </span><span class="mf">005145</span><span class="w"> </span><span class="mf">022400</span><span class="w"> </span><span class="mf">020163</span><span class="w"> </span><span class="mf">067556</span><span class="w"> </span><span class="mf">020164</span>
<span class="mf">0002500</span><span class="w"> </span><span class="mf">067546</span><span class="w"> </span><span class="mf">067165</span><span class="w"> </span><span class="mf">005144</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">003750</span><span class="w"> </span><span class="mf">000144</span><span class="w"> </span><span class="mf">004076</span><span class="w"> </span><span class="mf">000157</span>
<span class="mf">0002520</span><span class="w"> </span><span class="mf">004070</span><span class="w"> </span><span class="mf">000170</span><span class="w"> </span><span class="mf">004172</span><span class="w"> </span><span class="mf">000146</span><span class="w"> </span><span class="mf">004210</span><span class="w"> </span><span class="mf">000145</span><span class="w"> </span><span class="mf">004026</span><span class="w"> </span><span class="mf">000143</span>
<span class="mf">0002540</span><span class="w"> </span><span class="mf">004044</span><span class="w"> </span><span class="mf">000163</span><span class="w"> </span><span class="mf">003764</span><span class="w"> </span><span class="mf">000154</span><span class="w"> </span><span class="mf">004226</span><span class="w"> </span><span class="mf">000162</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0002560</span><span class="w"> </span><span class="mf">177774</span><span class="w"> </span><span class="mf">177760</span><span class="w"> </span><span class="mf">177775</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">104404</span><span class="w"> </span><span class="mf">022376</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">104405</span>
<span class="mf">0002600</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">104403</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">001000</span><span class="w"> </span><span class="mf">104405</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0002620</span><span class="w"> </span><span class="mf">104421</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">023436</span><span class="w"> </span><span class="mf">104423</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">104422</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0002640</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000034</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span>
<span class="mf">0002660</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">000036</span><span class="w"> </span><span class="mf">000037</span><span class="w"> </span><span class="mf">043120</span><span class="w"> </span><span class="mf">020712</span><span class="w"> </span><span class="mf">020716</span>
<span class="mf">0002700</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">000005</span><span class="w"> </span><span class="mf">000515</span><span class="w"> </span><span class="mf">000072</span><span class="w"> </span><span class="mf">000457</span><span class="w"> </span><span class="mf">051505</span><span class="w"> </span><span class="mf">000124</span><span class="w"> </span><span class="mf">042105</span>
<span class="mf">0002720</span><span class="w"> </span><span class="mf">000124</span><span class="w"> </span><span class="mf">060504</span><span class="w"> </span><span class="mf">020171</span><span class="w"> </span><span class="mf">067515</span><span class="w"> </span><span class="mf">020156</span><span class="w"> </span><span class="mf">030060</span><span class="w"> </span><span class="mf">030040</span><span class="w"> </span><span class="mf">035060</span>
<span class="mf">0002740</span><span class="w"> </span><span class="mf">030060</span><span class="w"> </span><span class="mf">030072</span><span class="w"> </span><span class="mf">020060</span><span class="w"> </span><span class="mf">034461</span><span class="w"> </span><span class="mf">030060</span><span class="w"> </span><span class="mf">000012</span><span class="w"> </span><span class="mf">072523</span><span class="w"> </span><span class="mf">046556</span>
<span class="mf">0002760</span><span class="w"> </span><span class="mf">067157</span><span class="w"> </span><span class="mf">072524</span><span class="w"> </span><span class="mf">053545</span><span class="w"> </span><span class="mf">062145</span><span class="w"> </span><span class="mf">064124</span><span class="w"> </span><span class="mf">043165</span><span class="w"> </span><span class="mf">064562</span><span class="w"> </span><span class="mf">060523</span>
<span class="mf">0003000</span><span class="w"> </span><span class="mf">000164</span><span class="w"> </span><span class="mf">060512</span><span class="w"> </span><span class="mf">043156</span><span class="w"> </span><span class="mf">061145</span><span class="w"> </span><span class="mf">060515</span><span class="w"> </span><span class="mf">040562</span><span class="w"> </span><span class="mf">071160</span><span class="w"> </span><span class="mf">060515</span>
<span class="mf">0003020</span><span class="w"> </span><span class="mf">045171</span><span class="w"> </span><span class="mf">067165</span><span class="w"> </span><span class="mf">072512</span><span class="w"> </span><span class="mf">040554</span><span class="w"> </span><span class="mf">063565</span><span class="w"> </span><span class="mf">062523</span><span class="w"> </span><span class="mf">047560</span><span class="w"> </span><span class="mf">072143</span>
<span class="mf">0003040</span><span class="w"> </span><span class="mf">067516</span><span class="w"> </span><span class="mf">042166</span><span class="w"> </span><span class="mf">061545</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0003060</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0010060</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000020</span><span class="w"> </span><span class="mf">000001</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">177774</span><span class="w"> </span><span class="mf">177777</span><span class="w"> </span><span class="mf">071554</span><span class="w"> </span><span class="mf">000000</span>
<span class="mf">0010100</span>
<span class="err">#</span>
</pre></div>


<p>and also:</p>
<blockquote>
<p>'db' works<br>
'cp' works<br>
'rm' works  </p>
<p>'sleep 360 &amp;' followed by 'ls' works, and then when the 'sleep' ends no longer works!  So confirmation about
memory location dependence.</p>
<p>'cp /bin/ls xls' followed by 'xls' does not work (dumps core); works with 'sleep' as with 'ls' above.</p>
</blockquote>
<hr>
<blockquote>
<p>Okay, last experiment, booting up, then depositing trap catcher from the front panel into vector 250:</p>
<div class="highlight"><pre><span></span><span class="mi">000250</span><span class="o">:</span><span class="w"> </span><span class="mi">000252</span>
<span class="mi">000252</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span>
</pre></div>


<p>...then issuing the 'ls' seems to catch it.  I can then examine registers and memory etc. from the front
panel.  This is a quick and easy repro.  I went ahead and dumped a few of the KT11 registers (but its late,
so I can't guarantee I didn't slip up -- should try this again when I'm fresh):</p>
<div class="highlight"><pre><span></span><span class="n">SR0</span><span class="o">:</span><span class="w"> </span><span class="mi">040143</span><span class="w"> </span><span class="o">(</span><span class="n">ah</span><span class="o">!</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">fault</span><span class="o">,</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">I</span><span class="o">-</span><span class="n">space</span><span class="o">,</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="n">SR1</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="o">(</span><span class="n">no</span><span class="w"> </span><span class="n">auto</span><span class="w"> </span><span class="n">inc</span><span class="o">/</span><span class="n">dec</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="n">up</span><span class="o">)</span>
<span class="n">SR2</span><span class="o">:</span><span class="w"> </span><span class="mi">010210</span><span class="w"> </span><span class="o">(</span><span class="n">virtual</span><span class="w"> </span><span class="n">PC</span><span class="o">,</span><span class="w"> </span><span class="n">agrees</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">deduction</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">dump</span><span class="o">)</span>
<span class="n">SR3</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="o">(</span><span class="n">that</span><span class="s1">&#39;s odd -- shouldn&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">D</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">enabled</span><span class="o">?)</span>

<span class="n">UIPDR</span><span class="o">:</span><span class="w"> </span><span class="mi">041402</span><span class="w"> </span><span class="mi">016006</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">066116</span>
<span class="n">UIPAR</span><span class="o">:</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001760</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span>

<span class="n">UDPDR</span><span class="o">:</span><span class="w"> </span><span class="mi">010501</span><span class="w"> </span><span class="mi">057517</span><span class="w"> </span><span class="mi">077717</span><span class="w"> </span><span class="mi">077717</span><span class="w"> </span><span class="mi">037611</span><span class="w"> </span><span class="mi">067616</span><span class="w"> </span><span class="mi">076300</span><span class="w"> </span><span class="mi">064317</span>
<span class="n">UDPAR</span><span class="o">:</span><span class="w"> </span><span class="mi">002417</span><span class="w"> </span><span class="mi">002564</span><span class="w"> </span><span class="mi">007777</span><span class="w"> </span><span class="mi">007766</span><span class="w"> </span><span class="mi">005635</span><span class="w"> </span><span class="mi">005656</span><span class="w"> </span><span class="mi">007777</span><span class="w">  </span><span class="n">oops</span>
</pre></div>


<p>...where "oops" means I thought I was done scribbling all these down, and turned off the machine.  Did I
mention it's late? :-)</p>
</blockquote>
<p>[Note: It <em>was</em> late, and there is an error with UIPAR7 in this transcription.  This will be the source of
some uncertainty until corrected on February 2.]</p>
<h3>January 31</h3>
<p>Noel:</p>
<blockquote>
<blockquote>
<p>'sleep 360 &amp;' followed by 'ls' works, and then when the 'sleep' ends no longer works! So confirmation about
memory location dependence.</p>
</blockquote>
<p>Yeah, that's a really important data-point. The fact that it is physical location dependent really does tend
to implicate the KT11; I think the KB11 mostly only knows/has virtual addresses? (So I probably shouldn't
bang my head trying to think of failure modes in the KB11?) If you have the source for its diag, you might
try looking through it, looking for things it doesn't try...</p>
<p>Although I suppose it could be a location-dependent issue with the RK11. I should explain how to find, and
examine the pure-text for the 'ls' command; if you halt the CPU on the trap again, look at UISA0, and that
should give you the 'click' where the text starts; at that point I'd probably examine every 256th (block
size) word and we can compare them to the original to make sure the in-core copy is OK.</p>
</blockquote>
<hr>
<blockquote>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">SR0</span><span class="o">:</span><span class="w"> </span><span class="mi">040143</span><span class="w"> </span><span class="o">(</span><span class="n">ah</span><span class="o">!</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">fault</span><span class="o">,</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">I</span><span class="o">-</span><span class="n">space</span><span class="o">,</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="n">SR2</span><span class="o">:</span><span class="w"> </span><span class="mi">010210</span><span class="w"> </span><span class="o">(</span><span class="n">virtual</span><span class="w"> </span><span class="n">PC</span><span class="o">,</span><span class="w"> </span><span class="n">agrees</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">deduction</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">dump</span>
</pre></div>


</blockquote>
<p>If it's really 010210, I wonder how it could be a fault on page 1; each page (segment, really) of virtual
address space is 020000 long, so that address is well inside page 0?</p>
<p>Unless it has fetched some other instruction, due to some other error, one which does try and do something
on page 1... Might want to try looking at a few instructions around 010210 when you try this again, see
what's actually there. Let's see, code starts at 0161400 in real memory (per UIPAR0 below), so 010210 is at
0171610... Maybe dump a few words from 171600 on?</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">SR3</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="o">(</span><span class="n">that</span><span class="s1">&#39;s odd -- shouldn&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">D</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">enabled</span><span class="o">?)</span>
</pre></div>


</blockquote>
<p>No; you're running binary for a /40 system, so no split I/D. So also, all the UDPARs and UDPDRs will contain
junk.</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">UIPAR</span><span class="o">:</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001760</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span>
</pre></div>


</blockquote>
<p>?? UIPAR7 looks wrong; if the data is really at 01760, I think the stack should be above that in real memory
- but I might be wrong, I will check.</p>
<p>If it is wrong, did something cause the wrong value to be stored there (e.g. an error in the execution of
lines 1750/1751 in Lions); or was the prototype calculated wrong (around line 1704) - but I think the
prototypes looked correct in the process' core dump, but I will check them; or did the hardware flake out,
and e.g. copy a later store (the code fills them from the top down) up to UISA7?</p>
<p>To check out the latter, maybe a bespoke tiny program, toggled in, to try storing the 'correct' data in the
UISPARs, in the exact way that the Unix code does it, and then look and see what's in there?</p>
<p>This might also correlate to the strange stuff I saw in the process' user-mode stack, in the dump - I will
go back and look at that now.</p>
<p>If you do this again, please add KISA6 and KISD6 to the registers to dump (you can skip UDS*), so we can see
what it thinks is going on with the per-process swappable data, which should be just below the process'
user-mode data, in terms of real memory.</p>
</blockquote>
<hr>
<blockquote>
<p>Yes, the stack is directly above the user data, which is directly above the swappable per-process data (user
struct, and kernel stack). But the address math for stack segments in the KT11 is weird (see below).</p>
<p>I <em>think</em> the prototypes:</p>
<div class="highlight"><pre><span></span>UISA 000000 000020 000000 000000 000000 000000 000000 177701
UISD 041402 016006 000000 000000 000000 000000 000000 066016
</pre></div>


<p>are right, but the negative direction of the stack is making my head hurt (and the UISA7 you recorded from
the hardware might be right after all - but then the UISA0 might be wrong - it's suspicious, but not
impossible, that they are the same value).</p>
<p>If the SPPD is at physical xxx, the user data will be at xxx+20 (in clicks, as above) through xxx+20+34
(below), and then the stack above that. Per the SPPD:</p>
<div class="highlight"><pre><span></span>tsize 000104
dsize 000035
ssize 000024
</pre></div>


<p>the stack should then run from xxx+20+35 to xxx+20+35+23. The way the MM hardware works for stack segment,
the 'base' is where the first click would be if the segment were a full 0200 clicks. (Per the example in the
/45 proc handbook; for a 3-click stack running from physical 0331500 to 0331776, the PAR would contain
03120, i.e. segment base at 0312000.)</p>
<p>So let me do the math (please check to see if I'm confused :-); base of user data is at 0176000 (per UISA1
contents), runs to 0201476 (i.e. plus 03500); the stack would run from 0201500 to 0204076 (i.e. plus 02400).
So the stack segment 'base' would be 020000 below the next word, or 0164100.</p>
<p>(My head hurts too much to work out if the 177701 of the prototype is right; basically, the location of the
SPPD in clicks would be 01740 (I <em>think</em> - 01760 - 020), and that plus 177701 should give us 01641.)</p>
<p>But, anyway, I'm fairly sure that 01614 is <em>not</em> right for UISA7 (unless it really was 1641 and you inverted
the digits because it looked so close).</p>
<p>Having KISA6 would help since it would give us a cross-check on the value of UISA1.....</p>
</blockquote>
<hr>
<blockquote>
<p>So, according to the process core dump, these are the register contents at the time of the fault:</p>
<div class="highlight"><pre><span></span>R0 177770
R1 0
R2 0
R3 0
R4 34
R5 444
SP 177760
PC 010210
PS 170010
</pre></div>


<p>Now, PDP-11 uses R5 for a frame pointer, set up thus:</p>
<div class="highlight"><pre><span></span>        jsr     r5,csv        (first instruction in every C routine)

csv:
        mov     r5,r0
        mov     sp,r5
        mov     r4,-(sp)
        mov     r3,-(sp)
        mov     r2,-(sp)
        tst     -(sp)
        jmp     (r0)
</pre></div>


<p>on subroutine entry (the 'jsr r5, csv' pushes the old R5 contents, and temporarily saves the return PC - to
just after the call to CSV, not to the sunroutine which called this one, that's further down - in R5). So,
except for the first two instructions of CSV, R5 <em>always</em> contains an old SP.</p>
<p>Now look at the R5 from the crash. That's not an old SP. Something has already gone seriously wrong by this
point - actually, likely the process has just started to run the newly-loaded command code (see below), and
hasn't even set up its first stack frame yet.</p>
<p>Now look at the top of the stack, as recorded in the process' core dump:</p>
<div class="highlight"><pre><span></span><span class="mi">0010060</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000020</span><span class="w"> </span><span class="mi">000001</span><span class="w"> </span><span class="mi">177770</span><span class="w"> </span><span class="mi">177774</span><span class="w"> </span><span class="mi">177777</span><span class="w"> </span><span class="mi">071554</span><span class="w"> </span><span class="mi">000000</span>
</pre></div>


<p>And that's <em>it</em>; the rest if all 0's! (The base address does seem to correspond; with:</p>
<div class="highlight"><pre><span></span>dsize 000035
ssize 000024
</pre></div>


<p>and the SPPD being 020 clicks, that puts the top of the stack at 0101 clicks, or 010100, and the last
location there is 010076.</p>
<p>The core dump routine, core() writes the user data out in two transfers (Lions 4113-4124), one for the SPPD,
one for the user's data+stack. So we probably got the SPPD OK, but the rest - who knows?</p>
<p>It does call estabur(), which sets up the prototype MM register contents, and then writes them into the
actual registers, so the prototypes in the process' core dump that I was looking at before have already been
overwritten. :-(But estabur() then called sureg (Lions 1724) so hopefully the MM regs wound up pointing to
the actual memory being used for the stack - but who knows?</p>
<p>Anyway, looking at the contents, the top of the stack does look vaguely like what it should be when the
command <em>starts</em> executing, after the exec() call; the SP is even reasonable; it points to that 0 at offset
010060.</p>
<p>The 020 is the return point for the call to _main (see below; that 'jsr pc,_main' ends at 016); the '1' is
probably 'nargs' (see Exec(II) in the V6 Manual), the '0177770' is argv, '177774' is argv[0], 177777 is
argv[1] (end of list marker), and '071554' is 'ls' (the command name, by convention the first argument).</p>
<p>R0 contains what looks like an old SP, although I suppose that could have been
left over from the assembler startup:</p>
<div class="highlight"><pre><span></span><span class="n">start</span><span class="o">:</span>
<span class="w">          </span><span class="n">setd</span>
<span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">sp</span><span class="o">,</span><span class="n">r0</span>
<span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="o">(</span><span class="n">r0</span><span class="o">),-(</span><span class="n">sp</span><span class="o">)</span>
<span class="w">          </span><span class="n">tst</span><span class="w">     </span><span class="o">(</span><span class="n">r0</span><span class="o">)+</span>
<span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">r0</span><span class="o">,</span><span class="mi">2</span><span class="o">(</span><span class="n">sp</span><span class="o">)</span>
<span class="w">          </span><span class="n">jsr</span><span class="w">     </span><span class="n">pc</span><span class="o">,</span><span class="n">_main</span>
</pre></div>


<p>but clearly the attempt to execute the first instruction in CSV blew up. And where did the '444' in R5 come
from? The call to CSV is at 030?</p>
</blockquote>
<h3>February 1</h3>
<p>Noel, regarding the second core file:</p>
<blockquote>
<p>I took a quick look, and everything 'important' seems to be identical: the registers, PC, etc at the time of
the trap (including that mysterious '444' in R5); the prototype MM registers; the user's stack (looking
again like the command just started.</p>
</blockquote>
<hr>
<blockquote>
<blockquote>
<p>I went ahead and dumped a few of the KT11 registers</p>
<div class="highlight"><pre><span></span><span class="n">UIPDR</span><span class="o">:</span><span class="w"> </span><span class="mi">041402</span><span class="w"> </span><span class="mi">016006</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">066116</span>
</pre></div>


</blockquote>
<p>Oh, BTW, I checked, and these match the prototype values in the user struct.</p>
</blockquote>
<h3>February 2-3</h3>
<p>A tip from Noel:</p>
<blockquote>
<p>Something stirred this in my memory: the best quick overview of the internals of the Bell PDP-11 Unixes is
K. Thompson, "UNIX Implementation", available here:</p>
<p><a href="https://users.soe.ucsc.edu/~sbrandt/221/Papers/History/thompson-bstj78.pdf">https://users.soe.ucsc.edu/~sbrandt/221/Papers/History/thompson-bstj78.pdf</a></p>
<p>if you want to know more about what the insides are like.</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<p>Okay, here's the latest, done with some care:</p>
<div class="highlight"><pre><span></span><span class="n">UISD</span><span class="o">:</span><span class="w"> </span><span class="mi">041402</span><span class="w"> </span><span class="mi">016006</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">066116</span>
<span class="n">UISA</span><span class="o">:</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001760</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001641</span>

<span class="n">KISD</span><span class="o">:</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">077506</span><span class="w"> </span><span class="mi">077506</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">007506</span><span class="w"> </span><span class="mi">077506</span>
<span class="n">KISA</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000200</span><span class="w"> </span><span class="mi">000400</span><span class="w"> </span><span class="mi">000600</span><span class="w"> </span><span class="mi">001000</span><span class="w"> </span><span class="mi">001200</span><span class="w"> </span><span class="mi">001740</span><span class="w"> </span><span class="mi">007600</span>

<span class="n">SRs</span><span class="o">:</span><span class="w"> </span><span class="mi">040143</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">010210</span><span class="w"> </span><span class="mi">000000</span>

<span class="mi">171600</span><span class="o">:</span><span class="w"> </span><span class="mi">016162</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000224</span><span class="w"> </span><span class="mi">000414</span><span class="w"> </span><span class="mi">006700</span><span class="w"> </span><span class="mi">006152</span><span class="w"> </span><span class="mi">006702</span><span class="w"> </span><span class="mi">006144</span>
</pre></div>


</blockquote>
<p>[Note: this fixes the previous late-night transcription error with UISA7...]</p>
<p>Noel:</p>
<blockquote>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">UISD</span><span class="o">:</span><span class="w"> </span><span class="mi">041402</span><span class="w"> </span><span class="mi">016006</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">066116</span>
<span class="n">UISA</span><span class="o">:</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001760</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001614</span><span class="w"> </span><span class="mi">001641</span>
</pre></div>


</blockquote>
<p>So, 'good news' is these are the same except for UISA7, for which as I suspected, it looks like the digits
were transposed. But the new value is exactly the one I calculated.</p>
<p>'Bad news' is that takes out what I was thinking might be a potential cause, which was UPAR's getting
trashed by hardware failure. So more hard work ahead (see below).</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">KISD</span><span class="o">:</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">077506</span><span class="w"> </span><span class="mi">077506</span><span class="w"> </span><span class="mi">077406</span><span class="w"> </span><span class="mi">007506</span><span class="w"> </span><span class="mi">077506</span>
<span class="n">KISA</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000200</span><span class="w"> </span><span class="mi">000400</span><span class="w"> </span><span class="mi">000600</span><span class="w"> </span><span class="mi">001000</span><span class="w"> </span><span class="mi">001200</span><span class="w"> </span><span class="mi">001740</span><span class="w"> </span><span class="mi">007600</span>
</pre></div>


</blockquote>
<p>Those all look OK: KISD6 show the segment length as 020 (017 being the last valid click), which is right,
and KISA6 is 01740, so with the user area and kernel stack being 20 clicks, that makes the start of the user
data 01760, which is what UISA1 contains.</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">SRs</span><span class="o">:</span><span class="w"> </span><span class="mi">040143</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">010210</span><span class="w"> </span><span class="mi">000000</span>
</pre></div>


</blockquote>
<p>OK, same failing location as before (010210); SSR0 shows:</p>
<div class="highlight"><pre><span></span>Abort - page length error
User mode
Page 1
</pre></div>


<p>which is the same as last time.</p>
<div class="highlight"><pre><span></span><span class="mi">171600</span><span class="o">:</span><span class="w"> </span><span class="mi">016162</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000224</span><span class="w"> </span><span class="mi">000414</span><span class="w"> </span><span class="mi">006700</span><span class="w"> </span><span class="mi">006152</span><span class="w"> </span><span class="mi">006702</span><span class="w"> </span><span class="mi">006144</span>
</pre></div>


<p>Let me just re-check the math here: text base is 0161400, plus a PC of 010210, gives us 0171610, which is
right in the middle there - thanks!</p>
<p>That does not, alas, look anything <em>at all</em> like what's <em>supposed</em> to be there, which is:</p>
<div class="highlight"><pre><span></span><span class="mi">010200</span><span class="o">:</span><span class="w"> </span><span class="mi">110024</span>
<span class="w">        </span><span class="mi">010400</span><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">r4</span><span class="o">,</span><span class="n">r0</span>
<span class="w">        </span><span class="mi">000167</span><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="mi">10226</span><span class="w"> </span><span class="o">(</span><span class="n">cret</span><span class="o">)</span>
<span class="w">        </span><span class="mi">000016</span>
<span class="w">        </span><span class="mi">010500</span><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">r5</span><span class="o">,</span><span class="n">r0</span><span class="w"> </span><span class="o">(</span><span class="n">start</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">CSV</span><span class="o">)</span>
<span class="w">        </span><span class="mi">010605</span><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">sp</span><span class="o">,</span><span class="n">r5</span>
<span class="w">        </span><span class="mi">010446</span><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">r4</span><span class="o">,-(</span><span class="n">sp</span><span class="o">)</span>
<span class="w">        </span><span class="mi">010346</span><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">r3</span><span class="o">,-(</span><span class="n">sp</span><span class="o">)</span>
</pre></div>


<p>So maybe the RK11 went berserk? But maybe not...</p>
<p>The 4767 is a 'jsr pc, xxx' which is typical C compiler emission, but the rest looks like rubbish - 6700 is
a SXT R0, for instance.</p>
<p>What's actually there at 010210 (virtual) still doesn't explain the MM trap we got; 'SXT R0' should have
executed OK, no matter what? Confoozled...</p>
<p>What's also odd is how it got here; it's almost like the first few instructions:</p>
<div class="highlight"><pre><span></span><span class="n">start</span><span class="o">:</span>
<span class="w">          </span><span class="n">setd</span>
<span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">sp</span><span class="o">,</span><span class="n">r0</span>
<span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="o">(</span><span class="n">r0</span><span class="o">),-(</span><span class="n">sp</span><span class="o">)</span>
<span class="w">          </span><span class="n">tst</span><span class="w">     </span><span class="o">(</span><span class="n">r0</span><span class="o">)+</span>
<span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">r0</span><span class="o">,</span><span class="mi">2</span><span class="o">(</span><span class="n">sp</span><span class="o">)</span>
<span class="w">          </span><span class="n">jsr</span><span class="w">     </span><span class="n">pc</span><span class="o">,</span><span class="n">_main</span>

<span class="n">_main</span><span class="o">:</span>
<span class="w">          </span><span class="n">jsr</span><span class="w">     </span><span class="n">r5</span><span class="o">,</span><span class="n">csv</span>
</pre></div>


<p>executed OK, and then it tried to go off to csv, only there's trash there? And what's with the 0444 in R5?
That should be 034, the return from that last JSR.</p>
<p>I'm going to go ponder all this. One more thing you could try is do this all again, and write down the first
couple of instructions at the start of the text segment (UISA0 = 01614, so 0161400 on for a few words), so
we can see if <em>that</em> looks OK.</p>
<p>If so, it will look like the command got read in off the disk wrong - since it's not coming from swap (it's
just starting), it's coming out of the file system wrong. Why will be a good question.</p>
<p>And I still don't understand the 'segment 1' fault, and the R5 contents - so many things going wrong all at
once, for reasons that make no sense... I wonder if there's a noise glitch hitting several things all at the
same time?</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<p>I read a bit through the KT11 maintenance manual you sent yesterday, to refresh myself on it a bit (thanks
for that!).  I realized I almost always use my console in "PROG PHY" or "CONS PHY" mode; but using "USER I"
and "KERNEL I" I may be able to verify quickly that the KT11 is thinking VA:010210 -&gt; PA:171610.</p>
<p>When I set this up to try later, I'll examine that start of the text segment at 161400 as well, per your
recommend.</p>
</blockquote>
<h3>February 4</h3>
<p>Noel sends up a flare on cctalk in the the early AM, summarizing the problem and experiments to date.
Suggestions start to flow in.  Some have already been tried or can be ruled out.  Some others:</p>
<ul>
<li>
<p>Bob Smith: "I keep wondering about the psu...".  This gets some agreement from the list, and a few
  interesting/relevant anecdotes are relayed.  Paul Koning:</p>
<blockquote>
<p>In RSTS development we once ran into DMC-11s not working reliably.  The field service tech knew exactly
what to look for, and started checking all the supply voltages.  The spec says allowed tolerances are
+/- 5%.  He knew the reality for correct operation was -0%, +5%, so he tweaked all the supplies to read
a hair above nominal.</p>
</blockquote>
<p>Warner Losh:</p>
<blockquote>
<p>I recall our PDP-11 tech tweaking +5V from 5.05V to 4.95V and back again to demonstrate that tiny
differences matter a lot on one of the cranky 11/23+''s we had after I made a particularly unhelpful
teenage smart ass remark... The 11/23+ wouldn't boot at the slightly lower than full voltage.</p>
</blockquote>
<p>It is worth noting that in both of these cases, a slight undervoltage proved problematic...</p>
</li>
<li>
<p>Paul Koning suggests a potential KT11 failure mode:</p>
<blockquote>
<p>Another possibility occurs to me: bad bits in the MMU (UISAR0 register if I remember correctly).  Bad
memory is likely to show up with a few bits wrong; if UISAR0 has a stuck bit so the "plain" case maps
incorrectly you'd expect to come up with execution that looks nothing at all like what was intended.</p>
</blockquote>
<p>Noel provides a short diagnostic (apparently, straight from his mind to machine code; props! :-) to check
read-after-write on UISA* so we can rule this out:</p>
<div class="highlight"><pre><span></span><span class="mi">1000</span><span class="o">:</span><span class="w">   </span><span class="mi">12706</span><span class="w">       </span><span class="o">/</span><span class="w"> </span><span class="n">Put</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">0700</span>
<span class="w">        </span><span class="mi">700</span>
<span class="w">        </span><span class="mi">12701</span><span class="w">       </span><span class="o">/</span><span class="w"> </span><span class="n">Load</span><span class="w"> </span><span class="n">UISA0</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">R1</span>
<span class="w">        </span><span class="mi">177640</span>
<span class="w">        </span><span class="mi">5000</span><span class="w">        </span><span class="o">/</span><span class="w"> </span><span class="n">Start</span><span class="w"> </span><span class="n">testing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="mi">10011</span><span class="w">       </span><span class="o">/</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">it</span>
<span class="w">        </span><span class="mi">20011</span><span class="w">       </span><span class="o">/</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">it</span>
<span class="w">        </span><span class="mi">1401</span><span class="w">        </span><span class="o">/</span><span class="w"> </span><span class="n">Skip</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">match</span>
<span class="w">        </span><span class="mi">0</span><span class="w">           </span><span class="o">/</span><span class="w"> </span><span class="n">Halt</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">error</span>
<span class="w">        </span><span class="mi">5200</span><span class="w">        </span><span class="o">/</span><span class="w"> </span><span class="n">Next</span><span class="w"> </span><span class="n">value</span>
<span class="w">        </span><span class="mi">20027</span><span class="w">       </span><span class="o">/</span><span class="w"> </span><span class="mi">07777</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">less</span><span class="o">?</span>
<span class="w">        </span><span class="mi">7777</span>
<span class="w">        </span><span class="mi">101770</span><span class="w">      </span><span class="o">/</span><span class="w"> </span><span class="n">Go</span><span class="w"> </span><span class="n">around</span>
<span class="w">        </span><span class="mi">5721</span><span class="w">        </span><span class="o">/</span><span class="w"> </span><span class="n">Next</span><span class="w"> </span><span class="n">register</span>
<span class="w">        </span><span class="mi">20127</span><span class="w">       </span><span class="o">/</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">all</span><span class="o">?</span>
<span class="w">        </span><span class="mi">177660</span>
<span class="w">        </span><span class="mi">101401</span><span class="w">      </span><span class="o">/</span><span class="w"> </span><span class="n">Skip</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">not</span>
<span class="w">        </span><span class="mi">0</span><span class="w">           </span><span class="o">/</span><span class="w"> </span><span class="n">Halt</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">done</span>
<span class="w">        </span><span class="mi">137</span><span class="w">         </span><span class="o">/</span><span class="w"> </span><span class="n">Go</span><span class="w"> </span><span class="n">back</span>
<span class="w">        </span><span class="mi">1010</span>
</pre></div>


<p>This is toggled in and passes on the machine.</p>
</li>
<li>
<p>Mattis Lind:</p>
<blockquote>
<p>Would it be any difference if you run the machine at full speed or lower speed or even single step past
this instruction? ... The TIG module has a separate non crystal controlled oscillator which one could
tune for marginal checking.</p>
</blockquote>
<p>Ah, yes, the margining clock!  Always worth a check, and very easy to use with if you have a KM11 handy.
A variety of clock speeds are tried, but the behavior remains the same.</p>
</li>
<li>
<p>Brent Hilpert:</p>
<blockquote>
<p>For consideration, what about the refresh circuitry of the memory board?</p>
<p>Mem diagnostics, unless they explicitly account for it, may not show up problems with memory refresh if
the loop times are short enough to effectively substitute as refresh cycles, while they could show up
later in real-world use with arbitrary time between accesses.</p>
<p>Refresh on some early boards/systems was asynchronously timed by monostables or onboard oscillators
which can drift or fail on the margin/slope. (I don't know what DEC's design policy was for DRAM
refresh). It might also explain why a number of 4116s were (apparently) failing earlier in the efforts
(if I recall the discussion correctly), replacing them might have just replaced them with 'slightly
better' chips, i.e. with a slightly longer refresh tolerance.</p>
</blockquote>
<p>This one also gets some follow-up.  The schematics are consulted, and the MS11-L refresh is seen, indeed,
to be driven by a simple free-running 555.  Further from Brent:</p>
<blockquote>
<p>4116 datasheet specs 2mS, my calcs give a refresh period of 1.5mS, the 14.5uS from the manual would give
1.86 mS, 7% shy of 2. The schematic specs 1% resistors, and the parts list does appear to spec a
high-tolerance "1%200PPM" cap.</p>
<p>Although there are the internal voltage divider Rs in the 555 which are also critical for the timing and
everything is 40+ years old...</p>
</blockquote>
<p>The actual MS11 in use measures out on my 'scope at 15.2us.  From Brent:</p>
<blockquote>
<p>15.2uS gives a 1.95mS refresh, so it's awfully close to the 2mS spec, but still within.  The datasheet I
was looking at doesn't seem to give any spec for tolerance on the refresh so one would guess there's a
safety margin built into the 2mS spec.</p>
</blockquote>
</li>
</ul>
<p>Fritz:</p>
<blockquote>
<blockquote>
<div class="highlight"><pre><span></span>R0 177770
R1 0
R2 0
R3 0
R4 34
R5 444
SP 177760
PC 010210

060: 000000 000020 000001 177770 177774 177777 071554 000000
</pre></div>


</blockquote>
<p>Okay, I've had a bit of time in front of the machine to repro this and take a look.  What I actually see is:</p>
<div class="highlight"><pre><span></span>R0 177770
R1 0
R2 0
R3 0
R4 0
R5 34
R6 141774
PC 000254
</pre></div>


<p>(remember, for the last, this will have been after taking a trap to 250, where I have the usual "BR .+2;
HALT" catcher installed)</p>
<p>Also, memory at 060 (PA:164060) is all zeros as far as the eye can see...</p>
</blockquote>
<p>Then, a big discovery from Noel:</p>
<blockquote>
<p>Argh. (Very red face!)</p>
<p>I worked out the trap stack layout by looking at m40.s and trap.c, and totally forgot about the return PC
(that's the 0444) from the call to trap():</p>
<div class="highlight"><pre><span></span><span class="mf">0001740</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">141756</span><span class="w"> </span><span class="mf">022050</span><span class="w"> </span><span class="mf">000013</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">000034</span>
<span class="mf">0001760</span><span class="w"> </span><span class="mf">000444</span><span class="w"> </span><span class="mf">000031</span><span class="w"> </span><span class="mf">177760</span><span class="w"> </span><span class="mf">000000</span><span class="w"> </span><span class="mf">030351</span><span class="w"> </span><span class="mf">177770</span><span class="w"> </span><span class="mf">010210</span><span class="w"> </span><span class="mf">170010</span>
</pre></div>


<p>I clearly should have looked at core(V) in the V6 manual!</p>
<p>The R6 you have recorded is correct for just after the trap; that's the kernel mode SP, which points to the
top of the kernel stack, in segment 6 (in the swappable per-process kernel area, which runs from
140000-1776).</p>
<p>So there is no R5 mystery, I was just confused. Back to the other two!</p>
</blockquote>
<p>But meanwhile, back in front of the actual machine:</p>
<blockquote>
<p>Seeing some quite strange stuff now, after the crash, flipping between "CONS PHY" and "PROG PHY"...</p>
<p>Bits 6-12 are not acting as I would expect, almost as if the KT11 ALU is doing an incorrect operation
(subtraction rather than add!)  </p>
<p>I see these are 74S181 bit slice ALUs, and function code should be hardwired to "A+B"... So that brings us
back around to really checking those supply voltages...</p>
</blockquote>
<p>It turns out the +5V supplies were, in fact, slightly low (about 4.9 or so).  Trimmed these up, and the the
observed problems with bits 6-12 receded, though the "ls" crash remained exactly the same.  It would appear,
though, consistent with remarks above, that the machine has very little undervoltage tolerance on +5V --
certainly less than the documented -5%.</p>
<p>How long had the machine been in this condition, and what else might have been affected?  It could not have
been for very long, since the previously run KT11 diagnostics would certainly have failed.  But the situation
was spooky, and instilled some uncertainty about other data that had recently been retrieved via the front
panel...</p>
<h3>February 5</h3>
<p>Noel clears away one additional address calculation error:</p>
<blockquote>
<p>So I had to grub a bit to find this, but here's what I said:</p>
<blockquote>
<p>With KISA7 at 001641, 0164100 should be the first location after the stack, so 0164060 and up would be
good. They <em>should</em> be:</p>
<div class="highlight"><pre><span></span><span class="mi">060</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000020</span><span class="w"> </span><span class="mi">000001</span><span class="w"> </span><span class="mi">177770</span><span class="w"> </span><span class="mi">177774</span><span class="w"> </span><span class="mi">177777</span><span class="w"> </span><span class="mi">071554</span><span class="w"> </span><span class="mi">000000</span>
</pre></div>


</blockquote>
<p>and I have no idea how I screwed the address there up that that badly. The data I'm showing there is the top
(address-wise; i.e. bottom, push-pop-wise) of the user stack, and I think it's correct. However, it's UISA7
which contains 01641, and that's the 'bottom' of that segment. I had previously done the math correctly:</p>
<blockquote>
<p>base of user data is at 0176000 (per UISA1 contents), runs to 0201476 (i.e. plus 03500); the stack would
run from 0201500 to 0204076 (i.e. plus 02400). So the stack segment 'base' would be 020000 below the next
word, or 0164100.</p>
</blockquote>
<p>So physical 0164060 is just in the middle of nowhere; it's somewhere in the middle of the text (which starts
at physical 0161400).</p>
<p>If you could try this again, and check the top of the <em>actual</em> user stack (which will be at physical
0204060-0204076), I'd really appreciate it. I do expect it to be correct: the process core dump has it
correct (as shown by the analysis of argc, argv, etc).</p>
</blockquote>
<p>And I am able to get some consistent, correct, data after the power-supply tune-up:</p>
<blockquote>
<p>Okay, latest numbers for you!</p>
<p>Stack, confirmed:</p>
<div class="highlight"><pre><span></span><span class="n">PA</span><span class="o">:</span><span class="mi">204060</span><span class="o">:</span><span class="w"> </span><span class="mi">000000</span><span class="w"> </span><span class="mi">000020</span><span class="w"> </span><span class="mi">000001</span><span class="w"> </span><span class="mi">177770</span><span class="w"> </span><span class="mi">177774</span><span class="w"> </span><span class="mi">777777</span><span class="w"> </span><span class="mi">071554</span><span class="w"> </span><span class="mi">000000</span>
</pre></div>


<p>Text; as I had feared, a few dropped bits there!  Went ahead and grabbed you eight extra words while I was
there:</p>
<div class="highlight"><pre><span></span><span class="n">PA</span><span class="o">:</span><span class="mi">171600</span><span class="o">:</span><span class="w"> </span><span class="mi">016162</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000224</span><span class="w"> </span><span class="mi">000414</span><span class="w"> </span><span class="mi">016700</span><span class="w"> </span><span class="mi">016152</span><span class="w"> </span><span class="mi">016702</span><span class="w"> </span><span class="mi">016144</span>
<span class="n">PA</span><span class="o">:</span><span class="mi">171620</span><span class="o">:</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000206</span><span class="w"> </span><span class="mi">000405</span><span class="w"> </span><span class="mi">012404</span><span class="w"> </span><span class="mi">012467</span><span class="w"> </span><span class="mi">016124</span><span class="w"> </span><span class="mi">000167</span><span class="w"> </span><span class="mi">177346</span>
</pre></div>


<p>In disassembly from 171602, this yields:</p>
<div class="highlight"><pre><span></span><span class="mi">171602</span><span class="o">:</span><span class="w">   </span><span class="n">JSR</span><span class="w">     </span><span class="n">PC</span><span class="o">,</span><span class="mi">172032</span>
<span class="mi">171606</span><span class="o">:</span><span class="w">   </span><span class="n">BR</span><span class="w">      </span><span class="mi">171640</span>
<span class="mi">171610</span><span class="o">:</span><span class="w">   </span><span class="n">MOV</span><span class="w">     </span><span class="mi">7766</span><span class="o">,</span><span class="n">R0</span>
<span class="mi">171614</span><span class="o">:</span><span class="w">   </span><span class="n">MOV</span><span class="w">     </span><span class="mi">7764</span><span class="o">,</span><span class="n">R2</span>
<span class="mi">171620</span><span class="o">:</span><span class="w">   </span><span class="n">JSR</span><span class="w">     </span><span class="n">PC</span><span class="o">,</span><span class="mi">172032</span>
<span class="mi">171624</span><span class="o">:</span><span class="w">   </span><span class="n">BR</span><span class="w">      </span><span class="mi">171640</span>
<span class="mi">171626</span><span class="o">:</span><span class="w">   </span><span class="n">MOV</span><span class="w">     </span><span class="o">(</span><span class="n">R4</span><span class="o">)+,</span><span class="n">R4</span>
<span class="mi">171630</span><span class="o">:</span><span class="w">   </span><span class="n">MOV</span><span class="w">     </span><span class="o">(</span><span class="n">R4</span><span class="o">)+,</span><span class="mi">7760</span>
<span class="mi">171634</span><span class="o">:</span><span class="w">   </span><span class="n">JMP</span><span class="w">     </span><span class="mi">171206</span>
</pre></div>


<p>...which looks at least like feasible code, if not the code we are expecting?</p>
</blockquote>
<p>Last, a note on procedure for using the front panel to verify KT11 address mappings:</p>
<blockquote>
<p>The way this works is you select the mapping set you want (in our case, USER I) with the top knob on the
console, then toggle in a <em>virtual</em> address, hit "LOAD ADRS", and then when you hit "EXAM" it maps your
provided address through the selected set.  Under these circumstances, I'll also see the "KERNEL" light go
out and the "USER" light light up on the front panel indicating the active mapping set.  You can then flip
to "PROG PHY" to see the mapped-to physical address.  This is not explained very clearly in the handbooks;
it took me a little experimentation to figure out how to do it.</p>
<p>Anyway, in our case, I toggle in "10210", and can read out "171610".</p>
</blockquote>
<h3>February 6</h3>
<p>Noel:</p>
<blockquote>
<blockquote>
<p>In disassembly from 171602, this yields: ...which looks at least like feasible code</p>
</blockquote>
<p>The first 4 words, yes, but not the rest. (Oh, and your disassembly is wrong; you used PA addresses, not
VA.)</p>
<p>But excitingly, that <em>could</em> explain the MM trap, since 16700/16152 at VA: 010210 gives us:</p>
<div class="highlight"><pre><span></span>MOV 26364, R0
</pre></div>


<p>and that address is in segment 1, which is only 03500 long...</p>
</blockquote>
<p>Fritz:</p>
<blockquote>
<p>Also, that exact sequence does occur in the ls binary!</p>
<p>From last night:</p>
<div class="highlight"><pre><span></span><span class="n">PA</span><span class="o">:</span><span class="mi">171600</span><span class="o">:</span><span class="w"> </span><span class="mi">016162</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000224</span><span class="w"> </span><span class="mi">000414</span><span class="w"> </span><span class="mi">016700</span><span class="w"> </span><span class="mi">016152</span><span class="w"> </span><span class="mi">016702</span><span class="w"> </span><span class="mi">016144</span>
<span class="n">PA</span><span class="o">:</span><span class="mi">171620</span><span class="o">:</span><span class="w"> </span><span class="mi">004767</span><span class="w"> </span><span class="mi">000206</span><span class="w"> </span><span class="mi">000405</span><span class="w"> </span><span class="mi">012404</span><span class="w"> </span><span class="mi">012467</span><span class="w"> </span><span class="mi">016124</span><span class="w"> </span><span class="mi">000167</span><span class="w"> </span><span class="mi">177346</span>
</pre></div>


<p>And from an od on bin/ls:</p>
<div class="highlight"><pre><span></span><span class="mf">0004220</span><span class="w"> </span><span class="mf">016162</span><span class="w"> </span><span class="mf">004767</span><span class="w"> </span><span class="mf">000224</span><span class="w"> </span><span class="mf">000414</span><span class="w"> </span><span class="mf">016700</span><span class="w"> </span><span class="mf">016152</span><span class="w"> </span><span class="mf">016702</span><span class="w"> </span><span class="mf">016144</span>
<span class="mf">0004240</span><span class="w"> </span><span class="mf">004767</span><span class="w"> </span><span class="mf">000206</span><span class="w"> </span><span class="mf">000405</span><span class="w"> </span><span class="mf">012404</span><span class="w"> </span><span class="mf">012467</span><span class="w"> </span><span class="mf">016124</span><span class="w"> </span><span class="mf">000167</span><span class="w"> </span><span class="mf">177346</span>
</pre></div>


</blockquote>
<p>All together, this brings us to a significant juncture in the debug effort: the power supply issue has been
addressed, and various red herring have been cleared away.  Pre-conditions which exactly match the observed
fault are apparent.  We are left with a single, consistent, and reproducible issue: part of the process
address space ends up holding the wrong part of the program text.  But how, and why?</p></div>
    <hr />
</div>
    
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="https://fritzm.github.io/tag/retro-computing.html">1</a></li>
    <li class=""><a href="https://fritzm.github.io/tag/retro-computing2.html">2</a></li>
    <li class=""><a href="https://fritzm.github.io/tag/retro-computing3.html">3</a></li>
    <li class=""><a href="https://fritzm.github.io/tag/retro-computing4.html">4</a></li>
    <li class=""><a href="https://fritzm.github.io/tag/retro-computing5.html">5</a></li>
    <li class=""><a href="https://fritzm.github.io/tag/retro-computing6.html">6</a></li>
    <li class=""><a href="https://fritzm.github.io/tag/retro-computing7.html">7</a></li>

    <li class="next"><a href="https://fritzm.github.io/tag/retro-computing2.html">Next &rarr;</a></li>

</ul>
</div>
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="https://fritzm.github.io/archives.html">Archives</a>
                <li><a href="https://fritzm.github.io/tags.html">Tags</a>



                <li><a href="https://fritzm.github.io/feeds/all.rss.xml" rel="alternate">RSS feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="https://fritzm.github.io/category/arcade-games.html">Arcade Games</a></li>
                <li><a href="https://fritzm.github.io/category/math.html">Math</a></li>
                <li><a href="https://fritzm.github.io/category/micros.html">Micros</a></li>
                <li><a href="https://fritzm.github.io/category/pdp-11.html">PDP-11</a></li>
                <li><a href="https://fritzm.github.io/category/programming.html">Programming</a></li>
                <li><a href="https://fritzm.github.io/category/radios.html">Radios</a></li>
                   
            </ul>
            </div>




            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="http://facebook.com/fritzmueller">facebook</a></li>
                <li><a href="http://twitter.com/infrafritz">twitter</a></li>
                <li><a href="http://instagram.com/infrafritz">Instagram</a></li>
                <li><a href="http://www.linkedin.com/pub/fritz-mueller/a/679/62/">LinkedIn</a></li>
                <li><a href="http://jsfiddle.net/user/fritzm/fiddles/">JSFiddle</a></li>
                <li><a href="https://github.com/fritzm">GitHub</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="https://fritzm.github.io">fritzm.github.io</a> &copy; Fritz Mueller 2023</p>
</footer>

</div> <!-- /container -->

<!-- Photoswipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://fritzm.github.io/theme/bootstrap-collapse.js"></script>
 
</body>
</html>