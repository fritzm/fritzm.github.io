<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>fritzm.github.io</title>
    <meta name="description" content="">
    <meta name="author" content="Fritz Mueller">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://fritzm.github.io/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://fritzm.github.io/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://fritzm.github.io/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://fritzm.github.io/theme/local.css" rel="stylesheet">
    <link href="http://fritzm.github.io/theme/pygments.css" rel="stylesheet">

    <!-- Photoswipe -->
    <link rel="stylesheet" href="http://fritzm.github.io/theme/photoswipe.css">
    <link rel="stylesheet" href="http://fritzm.github.io/theme/default-skin/default-skin.css">
    <script src="http://fritzm.github.io/theme/photoswipe.min.js"></script>
    <script src="http://fritzm.github.io/theme/photoswipe-ui-default.min.js"></script>
    <script src="http://fritzm.github.io/galleries.js"></script>
    <script type="text/javascript">
        var pswipe = function(gname, index) {
            var pswpElement = document.querySelectorAll('.pswp')[0];
            var items = galleries[gname];
            var options = { index: index };
            var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
            gallery.init();
        };
    </script>

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="feeds/all.rss.xml" rel="alternate" title="fritzm.github.io" type="application/rss+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://fritzm.github.io">fritzm.github.io</a>

        <div class="nav-collapse">
        <ul class="nav">

        </ul>
        </div>

    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">


<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-13.html"><h1>PDP-11/45: Diagnostics XIII - FP11 FPU, cont.</h1></a>
Thu 24 November 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Have been looking into the FP11 MOD problem in spare moments of the past few weeks, but haven't written up
an account of the progress, so this will be a bit of a catch-up article.</p>
<p>Having now studied the design of this thing in more depth, there are a few things I find interesting:</p>
<ul>
<li>
<p>The inner loops of the multiplication, division, and floating-point normalization algorithms on the FP11
are not implemented in microcode, but rather as "hardware subroutines".  Microcode does all the setup of
the various internal registers and counters, then pauses while the hardware runs the inner loop, then picks up
again to mediate rounding, masking, exceptions, etc. afterward.</p>
</li>
<li>
<p>The multiplication implementation uses an interesting algorithm called "skipping over ones and zeros",
described in section 5.3.1 of the FP11 maintenance manual.  This reduces the number of time-consuming
additions needed on average.  It works along the lines of a familiar mental shortcut: suppose you had to
multiply some number X by 999.  Rather than multiply X by 9 three times and shift and add them all up, you
would probably just take X * 1,000 and subtract off X * 1.  The key observation is that you can do this
for any contiguous string of 9s in the multiplier: subtract the multiplicand from the partial product at
the place value where the string begins, then add the multiplicand at one past place value where the string
ends.  The FP11 implements the binary equivalent of this with a small state machine (comprised of flip-flops
MR1, MR0, and STRG1) which identifies strings of contiguous 1s and invokes ALU subtractions and additions on
the boundaries as the multiplier is shifted through.</p>
</li>
<li>
<p>Debugging techniques: a KM11 in single-clock-transition mode may be used to step within the hardware
subroutines, as they are driven off the main FP11 clock.  It can be a lot of switch presses to step through
an entire multiply (120 or so clock transitions at least for a double-precision multiply, and typically
more because each necessary intermediate add/subtract adds eight clock transitions!) and this gets to be
pretty tedious and error-prone.  A logic analyzer is very useful here to capture a visualization of an entire
multiplication at one go, and enable counting off clock transitions needed to get to something you'd
like to take a closer look at with a logic probe.  Alternatively, if your FP11 is working well enough to
run maintenance instructions, there are software techniques that can prematurely terminate the hardware
subroutines and also give some useful visibility into the intermediate states.</p>
</li>
</ul>
<p>I opted to try out the software techniques to see if I could get more information on the (mis)behavior in
my FP11 order to focus my hardware troubleshooting.  The following program came in handy.  This is based off
some example code in the FP11 maintenance manual, though I elaborated it slightly with a binary printout
routine:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="nt">000000</span>                          <span class="nt">AC0</span><span class="o">=%</span><span class="nt">0</span>
        <span class="nt">000001</span>                          <span class="nt">AC1</span><span class="o">=%</span><span class="nt">1</span>
        <span class="nt">000002</span>                          <span class="nt">AC2</span><span class="o">=%</span><span class="nt">2</span>
        <span class="nt">177560</span>                          <span class="nt">SERIAL</span><span class="o">=</span><span class="nt">177560</span>
        <span class="nt">170006</span>                          <span class="nt">MRS</span><span class="o">=</span><span class="nt">170006</span>
<span class="nt">000000</span>                                  <span class="p">.</span><span class="nc">ASECT</span>
        <span class="nt">001000</span>                          <span class="o">.=</span><span class="nt">1000</span>
<span class="nt">001000</span>  <span class="nt">170127</span>  <span class="nt">040220</span>          <span class="nt">START</span><span class="o">:</span>  <span class="nt">LDFPS</span>   <span class="p">#</span><span class="nn">40220</span>          <span class="o">;</span><span class="nt">DISABLE</span> <span class="nt">INTS</span><span class="o">,</span> <span class="nt">SET</span> <span class="nt">DBL</span> <span class="nt">AND</span> <span class="nt">MAINT</span> <span class="nt">MODE</span>
<span class="nt">001004</span>  <span class="nt">172667</span>  <span class="nt">000316</span>                  <span class="nt">LDD</span>     <span class="nt">MLYR</span><span class="o">,</span><span class="nt">AC2</span>        <span class="o">;</span><span class="nt">LOAD</span> <span class="nt">MULTIPLIER</span> <span class="nt">IN</span> <span class="nt">AC2</span>
<span class="nt">001010</span>  <span class="nt">012703</span>  <span class="nt">000230</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">230</span><span class="o">,</span><span class="nt">R3</span>         <span class="o">;</span><span class="nt">R3</span> <span class="nt">GETS</span> <span class="nt">OCTAL</span> <span class="nt">230</span> <span class="o">(</span><span class="nt">FRAC</span> <span class="nt">MUL</span> <span class="nt">MICROSTATE</span><span class="o">)</span>
<span class="nt">001014</span>  <span class="nt">170003</span>                          <span class="nt">LDUB</span>                    <span class="o">;</span><span class="nt">LOAD</span> <span class="nt">R3</span> <span class="nt">TO</span> <span class="nt">MBR</span>
<span class="nt">001016</span>  <span class="nt">012702</span>  <span class="nt">177564</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">SERIAL</span><span class="o">+</span><span class="nt">4</span><span class="o">,</span><span class="nt">R2</span>    <span class="o">;</span><span class="nt">SERIAL</span> <span class="nt">XMIT</span> <span class="nt">BASE</span> <span class="nt">TO</span> <span class="nt">R2</span>
<span class="nt">001022</span>  <span class="nt">012762</span>  <span class="nt">000015</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">15</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OUTPUT</span> <span class="s1">&#39;\R&#39;</span>
<span class="nt">001030</span>  <span class="nt">105712</span>                          <span class="nt">TSTB</span>    <span class="o">(</span><span class="nt">R2</span><span class="o">)</span>            <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">CLEAR</span>
<span class="nt">001032</span>  <span class="nt">100376</span>                          <span class="nt">BPL</span>     <span class="p">.</span><span class="nc">-2</span>             <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">SO</span>
<span class="nt">001034</span>  <span class="nt">012762</span>  <span class="nt">000012</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">12</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OUTPUT</span> <span class="s1">&#39;\N&#39;</span>
<span class="nt">001042</span>  <span class="nt">105712</span>                          <span class="nt">TSTB</span>    <span class="o">(</span><span class="nt">R2</span><span class="o">)</span>            <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">CLEAR</span>
<span class="nt">001044</span>  <span class="nt">100376</span>                          <span class="nt">BPL</span>     <span class="p">.</span><span class="nc">-2</span>             <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">SO</span>
<span class="nt">001046</span>  <span class="nt">005004</span>                          <span class="nt">CLR</span>     <span class="nt">R4</span>              <span class="o">;</span><span class="nt">R4</span> <span class="nt">HOLDS</span> <span class="nt">SC</span> <span class="nt">VALUE</span>
<span class="nt">001050</span>  <span class="nt">005204</span>                  <span class="nt">NXTMUL</span><span class="o">:</span> <span class="nt">INC</span>     <span class="nt">R4</span>              <span class="o">;</span><span class="nt">INCREMENT</span> <span class="nt">SC</span>
<span class="nt">001052</span>  <span class="nt">170004</span>                          <span class="nt">LDSC</span>                    <span class="o">;</span><span class="nt">LOAD</span> <span class="nt">1S</span> <span class="nt">COMPLEMENT</span> <span class="nt">OF</span> <span class="nt">R4</span> <span class="nt">INTO</span> <span class="nt">SC</span>
<span class="nt">001054</span>  <span class="nt">012705</span>  <span class="nt">001356</span>          <span class="nt">LSTMUL</span><span class="o">:</span> <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">QR</span><span class="o">+</span><span class="nt">10</span><span class="o">,</span><span class="nt">R5</span>       <span class="o">;</span><span class="nt">SET</span> <span class="nt">R5</span> <span class="nt">PAST</span> <span class="nt">END</span> <span class="nt">OF</span> <span class="nt">STORAGE</span> <span class="nt">TABLE</span>
<span class="nt">001060</span>  <span class="nt">172567</span>  <span class="nt">000232</span>                  <span class="nt">LDD</span>     <span class="nt">MCND</span><span class="o">,</span><span class="nt">AC1</span>        <span class="o">;</span><span class="nt">LOAD</span> <span class="nt">MULTIPLICAND</span> <span class="nt">INTO</span> <span class="nt">AC1</span>
<span class="nt">001064</span>  <span class="nt">171102</span>                          <span class="nt">MULD</span>    <span class="nt">AC2</span><span class="o">,</span><span class="nt">AC1</span>         <span class="o">;</span><span class="nt">DO</span> <span class="nt">PARTIAL</span> <span class="nt">MULTIPLY</span>
<span class="nt">001066</span>  <span class="nt">170007</span>                          <span class="nt">STQ0</span>                    <span class="o">;</span><span class="nt">TRANSFER</span> <span class="nt">QR</span> <span class="nt">TO</span> <span class="nt">AC0</span>
<span class="nt">001070</span>  <span class="nt">174045</span>                          <span class="nt">STD</span>     <span class="nt">AC0</span><span class="o">,</span><span class="nt">-</span><span class="o">(</span><span class="nt">R5</span><span class="o">)</span>       <span class="o">;</span><span class="nt">STORE</span> <span class="nt">QR</span> <span class="nt">IN</span> <span class="nt">TABLE</span>
<span class="nt">001072</span>  <span class="nt">042715</span>  <span class="nt">177600</span>                  <span class="nt">BIC</span>     <span class="p">#</span><span class="nn">177600</span><span class="o">,(</span><span class="nt">R5</span><span class="o">)</span>    <span class="o">;</span><span class="nt">CLEAR</span> <span class="nt">OFF</span> <span class="nt">SIGN</span> <span class="nt">AND</span> <span class="nt">EXPONENT</span>
<span class="nt">001076</span>  <span class="nt">170005</span>                          <span class="nt">STA0</span>                    <span class="o">;</span><span class="nt">TRANSFER</span> <span class="nt">AR</span> <span class="nt">TO</span> <span class="nt">AC0</span>
<span class="nt">001100</span>  <span class="nt">174045</span>                          <span class="nt">STD</span>     <span class="nt">AC0</span><span class="o">,</span><span class="nt">-</span><span class="o">(</span><span class="nt">R5</span><span class="o">)</span>       <span class="o">;</span><span class="nt">STORE</span> <span class="nt">AR</span> <span class="nt">IN</span> <span class="nt">TABLE</span>
<span class="nt">001102</span>  <span class="nt">042715</span>  <span class="nt">177600</span>                  <span class="nt">BIC</span>     <span class="p">#</span><span class="nn">177600</span><span class="o">,(</span><span class="nt">R5</span><span class="o">)</span>    <span class="o">;</span><span class="nt">CLEAR</span> <span class="nt">OFF</span> <span class="nt">SIGN</span> <span class="nt">AND</span> <span class="nt">EXPONENT</span>
<span class="nt">001106</span>  <span class="nt">170006</span>                          <span class="nt">MRS</span>                     <span class="o">;</span><span class="nt">SHIFT</span> <span class="nt">AR</span> <span class="nt">AND</span> <span class="nt">QR</span> <span class="nt">RIGHT</span> <span class="nt">ONE</span> <span class="nt">PLACE</span>
<span class="nt">001110</span>  <span class="nt">170006</span>                          <span class="nt">MRS</span>                     <span class="o">;</span><span class="nt">SHIFT</span> <span class="nt">AR</span> <span class="nt">AND</span> <span class="nt">QR</span> <span class="nt">RIGHT</span> <span class="nt">ONE</span> <span class="nt">PLACE</span>
<span class="nt">001112</span>  <span class="nt">170007</span>                          <span class="nt">STQ0</span>                    <span class="o">;</span><span class="nt">TRANSFER</span> <span class="nt">QR</span> <span class="nt">TO</span> <span class="nt">AC0</span>
<span class="nt">001114</span>  <span class="nt">174067</span>  <span class="nt">000236</span>                  <span class="nt">STD</span>     <span class="nt">AC0</span><span class="o">,</span><span class="nt">TEMP</span>        <span class="o">;</span><span class="nt">STORE</span> <span class="nt">QR</span> <span class="nt">IN</span> <span class="nt">TEMP</span>
<span class="nt">001120</span>  <span class="nt">016703</span>  <span class="nt">000232</span>                  <span class="nt">MOV</span>     <span class="nt">TEMP</span><span class="o">,</span><span class="nt">R3</span>         <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">MSW</span> <span class="nt">OF</span> <span class="nt">QR</span> <span class="nt">TO</span> <span class="nt">R3</span>
<span class="nt">001124</span>  <span class="nt">042703</span>  <span class="nt">177600</span>                  <span class="nt">BIC</span>     <span class="p">#</span><span class="nn">177600</span><span class="o">,</span><span class="nt">R3</span>      <span class="o">;</span><span class="nt">CLEAR</span> <span class="nt">OFF</span> <span class="nt">SIGN</span> <span class="nt">AND</span> <span class="nt">EXPONENT</span>
<span class="nt">001130</span>  <span class="nt">006303</span>                          <span class="nt">ASL</span>     <span class="nt">R3</span>              <span class="o">;</span><span class="nt">SHIFT</span> <span class="nt">MSBS</span> <span class="nt">OF</span> <span class="nt">QR</span> <span class="nt">ONE</span> <span class="nt">PLACE</span> <span class="nt">LEFT</span>
<span class="nt">001132</span>  <span class="nt">006303</span>                          <span class="nt">ASL</span>     <span class="nt">R3</span>              <span class="o">;</span><span class="nt">SHIFT</span> <span class="nt">MSBS</span> <span class="nt">OF</span> <span class="nt">QR</span> <span class="nt">ONE</span> <span class="nt">PLACE</span> <span class="nt">LEFT</span>
<span class="nt">001134</span>  <span class="nt">050365</span>  <span class="nt">000010</span>                  <span class="nt">BIS</span>     <span class="nt">R3</span><span class="o">,</span><span class="nt">10</span><span class="o">(</span><span class="nt">R5</span><span class="o">)</span>       <span class="o">;</span><span class="nt">SET</span> <span class="nt">QR59</span> <span class="nt">AND</span> <span class="nt">QR58</span> <span class="nt">IN</span> <span class="nt">TABLE</span>
<span class="nt">001140</span>  <span class="nt">170005</span>                          <span class="nt">STA0</span>                    <span class="o">;</span><span class="nt">TRANSFER</span> <span class="nt">AR</span> <span class="nt">TO</span> <span class="nt">AC0</span>
<span class="nt">001142</span>  <span class="nt">174067</span>  <span class="nt">000210</span>                  <span class="nt">STD</span>     <span class="nt">AC0</span><span class="o">,</span><span class="nt">TEMP</span>        <span class="o">;</span><span class="nt">STORE</span> <span class="nt">AR</span> <span class="nt">IN</span> <span class="nt">TEMP</span>
<span class="nt">001146</span>  <span class="nt">016703</span>  <span class="nt">000204</span>                  <span class="nt">MOV</span>     <span class="nt">TEMP</span><span class="o">,</span><span class="nt">R3</span>         <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">MSW</span> <span class="nt">OF</span> <span class="nt">AR</span> <span class="nt">TO</span> <span class="nt">R3</span>
<span class="nt">001152</span>  <span class="nt">042703</span>  <span class="nt">177600</span>                  <span class="nt">BIC</span>     <span class="p">#</span><span class="nn">177600</span><span class="o">,</span><span class="nt">R3</span>      <span class="o">;</span><span class="nt">CLEAR</span> <span class="nt">OFF</span> <span class="nt">SIGN</span> <span class="nt">AND</span> <span class="nt">EXPONENT</span>
<span class="nt">001156</span>  <span class="nt">006303</span>                          <span class="nt">ASL</span>     <span class="nt">R3</span>              <span class="o">;</span><span class="nt">SHIFT</span> <span class="nt">MSBS</span> <span class="nt">OF</span> <span class="nt">AR</span> <span class="nt">ONE</span> <span class="nt">PLACE</span> <span class="nt">LEFT</span>
<span class="nt">001160</span>  <span class="nt">006303</span>                          <span class="nt">ASL</span>     <span class="nt">R3</span>              <span class="o">;</span><span class="nt">SHIFT</span> <span class="nt">MSBS</span> <span class="nt">OF</span> <span class="nt">AR</span> <span class="nt">ONE</span> <span class="nt">PLACE</span> <span class="nt">LEFT</span>
<span class="nt">001162</span>  <span class="nt">050315</span>                          <span class="nt">BIS</span>     <span class="nt">R3</span><span class="o">,(</span><span class="nt">R5</span><span class="o">)</span>         <span class="o">;</span><span class="nt">SET</span> <span class="nt">AR59</span> <span class="nt">AND</span> <span class="nt">AR58</span> <span class="nt">IN</span> <span class="nt">TABLE</span>
<span class="nt">001164</span>  <span class="nt">012705</span>  <span class="nt">001336</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">AR</span><span class="o">,</span><span class="nt">R5</span>          <span class="o">;</span><span class="nt">GET</span> <span class="nt">ADDRESS</span> <span class="nt">OF</span> <span class="nt">FIRST</span> <span class="nt">QUAD</span> <span class="nt">FOR</span> <span class="nt">PRINTING</span>
<span class="nt">001170</span>  <span class="nt">012700</span>  <span class="nt">000010</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">10</span><span class="o">,</span><span class="nt">R0</span>          <span class="o">;</span><span class="nt">R0</span> <span class="nt">COUNTS</span> <span class="nt">8</span> <span class="nt">WORDS</span> <span class="nt">IN</span> <span class="nt">TWO</span> <span class="nt">QUADS</span>
<span class="nt">001174</span>  <span class="nt">012503</span>                  <span class="nt">LWORD</span><span class="o">:</span>  <span class="nt">MOV</span>     <span class="o">(</span><span class="nt">R5</span><span class="o">)+,</span><span class="nt">R3</span>        <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">NEXT</span> <span class="nt">WORD</span> <span class="nt">OF</span> <span class="nt">QUAD</span>
<span class="nt">001176</span>  <span class="nt">012701</span>  <span class="nt">000020</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">20</span><span class="o">,</span><span class="nt">R1</span>          <span class="o">;</span><span class="nt">R1</span> <span class="nt">COUNTS</span> <span class="nt">16</span> <span class="nt">BITS</span> <span class="nt">IN</span> <span class="nt">WORD</span>
<span class="nt">001202</span>  <span class="nt">006103</span>                  <span class="nt">LBIT</span><span class="o">:</span>   <span class="nt">ROL</span>     <span class="nt">R3</span>              <span class="o">;</span><span class="nt">ROTATE</span><span class="o">,</span> <span class="nt">HIGH</span> <span class="nt">BIT</span> <span class="nt">GOES</span> <span class="nt">TO</span> <span class="nt">CARRY</span>
<span class="nt">001204</span>  <span class="nt">103405</span>                          <span class="nt">BCS</span>     <span class="nt">LBIT1</span>           <span class="o">;</span><span class="nt">SKIP</span> <span class="nt">AHEAD</span> <span class="nt">IF</span> <span class="nt">CARRY</span> <span class="nt">SET</span>
<span class="nt">001206</span>  <span class="nt">012762</span>  <span class="nt">000056</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">56</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OTHERWISE</span> <span class="nt">OUTPUT</span> <span class="s1">&#39;.&#39;</span>
<span class="nt">001214</span>  <span class="nt">000167</span>  <span class="nt">000006</span>                  <span class="nt">JMP</span>     <span class="nt">LBIT2</span>           <span class="o">;</span><span class="nt">AND</span> <span class="nt">SKIP</span> <span class="nt">AHEAD</span>
<span class="nt">001220</span>  <span class="nt">012762</span>  <span class="nt">000061</span>  <span class="nt">000002</span>  <span class="nt">LBIT1</span><span class="o">:</span>  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">61</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OUTPUT</span> <span class="s1">&#39;1&#39;</span>
<span class="nt">001226</span>  <span class="nt">105712</span>                  <span class="nt">LBIT2</span><span class="o">:</span>  <span class="nt">TSTB</span>    <span class="o">(</span><span class="nt">R2</span><span class="o">)</span>            <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">CLEAR</span>
<span class="nt">001230</span>  <span class="nt">100376</span>                          <span class="nt">BPL</span>     <span class="p">.</span><span class="nc">-2</span>             <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">SO</span>
<span class="nt">001232</span>  <span class="nt">077115</span>                          <span class="nt">SOB</span>     <span class="nt">R1</span><span class="o">,</span><span class="nt">LBIT</span>         <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">OVER</span> <span class="nt">BITS</span> <span class="nt">IN</span> <span class="nt">WORD</span>
<span class="nt">001234</span>  <span class="nt">012762</span>  <span class="nt">000040</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">40</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OUTPUT</span> <span class="s1">&#39; &#39;</span> <span class="nt">TO</span> <span class="nt">SEPARATE</span> <span class="nt">WORDS</span>
<span class="nt">001242</span>  <span class="nt">105712</span>                          <span class="nt">TSTB</span>    <span class="o">(</span><span class="nt">R2</span><span class="o">)</span>            <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">CLEAR</span>
<span class="nt">001244</span>  <span class="nt">100376</span>                          <span class="nt">BPL</span>     <span class="p">.</span><span class="nc">-2</span>             <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">SO</span>
<span class="nt">001246</span>  <span class="nt">077026</span>                          <span class="nt">SOB</span>     <span class="nt">R0</span><span class="o">,</span><span class="nt">LWORD</span>        <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">OVER</span> <span class="nt">WORDS</span> <span class="nt">IN</span> <span class="nt">QUAD</span>
<span class="nt">001250</span>  <span class="nt">012762</span>  <span class="nt">000015</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">15</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OUTPUT</span> <span class="s1">&#39;\R&#39;</span>
<span class="nt">001256</span>  <span class="nt">105712</span>                          <span class="nt">TSTB</span>    <span class="o">(</span><span class="nt">R2</span><span class="o">)</span>            <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">CLEAR</span>
<span class="nt">001260</span>  <span class="nt">100376</span>                          <span class="nt">BPL</span>     <span class="p">.</span><span class="nc">-2</span>             <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">SO</span>
<span class="nt">001262</span>  <span class="nt">012762</span>  <span class="nt">000012</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">12</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">R2</span><span class="o">)</span>       <span class="o">;</span><span class="nt">OUTPUT</span> <span class="s1">&#39;\N&#39;</span>
<span class="nt">001270</span>  <span class="nt">105712</span>                          <span class="nt">TSTB</span>    <span class="o">(</span><span class="nt">R2</span><span class="o">)</span>            <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">CLEAR</span>
<span class="nt">001272</span>  <span class="nt">100376</span>                          <span class="nt">BPL</span>     <span class="p">.</span><span class="nc">-2</span>             <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">SO</span>
<span class="nt">001274</span>  <span class="nt">020427</span>  <span class="nt">000071</span>                  <span class="nt">CMP</span>     <span class="nt">R4</span><span class="o">,</span><span class="p">#</span><span class="nn">71</span>          <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">PASSES</span> <span class="nt">AGAINST</span> <span class="nt">57</span>
<span class="nt">001300</span>  <span class="nt">100663</span>                          <span class="nt">BMI</span>     <span class="nt">NXTMUL</span>          <span class="o">;</span><span class="nt">LESS</span><span class="o">:</span> <span class="nt">DO</span> <span class="nt">NEXT</span> <span class="nt">PASS</span>
<span class="nt">001302</span>  <span class="nt">001402</span>                          <span class="nt">BEQ</span>     <span class="nt">LSTPAS</span>          <span class="o">;</span><span class="nt">EQUAL</span><span class="o">:</span> <span class="nt">DO</span> <span class="nt">LAST</span> <span class="nt">PASS</span>
<span class="nt">001304</span>  <span class="nt">000167</span>  <span class="nt">171470</span>                  <span class="nt">JMP</span>     <span class="nt">173000</span>          <span class="o">;</span><span class="nt">GREATER</span><span class="o">:</span> <span class="nt">RETURN</span> <span class="nt">TO</span> <span class="nt">M9301</span> <span class="nt">MONITOR</span>
<span class="nt">001310</span>  <span class="nt">005204</span>                  <span class="nt">LSTPAS</span><span class="o">:</span> <span class="nt">INC</span>     <span class="nt">R4</span>              <span class="o">;</span><span class="nt">INDICATE</span> <span class="nt">58TH</span> <span class="nt">PASS</span>
<span class="nt">001312</span>  <span class="nt">000167</span>  <span class="nt">177536</span>                  <span class="nt">JMP</span>     <span class="nt">LSTMUL</span>          <span class="o">;</span><span class="nt">DO</span> <span class="nt">LAST</span> <span class="nt">PASS</span> <span class="nt">WITHOUT</span> <span class="nt">LOADING</span> <span class="nt">SC</span>
<span class="nt">001316</span>  <span class="nt">040200</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">MCND</span><span class="o">:</span>   <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">040200</span><span class="o">,</span> <span class="nt">000000</span><span class="o">,</span> <span class="nt">000000</span><span class="o">,</span> <span class="nt">000000</span>
<span class="nt">001324</span>  <span class="nt">000000</span>
<span class="nt">001326</span>  <span class="nt">040300</span>  <span class="nt">000300</span>  <span class="nt">000300</span>  <span class="nt">MLYR</span><span class="o">:</span>   <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">040300</span><span class="o">,</span> <span class="nt">000300</span><span class="o">,</span> <span class="nt">000300</span><span class="o">,</span> <span class="nt">000300</span>
<span class="nt">001334</span>  <span class="nt">000300</span>
<span class="nt">001336</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">AR</span><span class="o">:</span>     <span class="p">.</span><span class="nc">FLT4</span>   <span class="nt">0</span>
<span class="nt">001344</span>  <span class="nt">000000</span>
<span class="nt">001346</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">QR</span><span class="o">:</span>     <span class="p">.</span><span class="nc">FLT4</span>   <span class="nt">0</span>
<span class="nt">001354</span>  <span class="nt">000000</span>
<span class="nt">001356</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">TEMP</span><span class="o">:</span>   <span class="p">.</span><span class="nc">FLT4</span>   <span class="nt">0</span>
<span class="nt">001364</span>  <span class="nt">000000</span>
        <span class="nt">001000</span>                          <span class="p">.</span><span class="nc">END</span>    <span class="nt">START</span>
</pre></div>
</td></tr></table>

<p>The idea here is to use the LDUB (load micro-break) and LDSC (load step-counter) maintenance instructions to
cause a multiplication to halt partway through.  STA0 and STQ0 (store AR, store QR) instructions, in
conjunction with the MRS (maintenance right shift) instruction, allow retrieval of the internal fraction
registers which are then printed out to the serial console.  This is done repetitively, stopping each time
one step further on, so the progression of the internal states of AR and QR over the course of the entire
multiply may be observed.</p>
<p>A quick aside here on tooling: since I don't currently have any storage or an OS running on my PDP-11, I load
and execute diagnostics with PDP11GUI to an M9301 boot monitor over a serial connection.  This requires
program binaries in LDA (absolute loader) format.  For non-trivial MACRO-11 programs I have found it most
convenient to use the actual vintage toolchain under RT-11 in the simh simulator, because the assembler and
linker provided with PDP11GUI have some limitations.  I copy files in and out via the simulated paper tape
reader/punch.  This is also how I produce the MACRO-11 listings seen on this blog.</p>
<p>Okay, back to the program above, running this on my machine very clearly illustrates the malfunction.  Here's
what the output looks like:</p>
<p><span style="font-size: x-small; font-family: monospace; white-space: pre; display: block; line-height: normal; font-weight: bold;">................ ................ ................ ................ .........11..... .........11..... .........11..... .........11.....
................ ................ ................ ................ ..........11.... ..........11.... ..........11.... ..........11....
................ ................ ................ ................ ...........11... ...........11... ...........11... ...........11...
................ ................ ................ ................ ............11.. ............11.. ............11.. ............11..
................ ................ ................ ................ .............11. .............11. .............11. .............11.
................ ................ ................ ................ ..............11 ..............11 ..............11 ..............11
................ ................ ................ ................ ...............1 1..............1 1..............1 1..............1
.......11.111111 1111111111111111 1111111111111111 1111111111111111 ................ 11.............. 11.............. 11..............
.......111.11111 1111111111111111 1111111111111111 1111111111111111 ................ .11............. .11............. .11.............
..........1.1111 1111111111111111 1111111111111111 1111111111111111 ................ ..11............ ..11............ ..11............
...........1.111 1111111111111111 1111111111111111 1111111111111111 ................ ...11........... ...11........... ...11...........
............1.11 1111111111111111 1111111111111111 1111111111111111 ................ ....11.......... ....11.......... ....11..........
.............1.1 1111111111111111 1111111111111111 1111111111111111 ................ .....11......... .....11......... .....11.........
..............1. 1111111111111111 1111111111111111 1111111111111111 ................ ......11........ ......11........ ......11........
...............1 .111111111111111 1111111111111111 1111111111111111 ................ .......11....... .......11....... .......11.......
................ 1.11111111111111 1111111111111111 1111111111111111 ................ ........11...... ........11...... ........11......
................ .1.1111111111111 1111111111111111 1111111111111111 ................ .........11..... .........11..... .........11.....
................ ..1.111111111111 1111111111111111 1111111111111111 ................ ..........11.... ..........11.... ..........11....
................ ...1.11111111111 1111111111111111 1111111111111111 ................ ...........11... ...........11... ...........11...
................ ....1.1111111111 1111111111111111 1111111111111111 ................ ............11.. ............11.. ............11..
................ .....1.111111111 1111111111111111 1111111111111111 ................ .............11. .............11. .............11.
................ ......1.11111111 1111111111111111 1111111111111111 ................ ..............11 ..............11 ..............11
................ .......1.1111111 1111111111111111 1111111111111111 ................ ...............1 1..............1 1..............1
.......111...... ........1.111111 1111111111111111 1111111111111111 ................ ................ 11.............. 11..............
.......1111..... .........1.11111 1111111111111111 1111111111111111 ................ ................ .11............. .11.............
..........11.... ..........1.1111 1111111111111111 1111111111111111 ................ ................ ..11............ ..11............
...........11... ...........1.111 1111111111111111 1111111111111111 ................ ................ ...11........... ...11...........
............11.. ............1.11 1111111111111111 1111111111111111 ................ ................ ....11.......... ....11..........
.............11. .............1.1 1111111111111111 1111111111111111 ................ ................ .....11......... .....11.........
..............11 ..............1. 1111111111111111 1111111111111111 ................ ................ ......11........ ......11........
...............1 1..............1 .111111111111111 1111111111111111 ................ ................ .......11....... .......11.......
................ 11.............. 1.11111111111111 1111111111111111 ................ ................ ........11...... ........11......
................ .11............. .1.1111111111111 1111111111111111 ................ ................ .........11..... .........11.....
................ ..11............ ..1.111111111111 1111111111111111 ................ ................ ..........11.... ..........11....
................ ...11........... ...1.11111111111 1111111111111111 ................ ................ ...........11... ...........11...
................ ....11.......... ....1.1111111111 1111111111111111 ................ ................ ............11.. ............11..
................ .....11......... .....1.111111111 1111111111111111 ................ ................ .............11. .............11.
................ ......11........ ......1.11111111 1111111111111111 ................ ................ ..............11 ..............11
................ .......11....... .......1.1111111 1111111111111111 ................ ................ ...............1 1..............1
.......111...... ........11...... ........1.111111 1111111111111111 ................ ................ ................ 11..............
.......1111..... .........11..... .........1.11111 1111111111111111 ................ ................ ................ .11.............
..........11.... ..........11.... ..........1.1111 1111111111111111 ................ ................ ................ ..11............
...........11... ...........11... ...........1.111 1111111111111111 ................ ................ ................ ...11...........
............11.. ............11.. ............1.11 1111111111111111 ................ ................ ................ ....11..........
.............11. .............11. .............1.1 1111111111111111 ................ ................ ................ .....11.........
..............11 ..............11 ..............1. 1111111111111111 ................ ................ ................ ......11........
...............1 1..............1 1..............1 .111111111111111 ................ ................ ................ .......11.......
................ 11.............. 11.............. 1.11111111111111 ................ ................ ................ ........11......
................ .11............. .11............. .1.1111111111111 ................ ................ ................ .........11.....
................ ..11............ ..11............ ..1.111111111111 ................ ................ ................ ..........11....
................ ...11........... ...11........... ...1.11111111111 ................ ................ ................ ...........11...
................ ....11.......... ....11.......... ....1.1111111111 ................ ................ ................ ............11..
................ .....11......... .....11......... .....1.111111111 ................ ................ ................ .............11.
................ ......11........ ......11........ ......1.11111111 ................ ................ ................ ..............11
................ .......11....... .......11....... .......1.1111111 ................ ................ ................ ...............1
.......111...... ........11...... ........11...... ........1.111111 ................ ................ ................ ................
.......1111..... .........11..... .........11..... .........1.11111 ................ ................ ................ ................
.........11..... .........11..... .........11..... .........1.11111 ................ ................ ................ ................</span></p>
<p>The left half of the output above shows the contents of AR throughout the progress of the multiply, and the
right half shows the contents of QR.  The most significant 57 bits of each are shown, right justified in a
64-bit field.</p>
<p>In the FP11, as the multiplication proceeds, the multiplicand is held constant, while the multiplier (in QR)
and partial product (in AR) are successively right shifted.  The bits of the multiplier involved in the
skip-over-ones-and-zeros sate macheine are QR3 and QR2.  QR3 is the rightmost bit shown above.  QR2, to its
right, is not retrievable by software and thus not shown.</p>
<p>Since the multiplicand in the sample code is 1.0, the result left in AR (bottom row of left half) should be
identical with the initial value of the multiplier in QR (top row of right half), but clearly something is
amiss with the least significant bits of the result.  We can also see that things go awry as the first
string off consecutive 1s starts through the state machine (adjusting the values in the test program shows
that this is always the case).  So this looks like an issue with the state machine or the FALU control
signals that derive from it.  Taking a look with the logic analyzer shows this:</p>
<p><img src='/images/pdp11/multiply-trace.jpg'/></p>
<p>This is a portion of the multiply dealing with the a string of two consecutive 1s on the multiplier.
The clocking and state machine state bits look correct (note that AR clocks falling edges).
A four-cycle pause is inserted in the AR clock whenever the state-machine dictates either an add
or a subtract is to occur, in order to allow for propagation time through the ALUs.  The AR and ALU function
selects  also look correct: AR 1 for shift, 3 for load, and ALU 6 for subtract, 9 for add.  Marker X here
should be clocking in a subtraction at the start of the string, followed by two shifts, then an add at
marker O at the end of the string.</p>
<p>But the ALU CIN control signal looks incorrect -- it is held high throughout the multiply, but should be
driven low for the subtraction at marker X.  This means the ALU function actually being selected is A-B-1
instead of A-B, which would produce the results seen above (the first subtract borrows an extra 1 all the
way across the partial product, then subsequent subtracts borrow from the resulting 1s on the right).
So it looks like the logic that generates CIN needs a look:</p>
<p><img src='/images/pdp11/cin-logic.png'/></p>
<p>Stepping through the multiply with the KM11 in single-clock-transition mode, arriving at the first
subtract, FRMH MUL SUB L is asserted low to pin 3 of E21, but pin 6 does not go high.  Looks like a
failed gate; pulled the part, put in a socket, and put a replacement 74H10 on order.  All for now!</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-12.html"><h1>PDP-11/45: Diagnostics XII - FP11 FPU, cont.</h1></a>
Sun 30 October 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Some spare 74194 arrived in the mail; popped one in to the socket I had prepared at E15 on the FRL board,
and the FP add/subtract problem is fixed.  The following FP11 diagnostics now pass:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>CFPAB0.BIC</td><td>LDFPS,STFPS,SETI,SETL,SETF,SETD,CFCC</td><td>pass</td></tr>
<tr><td>CFPBB0.BIC</td><td>STST</td><td>pass</td></tr>
<tr><td>CFPCD0.BIC</td><td>LDF,LDD,STF,STD</td><td>pass</td></tr>
<tr><td>CFPDC0.BIC</td><td>ADDF,ADDD,SUBF,SUBD</td><td>pass</td></tr>
<tr><td>CFPEB0.BIC</td><td>CMPF,CMPD</td><td>pass</td></tr>
<tr><td>CFPFB0.BIC</td><td>MULF,MULD</td><td>pass</td></tr>
<tr><td>CFPGC0.BIC</td><td>DIVF,DIVD</td><td>pass</td></tr>
<tr><td>CFPHB0.BIC</td><td>CLR,TST,ABS,NEG</td><td>pass</td></tr>
<tr><td>CFPIB0.BIC</td><td>LDCDF,LDCFD,STCFD,STCDF</td><td>pass</td></tr>
<tr><td>CFPJB0.BIC</td><td>LDCJX,STCXJ</td><td>pass</td></tr>
<tr><td>CFPKB0.BIC</td><td>LDEXP</td><td>pass</td></tr>
<tr><td>CFPMB0.BIC</td><td>MAINT</td><td>pass</td></tr>
</tbody>
</table>

<p>...which is almost everything.  The last failing diagnostic is CFPLB0, which tests MODF and MODD.  Set up
a similar test program for this instruction:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="nt">000000</span>                          <span class="nt">AC0</span><span class="o">=%</span><span class="nt">0</span>
        <span class="nt">000001</span>                          <span class="nt">AC1</span><span class="o">=%</span><span class="nt">1</span>
<span class="nt">000000</span>                                  <span class="p">.</span><span class="nc">ASECT</span>
        <span class="nt">001000</span>                          <span class="o">.=</span><span class="nt">1000</span>
<span class="nt">001000</span>  <span class="nt">170011</span>                  <span class="nt">START</span><span class="o">:</span>  <span class="nt">SETD</span>                <span class="o">;</span><span class="nt">SET</span> <span class="nt">DOUBLE</span> <span class="nt">PRECISION</span> <span class="nt">MODE</span>
<span class="nt">001002</span>  <span class="nt">172467</span>  <span class="nt">000020</span>                  <span class="nt">LDD</span>     <span class="nt">D1</span><span class="o">,</span><span class="nt">AC0</span>      <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">FIRST</span> <span class="nt">OPERAND</span> <span class="nt">FROM</span> <span class="nt">D1</span>
<span class="nt">001006</span>  <span class="nt">172567</span>  <span class="nt">000024</span>                  <span class="nt">LDD</span>     <span class="nt">D2</span><span class="o">,</span><span class="nt">AC1</span>      <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">SECOND</span> <span class="nt">OPERAND</span> <span class="nt">FROM</span> <span class="nt">D2</span>
<span class="nt">001012</span>  <span class="nt">171401</span>                          <span class="nt">MODD</span>    <span class="nt">AC1</span><span class="o">,</span><span class="nt">AC0</span>     <span class="o">;</span><span class="nt">MOD</span> <span class="o">(</span><span class="nt">FRAC</span> <span class="nt">IN</span> <span class="nt">AC0</span><span class="o">,</span> <span class="nt">INT</span> <span class="nt">IN</span> <span class="nt">AC1</span><span class="o">)</span>
<span class="nt">001014</span>  <span class="nt">174067</span>  <span class="nt">000026</span>                  <span class="nt">STD</span>     <span class="nt">AC0</span><span class="o">,</span><span class="nt">D3</span>      <span class="o">;</span><span class="nt">STORE</span> <span class="nt">FRAC</span> <span class="nt">TO</span> <span class="nt">D3</span>
<span class="nt">001020</span>  <span class="nt">174167</span>  <span class="nt">000032</span>                  <span class="nt">STD</span>     <span class="nt">AC1</span><span class="o">,</span><span class="nt">D4</span>      <span class="o">;</span><span class="nt">STORE</span> <span class="nt">INT</span> <span class="nt">TO</span> <span class="nt">D4</span>
<span class="nt">001024</span>  <span class="nt">000000</span>                          <span class="nt">HALT</span>
<span class="nt">001026</span>  <span class="nt">040200</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D1</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">040200</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span> <span class="o">;</span><span class="nt">1</span><span class="p">.</span><span class="nc">0</span>
<span class="nt">001034</span>  <span class="nt">000000</span>
<span class="nt">001036</span>  <span class="nt">040300</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D2</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">040300</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span> <span class="o">;</span><span class="nt">1</span><span class="p">.</span><span class="nc">5</span>
<span class="nt">001044</span>  <span class="nt">000000</span>
<span class="nt">001046</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D3</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span>
<span class="nt">001054</span>  <span class="nt">000000</span>
<span class="nt">001056</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D4</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span>
<span class="nt">001064</span>  <span class="nt">000000</span>
        <span class="nt">001000</span>                          <span class="p">.</span><span class="nc">END</span>    <span class="nt">START</span>
</pre></div>
</td></tr></table>

<p>This does show a problem: after exection, the integer result at D4 seems correct, but the fractional result
in D3 is incorrect (037777 177777 177777 177777).  Verified the correct microflow with the KM11.</p>
<p>Stopped in microstate MOD.22, and examined ALUs on FRL where the fractional result is masked.  ALU function
selects (for A &amp; ~B) and B inputs (all zeros for mask) look correct throughout.  A inputs, however,
are all ones except the least significant bit, which seems incorrect.  All for now -- will dig a little deeper on the microcode flows and follow up on this lead next time...</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-11.html"><h1>PDP-11/45: Diagnostics XI - FP11 FPU, cont.</h1></a>
Sun 23 October 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Wrote some small test programs to investigate FP add/subtract.  Turns out that single-precision add/subtract
works fine, but double-precision results come back with some erroneous bits set in the fraction.
Here's the test code I ended up using for troublshooting -- when executed on my machine, bits 24 and 25
end up incorrectly set in the result at D3:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="nt">000000</span>                          <span class="nt">AC0</span><span class="o">=%</span><span class="nt">0</span>
        <span class="nt">000001</span>                          <span class="nt">AC1</span><span class="o">=%</span><span class="nt">1</span>
<span class="nt">000000</span>                                  <span class="p">.</span><span class="nc">ASECT</span>
        <span class="nt">001000</span>                          <span class="o">.=</span><span class="nt">1000</span>
<span class="nt">001000</span>  <span class="nt">170011</span>                  <span class="nt">START</span><span class="o">:</span>  <span class="nt">SETD</span>                <span class="o">;</span><span class="nt">SET</span> <span class="nt">DOUBLE</span> <span class="nt">PRECISION</span> <span class="nt">MODE</span>
<span class="nt">001002</span>  <span class="nt">172467</span>  <span class="nt">000014</span>                  <span class="nt">LDD</span>     <span class="nt">D1</span><span class="o">,</span><span class="nt">AC0</span>      <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">FIRST</span> <span class="nt">ADDEND</span> <span class="nt">FROM</span> <span class="nt">D1</span>
<span class="nt">001006</span>  <span class="nt">172567</span>  <span class="nt">000020</span>                  <span class="nt">LDD</span>     <span class="nt">D2</span><span class="o">,</span><span class="nt">AC1</span>      <span class="o">;</span><span class="nt">FETCH</span> <span class="nt">SECOND</span> <span class="nt">ADDEND</span> <span class="nt">FROM</span> <span class="nt">D2</span>
<span class="nt">001012</span>  <span class="nt">172100</span>                          <span class="nt">ADDD</span>    <span class="nt">AC0</span><span class="o">,</span><span class="nt">AC1</span>     <span class="o">;</span><span class="nt">ADD</span> <span class="nt">THEM</span> <span class="o">(</span><span class="nt">RESULT</span> <span class="nt">IN</span> <span class="nt">AC1</span><span class="o">)</span>
<span class="nt">001014</span>  <span class="nt">174167</span>  <span class="nt">000022</span>                  <span class="nt">STD</span>     <span class="nt">AC1</span><span class="o">,</span><span class="nt">D3</span>      <span class="o">;</span><span class="nt">STORE</span> <span class="nt">RESULT</span> <span class="nt">TO</span> <span class="nt">D3</span>
<span class="nt">001020</span>  <span class="nt">000000</span>                          <span class="nt">HALT</span>
<span class="nt">001022</span>  <span class="nt">040200</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D1</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">040000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span> <span class="o">;</span><span class="nt">0</span><span class="p">.</span><span class="nc">5</span>
<span class="nt">001030</span>  <span class="nt">000000</span>
<span class="nt">001032</span>  <span class="nt">040200</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D2</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">040000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span> <span class="o">;</span><span class="nt">0</span><span class="p">.</span><span class="nc">5</span>
<span class="nt">001040</span>  <span class="nt">000000</span>
<span class="nt">001042</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">000000</span>  <span class="nt">D3</span><span class="o">:</span>     <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span><span class="o">,</span><span class="nt">000000</span>
<span class="nt">001050</span>  <span class="nt">000000</span>
        <span class="nt">001000</span>                          <span class="p">.</span><span class="nc">END</span>    <span class="nt">START</span>
</pre></div>
</td></tr></table>

<p>So, the usual procedure: KM11 in the floating point slot, and FRL (where these bits are handled) out on
extenders.  First step is to verify the microcode sequencing with the KM11 and front panel, and it looks good.
In particular, the FPU is sequencing through states ADD.04 and ADD.06 per expectation for double-precision,
branching correctly for non-zero operands, and taking the equal exponents branch through ADD.24 (refer to
page FLOWS 8 of the FP11 engineering drawings).</p>
<p>Next, stopped in state ADD.38, where the fraction addition occurs, and scanned the inputs and outputs of
all the 74181 bitslice ALUs with a logic probe. Bit 28 of the A input to the FALU (E16 pin 2, refer to page
FRLJ of the FP11 engineering drawings) is incorrectly set.  This is arriving via the AR register.</p>
<p>The value in the AR register is originally fetched from the register scratchpad, then flows through QR, BR,
and the FALU during microstates ADD.04, ADD.06, and ADD.02.  Some more stepping and logic probe work showed
that the fraction values are correct along these paths through these states.  So it looks like AR itself
may be at fault.</p>
<p>Set up the logic analyzer on E15, which is a 74194 shift-register that holds bits 28-31 of AR.  It looks
like it is indeed faulty:</p>
<p><img src='/images/pdp11/bad-ar.jpg'/></p>
<p>Here we can see what should be a broadside load: positive CLK edge, S0 and S1 both asserted, and inputs of
all zeros.  But the output sticks brokenly at 8.  Pulled this shift register, soldered in a socket, and put
a replacement and a couple of spares on order.  All for now, until the parts arrive.</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-10.html"><h1>PDP-11/45: Diagnostics X - FP11 FPU, cont.</h1></a>
Sat 01 October 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Okay, here's the dig in on the FP11 STST diagnostic failure.  As detailed previously, I'd been seeing an
incorrect FEC after executing a small test program to generate a minus-zero condition.  I'd verified that
the microcode sequence was per expectation, and that the correct FEC was being stored and retrieved from
AC7[1:0] in microstates TRP.50 and the start of TRP.60.</p>
<p>The end of TCP.60 and all of state TRP.70 are used to move the FEC and FEA from AC7[1:0] to AC7[3:2] via QR
and BR, and something was going awry here.  Since the nominal FEC is octal 14, I decided just to trace the
four least significant bits.  Consulting the engineering drawings, the nominal flow of these bits through
logic on the FRL during these states would be:</p>
<style>
.logiclist { display: inline; border-collapse: collapse; margin-right: 1em; }
.logiclist caption { font-weight: bold; }
.logiclist tr:nth-child(4n+2), .logiclist tr:nth-child(4n+3) { background-color: #f2f2f2; }
.logiclist .microstate { background-color: #ffffff; }
.logiclist th, .logiclist td { padding: 5px; }
.logiclist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="logiclist">
<thead>
<tr><th>Function</th><th>Package</th><th>Dir</th><th colspan="4">Pin:Level</th><th>Microstate</th></tr>
</thead>
<tbody>
<tr><td>ACi&lt;03:00&gt;</td><td>E85</td><td>out</td><td>11:H</td><td>9:H</td><td>7:L</td><td>5:L</td><td class="microstate" rowspan="2">TRP.60 (2)</td></tr>
<tr><td>QR&lt;06:03&gt;</td><td>E74</td><td>in</td><td>3:H</td><td>4:H</td><td>5:L</td><td>6:L</td></tr>
<tr><td></td><td></td><td>out</td><td>15:H</td><td>14:H</td><td>13:L</td><td>12:L</td><td class="microstate" rowspan="14">TRP.70 (3)</td></tr>
<tr><td>BR&lt;07:04&gt;</td><td>E75</td><td>in</td><td>13:H</td><td>12:H</td><td>4:L</td><td></td></tr>
<tr><td></td><td></td><td>out</td><td>15:H</td><td>10:H</td><td>2:L</td><td></td></tr>
<tr><td>BR&lt;03:00&gt;</td><td>E87</td><td>in</td><td></td><td></td><td></td><td>5:L</td></tr>
<tr><td></td><td></td><td>out</td><td></td><td></td><td></td><td>7:L</td></tr>
<tr><td>FALU&lt;07:04&gt;</td><td>E77</td><td>in</td><td>20:H</td><td>22:H</td><td>1:L</td><td></td></tr>
<tr><td></td><td></td><td>out</td><td>11:L</td><td>10:L</td><td>9:H</td><td></td></tr>
<tr><td>FALU&lt;03:00&gt;</td><td>E89</td><td>in</td><td></td><td></td><td></td><td>18:L</td></tr>
<tr><td></td><td></td><td>out</td><td></td><td></td><td></td><td>13:H</td></tr>
<tr><td>ACMX&lt;03:02&gt;</td><td>E83</td><td>in</td><td>13:L</td><td>3:L</td><td></td><td></td></tr>
<tr><td></td><td></td><td>out</td><td>9:L</td><td>7:L</td><td></td><td></td></tr>
<tr><td>ACMX&lt;01:00&gt;</td><td>E84</td><td>in</td><td></td><td></td><td>13:H</td><td>3:H</td></tr>
<tr><td></td><td></td><td>out</td><td></td><td></td><td>9:H</td><td>7:H</td></tr>
<tr><td>ACi&lt;03:00&gt;</td><td>E85</td><td>in</td><td>12:L</td><td>10:L</td><td>6:H</td><td>4:H</td></tr>
</tbody>
</table>

<p>Note that the bit values are inverted here by the FALU, since the reigster file used on the FP11 has
inverting outputs.</p>
<p>Threw the FRL out on extenders and starting verifying the chart above with a logic probe.  Surprisingly,
everything probed out correctly (?!)  Reset and ran the test program and verified that the bug had gone away.
Hmmm...  My only guess here is that there was some dust or a whisker shorting some of the pins that I
dislodged with the logic probe, or perhaps an oxidized board conection.  In any case, it seems to work
robustly now.  Of the FP11 diagnostics, the following now pass:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>CFPAB0.BIC</td><td>LDFPS,STFPS,SETI,SETL,SETF,SETD,CFCC</td><td>pass</td></tr>
<tr><td>CFPBB0.BIC</td><td>STST</td><td>pass</td></tr>
<tr><td>CFPCD0.BIC</td><td>LDF,LDD,STF,STD</td><td>pass</td></tr>
<tr><td>CFPHB0.BIC</td><td>CLR,TST,ABS,NEG</td><td>pass</td></tr>
<tr><td>CFPKB0.BIC</td><td>LDEXP</td><td>pass</td></tr>
</tbody>
</table>

<p>CFPDB0.BIC, which tests floating point adds/subtracts, is failing.  All for now -- on to debugging
add/subtract next time...</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/h720e-teardown.html"><h1>PDP-11/45: H720E teardown and inspection</h1></a>
Sun 18 September 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Started in on the H720E power supply that is part of RK05 storage system.  Just initial teardown, cleaning, and
inspection for obviously failed parts.  Looks pretty good, though there is a lot of dust and grime because this
unit lost its top cover plate somewhere over the years (I'll have to build some sort of replacement).</p>
<p>There are a couple of 22,000 mFD 50v electrolytic caps here that I'll try reforming before hitting them at full power,
since they've been sitting idle for upwards of 30yrs!  Also, one obviously leaking 330 mfd axial on regulator board, so
I'll replace this and all its identical twins.  Parts on order...</p>
<p><img src='/images/pdp11/h720e-breakdown_thumbnail_tall.jpg' title='Tearing down the H720E power supply for the RK11 storage controller' onclick='pswipe("pdp11",38);'/>
<img src='/images/pdp11/h720e-leaking-cap_thumbnail_tall.jpg' title='Leaking tantalum cap on H720e regulator board' onclick='pswipe("pdp11",39);'/></p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-9.html"><h1>PDP-11/45: Diagnostics IX - FP11 FPU, cont.</h1></a>
Sat 10 September 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Did a lot of reading on the FP11 design.  A few interesting notes that are buried in the maintenance manual:</p>
<ul>
<li>
<p>When debugging FP11 microcode with a KM11 in single-microstep mode, the 11/45 front panel microcode display shows
the address of the <em>next</em> microinstruction, NOT the current microinstruction.  This is because the stop-point for
single microinstruction is at a point between T2 and T3, just <em>after</em> the next microinstruction addr has been
calculated.  This is different behavior than the 11/45 CPU front panel microaddress display.</p>
</li>
<li>
<p>There's a note in the maintenance manual that explicitly cautions that when using extender boards for debug, the
RC maintenance clock should be used, and set with period &gt;50ns.  I had not been doing similar while debugging the
KB11-A CPU, and maybe this explains the occasional different behavior I'd see when throwing boards out on extenders...
In particular, I had seen this when debugging a spare CPU GRA; next time I return to that board I will try the CPU
RC clock.</p>
</li>
</ul>
<p>Okay, so here's my first simple test program for STST:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">000000</span>                          <span class="nt">AC0</span><span class="o">=%</span><span class="nt">0</span>
<span class="nt">000000</span>                          <span class="p">.</span><span class="nc">ASECT</span>
<span class="nt">001000</span>                          <span class="o">.=</span><span class="nt">1000</span>
<span class="nt">001000</span>  <span class="nt">170127</span>  <span class="nt">044000</span>  <span class="nt">START</span><span class="o">:</span>  <span class="nt">LDFPS</span>   <span class="p">#</span><span class="nn">044000</span>         <span class="o">;</span><span class="nt">FID</span><span class="o">+</span><span class="nt">FIUV</span>
<span class="nt">001004</span>  <span class="nt">172467</span>  <span class="nt">000004</span>          <span class="nt">LDF</span>     <span class="nt">NEGZ</span><span class="o">,</span><span class="nt">AC0</span>        <span class="o">;</span><span class="nt">LOAD</span> <span class="nt">A</span> <span class="nt">MINUS-ZERO</span>
<span class="nt">001010</span>  <span class="nt">170300</span>                  <span class="nt">STST</span>    <span class="nt">R0</span>              <span class="o">;</span><span class="nt">STORE</span> <span class="nt">FEC</span> <span class="nt">TO</span> <span class="nt">R0</span>
<span class="nt">001012</span>  <span class="nt">000000</span>                  <span class="nt">HALT</span>
<span class="nt">001014</span>  <span class="nt">100000</span>  <span class="nt">000000</span>  <span class="nt">NEGZ</span><span class="o">:</span>   <span class="p">.</span><span class="nc">WORD</span>   <span class="nt">100000</span><span class="o">,</span><span class="nt">000000</span>   <span class="o">;</span><span class="nt">MINUS-ZERO</span>
<span class="nt">001000</span>                          <span class="p">.</span><span class="nc">END</span>    <span class="nt">START</span>
</pre></div>
</td></tr></table>

<p>This would be expected to produce the 000014 "Floating Undefined Variable" (minus-zero) exception code in R0, but I see
an incorrect value of 177417.  Using the KM11 on the FPU shows the -0 trap and STST microstate flow is per expectation.</p>
<p>Put the FRL out on the extender and started stepping the microcode, examining the state of the pins at the AC register
file along the way.  In the -0 trap flow, the FEC code 000014 presented (inverted) at TRP.50 via the EALU, and
subsequently retrieved at TRP.60 looks correct. However, the value presented at TRP.70 via QR, BR, and the FALU does
not.  Out of time this weekend; Will have to chase signals back through those paths next time!</p>
<p><img src='/images/pdp11/minus-zero-microcode.png'/></p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-8.html"><h1>PDP-11/45: Diagnostics VIII - FP11 FPU</h1></a>
Sat 03 September 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Slotted in FP11 spares that I hadn't tried previously, and this has produced some improved results -- returning to
diagnostic CKBME0 (11/45 traps) this now passes with the floating point installed.  Additionally, diagnostic
CFPAB0 passes.</p>
<p>CFPBB0 and CFPCD0, however, are failing.  Unfortunately, the source code for these is not available in the PDP-11
diagnostics database at retrocmp.  The names of the diagnostics tell which instructions they are testing, though.
CFPBB0 is annotated as testing the STST instruction.  Rather than work through disassembling the rather lengthy
diagnostics, I'll probably just write some simple test programs around the STST instruction for next time.  In the
meantime, I'll do some reading on the FP11 in preparation for microcode-step debug.</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-7.html"><h1>PDP-11/45: Diagnostics VII - KT11 MMU</h1></a>
Sat 13 August 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Moving on to the KT11 MMU: running the first diagnostic in the CKT suite, got error reports at 010340, 010560, and
011000.  Consulted the diagnostic listings, and these particular tests have to do with D-space translations from
kernel, supervisor, and user modes.  The D-space logic is largely on module SSR, so I swapped this out for a spare.
After that, I was able to pass the full suite of basic MMU tests:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>BEL</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>CKTAB0.BIC</td><td>017412</td><td>KT11-C basic logic part 1</td><td>pass</td></tr>
<tr><td>CKTBC0.BIC</td><td>015674</td><td>KT11-C basic logic part 2</td><td>pass</td></tr>
<tr><td>CKTCA0.BIC</td><td>023304</td><td>KT11-C access keys</td><td>pass</td></tr>
<tr><td>CKTDA0.BIC</td><td>016360</td><td>KT11-C MTPD and MTPI</td><td>pass</td></tr>
<tr><td>CKTEB0.BIC</td><td>015310</td><td>KT11-C MFPD and MFPI</td><td>pass</td></tr>
<tr><td>CKTFD0.BIC</td><td>016422</td><td>KT11-C aborts</td><td>pass</td></tr>
</tbody>
</table>

<p>Put the failing SSE module in the repair queue along with the other failed spares I've identified along the way, and
will return to troubleshoot/repair it later.  For now, things are looking pretty good with the CPU!  I still need to
run and pass the more heavyweight diagnostics: the 11/45 instruction exerciser, KT11 exerciser, and MS11-L exerciser.
All three of these still seem to have halts, but they are quite complicated diagnostics in comparison to the rest,
making use of additional peripherals, etc.  I'll need to study these a bit before I can be sure I am using them
correctly.  I have also skipped the power fail diagnostics for now as I will need to restore some core memory in order
for these to work correctly.</p>
<p>Next up will be to work on the FPU...</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-6.html"><h1>PDP-11/45: Diagnostics VI - GRA ALU PROM repair</h1></a>
Sun 07 August 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Data I/O Series 22 PROM programmer from eBay showed up, as well as some unprogrammed Signetics 82S123.  Punched in the
subsidiary ALU control ROM contents from the listing on GRAK in the 11/45 engineering drawings and burnt a new PROM.
Put a socket and the new PROM in place of the failed part on my original GRA, slotted it into the CPU, and success!
Diagnostic CKBOA0 now passes.  I will probably return to the other faulty GRA at a later point, as it is partially
diagnosed and I like to have spares working and ready to go.</p>
<p>Next time I'll be moving on to the CKT series of tests for the KT11 memory management cards...</p>
<p><img src='/images/pdp11/prom-programmer_thumbnail_tall.jpg' title='Data I/O series 22 PROM programmer, arrived from eBay' onclick='pswipe("pdp11",36);'/>
<img src='/images/pdp11/alu-prom-replaced_thumbnail_tall.jpg' title='GRA board with replaced ALU PROM' onclick='pswipe("pdp11",37);'/></p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-5.html"><h1>PDP-11/45: Diagnostics V - D0AA0-D0MA0, CKBOA0</h1></a>
Sun 31 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>The day gig has been keeping me pretty busy for the last couple of weeks, but had some time to work on the PDP-11
again this weekend, so here's an update.</p>
<p>Looking a little deeper at the diagnostics database over on retrocmp.com, I realized that I had skipped the entire
set of generic 11-family "D0" tests.  Downloaded and ran these via PDP11GUI and they all passed.  BEL character
patch locations, as described previously, are summarized here for future reference:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>BEL</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>D0AA0.BIN</td><td>014212</td><td>Branch</td><td>pass</td></tr>
<tr><td>D0BA0.BIN</td><td>004336</td><td>Con branch</td><td>pass</td></tr>
<tr><td>D0CA0.BIN</td><td>005526</td><td>Unary</td><td>pass</td></tr>
<tr><td>D0DA0.BIN</td><td>016370</td><td>Binary</td><td>pass</td></tr>
<tr><td>D0EA0.BIN</td><td>010562</td><td>Rotate/shift</td><td>pass</td></tr>
<tr><td>D0FA0.BIN</td><td>017224</td><td>CMP equality</td><td>pass</td></tr>
<tr><td>D0GA0.BIN</td><td>013650</td><td>CMP non-equality</td><td>pass</td></tr>
<tr><td>D0HA0.BIN</td><td>013434</td><td>Move</td><td>pass</td></tr>
<tr><td>D0IA0.BIN</td><td>014126</td><td>Bit set clear test</td><td>pass</td></tr>
<tr><td>D0JA0.BIN</td><td>007472</td><td>Add</td><td>pass</td></tr>
<tr><td>D0KA0.BIN</td><td>007124</td><td>Subtract</td><td>pass</td></tr>
<tr><td>D0LA0.BIN</td><td>015722</td><td>Jump</td><td>pass</td></tr>
<tr><td>D0MA0.BIN</td><td>003250</td><td>JSR RTS RTI</td><td>pass</td></tr>
</tbody>
</table>

<p>Of the "CKB" series of tests, CKBOA0 (11/45 states) is the only one I that is not yet passing.  Looking into
this a little further, the first failing sub-test is T65:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">010540</span> <span class="nt">010701</span>                  <span class="nt">T65</span><span class="o">:</span>    <span class="nt">SCOPE</span>                    <span class="o">;</span>
<span class="nt">010542</span> <span class="nt">012737</span>  <span class="nt">030000</span>  <span class="nt">177776</span>          <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">PUM</span><span class="o">,@</span><span class="p">#</span><span class="nn">PSW</span>       <span class="o">;</span><span class="nt">KERNEL</span> <span class="nt">MODE</span><span class="o">,</span> <span class="nt">PREV</span> <span class="nt">USER</span> <span class="nt">MODE</span>
<span class="nt">010550</span> <span class="nt">012706</span>  <span class="nt">000500</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">KPTR</span><span class="o">,</span><span class="nt">KSP</span>        <span class="o">;</span><span class="nt">SET</span> <span class="nt">KERNEL</span> <span class="nt">STACK</span> <span class="nt">POINTER</span>
<span class="nt">010554</span> <span class="nt">012716</span>  <span class="nt">000700</span>                  <span class="nt">MOV</span>     <span class="p">#</span><span class="nn">UPTR</span><span class="o">,(</span><span class="nt">KSP</span><span class="o">)</span>
<span class="nt">010560</span> <span class="nt">106606</span>                          <span class="nt">MTPD</span>    <span class="nt">USP</span>              <span class="o">;</span><span class="nt">SET</span> <span class="nt">USER</span> <span class="nt">STATCK</span> <span class="nt">POINTER</span>
<span class="nt">010562</span> <span class="nt">005067</span>  <span class="nt">170110</span>                  <span class="nt">CLR</span>     <span class="nt">UPTR-2</span>
<span class="nt">010566</span> <span class="nt">052737</span>  <span class="nt">140000</span>  <span class="nt">177776</span>          <span class="nt">BIS</span>     <span class="p">#</span><span class="nn">UM</span><span class="o">,@</span><span class="p">#</span><span class="nn">PSW</span>        <span class="o">;</span><span class="nt">USER</span> <span class="nt">MODE</span><span class="o">,</span> <span class="nt">PREV</span> <span class="nt">USER</span> <span class="nt">MODE</span>
<span class="nt">010574</span> <span class="nt">106506</span>                          <span class="nt">MFPD</span>    <span class="nt">USP</span>              <span class="o">;</span><span class="nt">PUSH</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">ONTO</span> <span class="nt">USER</span> <span class="nt">STACK</span>
<span class="nt">010576</span> <span class="nt">042737</span>  <span class="nt">140000</span>  <span class="nt">177776</span>          <span class="nt">BIC</span>     <span class="p">#</span><span class="nn">UM</span><span class="o">,@</span><span class="p">#</span><span class="nn">PSW</span>        <span class="o">;</span><span class="nt">KERNEL</span> <span class="nt">MODE</span><span class="o">,</span> <span class="nt">PREV</span> <span class="nt">USER</span> <span class="nt">MODE</span>
<span class="nt">010604</span> <span class="nt">106506</span>                          <span class="nt">MFPD</span>    <span class="nt">USP</span>              <span class="o">;</span><span class="nt">PUSH</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">ONTO</span> <span class="nt">KERNEL</span> <span class="nt">STACK</span>
<span class="nt">010606</span> <span class="nt">022716</span>  <span class="nt">000676</span>                  <span class="nt">CMP</span>     <span class="p">#</span><span class="nn">UPTR-2</span><span class="o">,(</span><span class="nt">KSP</span><span class="o">)</span>    <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">THAT</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">WAS</span>
<span class="nt">010612</span> <span class="nt">001401</span>                          <span class="nt">BEQ</span>     <span class="o">.+</span><span class="nt">4</span>              <span class="o">;</span><span class="nt">PUSHED</span> <span class="nt">PROPERLY</span> <span class="o">(</span><span class="nt">ONCE</span><span class="o">)</span>
<span class="nt">010614</span> <span class="nt">000000</span>                          <span class="nt">HLT</span>                      <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span>
<span class="nt">010616</span> <span class="nt">022767</span>  <span class="nt">000700</span>  <span class="nt">170052</span>          <span class="nt">CMP</span>     <span class="p">#</span><span class="nn">UPTR</span><span class="o">,</span><span class="nt">UPTR-2</span>     <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">THAT</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">IS</span> <span class="nt">ON</span> <span class="nt">THE</span>
<span class="nt">010624</span> <span class="nt">001401</span>                          <span class="nt">BEQ</span>     <span class="o">.+</span><span class="nt">4</span>              <span class="o">;</span><span class="nt">USERS</span> <span class="nt">STACK</span>
<span class="nt">010626</span> <span class="nt">000000</span>                          <span class="nt">HLT</span>                      <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span>
</pre></div>
</td></tr></table>

<p>This runs amok on the MFPD instruction at 010574, which should push the user stack pointer onto the user stack.
Instead, the user stack pointer is pushed to memory at an incorrect address; 010676 instead of 000676.  This actually
overwrites subsequent test code. Since the value pushed is 000700, a hard-coded loop is created that prevents the
test from completing the pass even if resumed from halt.</p>
<p>The relevant states in the microcode flow here are MFP.80, MFP.90, and MFP.10:</p>
<p><img src='/images/pdp11/mfpd-microcode.png'/></p>
<p>Stopping at T2 of MFP.10 using the KM11, I can see that the correct value 000700 was fetched to DR (as displayed by
the console address lights), but the incorrect value of 010676 is appearing at the output of the ALU/shifter (as
displayed by the console data lights when set to data paths).  Throwing the DAP card out on extenders and taking
a look around with a logic probe revealed that the errant bit 12 is sourcing from the ALU.  At each slice of the ALU,
function selectors S3-S0 are correct, CIN is correct, and overall B-mux constant value "2" is correct.  The errant bit
is arriving to the ALU from the A-mux...</p>
<p>Chasing this upstream, A-mux selectors S1,S0 are correct, but the bad bit arrives to the mux input on GRAH SR12.  Hmmm,
maybe this is one of the things the "BAD" sticker on the GRA is referring to...  Next step is to throw the GRA on
the extender, and chase the signal back towards SR and the register files.  However, here I hit a snag: the M9301
monitor does not run correctly when the GRA is on the extender!  That's pretty weird.  Some investigation with the
KM11 and some hand-toggled instructions revealed that at least the Z status bit is not set correctly/reliably when
the card is on the extender.  Some of the Z bit logic lives on the GRA also, so I can take a look at that, but I am
now out of time for this weekend.  Next time!</p>
<p>A few other miscellaneous notes in wrap-up:</p>
<ul>
<li>
<p>I have been running with the spare GRA marked "BAD" because the first GRA I was using turned out to have a failed ALU
subsidiary PROM.  In the meantime I tracked down a PROM programmer and some compatible parts on eBay -- these should
arrive sometime this week at which point I should be able to repair the original board and give it another try.</p>
</li>
<li>
<p>The uPB feature of my home-brew KM11 really doesn't work quite right.  It often stops the machine at the requested
micro-state but on the wrong instruction (skipping the first occurrence of the target state seemingly).  This caused
me a great deal of confusion today, as I was stepping through flows at a different program location than I had assumed,
until I finally noticed the address lights on the console.</p>
</li>
<li>
<p>ESC key on the VT52 is non-functional, making it impractical to use for RT-11.  The key mechanism looks okay from the
top (thanks for more helpful advice from the vcfed forum!).  I think I'll need to pull the keyboard PCB and re-flow the
solder on the affected mechanism as a next step.</p>
</li>
<li>
<p>Looking forward to checking out Vintage Computer Fest West sometime next weekend!</p>
</li>
</ul></div>
    <hr />
</div>

<div class="pagination">
<ul>
    <li class="prev"><a href="http://fritzm.github.io/tag/retro-computing2.html">&larr; Previous</a></li>

    <li class=""><a href="http://fritzm.github.io/tag/retro-computing.html">1</a></li>
    <li class=""><a href="http://fritzm.github.io/tag/retro-computing2.html">2</a></li>
    <li class="active"><a href="http://fritzm.github.io/tag/retro-computing3.html">3</a></li>
    <li class=""><a href="http://fritzm.github.io/tag/retro-computing4.html">4</a></li>
    <li class=""><a href="http://fritzm.github.io/tag/retro-computing5.html">5</a></li>
    <li class=""><a href="http://fritzm.github.io/tag/retro-computing6.html">6</a></li>

    <li class="next"><a href="http://fritzm.github.io/tag/retro-computing4.html">Next &rarr;</a></li>

</ul>
</div>
  
        </div>

        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Site
                </li>

                <li><a href="http://fritzm.github.io/">Archives</a>
                <li><a href="http://fritzm.github.io/tags.html">Tags</a>



                <li><a href="http://fritzm.github.io/feeds/all.rss.xml" rel="alternate" type="application/rss+xml">RSS feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Categories
                </li>

                <li><a href="http://fritzm.github.io/category/math.html">Math</a></li>
                <li><a href="http://fritzm.github.io/category/pdp-11.html">PDP-11</a></li>
                <li><a href="http://fritzm.github.io/category/programming.html">Programming</a></li>
            </ul>
            </div>




            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Social
                </li>

                <li><a href="http://facebook.com/fritzmueller">facebook</a></li>
                <li><a href="http://twitter.com/infrafritz">twitter</a></li>
                <li><a href="http://instagram.com/infrafritz">Instagram</a></li>
                <li><a href="http://www.linkedin.com/pub/fritz-mueller/a/679/62/">LinkedIn</a></li>
                <li><a href="http://jsfiddle.net/user/fritzm/fiddles/">JSFiddle</a></li>
                <li><a href="https://github.com/fritzm">GitHub</a></li>
            </ul>
            </div>
            </div>

        </div>     </div>     </div> 
<footer>
<br />
<p><a href="http://fritzm.github.io">fritzm.github.io</a> &copy; Fritz Mueller 2012</p>
</footer>

</div> <!-- /container -->

<!-- Photoswipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
</body>
</html>