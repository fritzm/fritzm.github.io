<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>fritzm.github.io - PDP-11/45: Diagnostics III - CKBME0</title>
    <meta name="description" content="">
    <meta name="author" content="Fritz Mueller">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="https://fritzm.github.io/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="https://fritzm.github.io/theme/bootstrap.min.css" rel="stylesheet">
    <link href="https://fritzm.github.io/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="https://fritzm.github.io/theme/local.css" rel="stylesheet">
    <link href="https://fritzm.github.io/theme/pygments.css" rel="stylesheet">

    <!-- Photoswipe -->
    <link rel="stylesheet" href="https://fritzm.github.io/theme/photoswipe.css">
    <link rel="stylesheet" href="https://fritzm.github.io/theme/default-skin/default-skin.css">
    <script src="https://fritzm.github.io/theme/photoswipe.min.js"></script>
    <script src="https://fritzm.github.io/theme/photoswipe-ui-default.min.js"></script>
    <script src="https://fritzm.github.io/galleries.js"></script>
    <script type="text/javascript">
        var pswipe = function(gname, index) {
            var pswpElement = document.querySelectorAll('.pswp')[0];
            var items = galleries[gname];
            var options = { index: index };
            var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
            gallery.init();
        };
    </script>

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="https://fritzm.github.io/feeds/all.rss.xml" rel="alternate" title="fritzm.github.io" type="application/rss+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="https://fritzm.github.io">fritzm.github.io</a>

        <div class="nav-collapse">
        <ul class="nav">
            
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
    <div class='article'>
        <div class="content-title">
            <h1>PDP-11/45: Diagnostics III - CKBME0</h1>
Sat 09 July 2016

by <a class="url fn" href="https://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


        </div>
	
        <div><p>Okay, digging into the CKBME0 traps diagnostic now in more detail.  Here I've transcribed the source of the failing
test from the older available diagnostic listing, then re-assembled it at the address matching the more modern
binary.  This makes it a little easier to follow along while debugging the newer binary:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="err">013604 000230                          SPL     0               ;SET PRIORITY LEVEL 0</span>
<span class="err">013606 012706  000500                  MOV     #STKPTR,%6      ;SET STACK PTR</span>
<span class="err">013612 012737  013650  000064          MOV     #TTY7A,@#TPVEC  ;LOAD TTY INTERRUPT VECTOR</span>
<span class="err">013620 012737  013644  000014          MOV     #TTY7B,@#BPTVEC ;LOAD &#39;T&#39; BIT TRAP VECTOR</span>
<span class="err">013626 005002                          CLR     %2              ;CLEAR INDICATOR</span>
<span class="err">013630 052737  000100  177564          BIS     #100,@#TTCSR    ;ALLOW INTERRUPT INTERRUPT OCCURS AFTER</span>
<span class="err">                                                               ;THIS INSTRUCTION &amp; BEFORE NEXT</span>
<span class="err">013636 000001                  WAIT1:  WAIT                    ;WAIT FOR AN INTERRUPT</span>
<span class="err">013640 005202                          INC     %2              ;INCREMENT INDICATOR</span>
<span class="err">013642 000000                          HLT                     ;ERROR! NO &#39;T&#39; TRAP AFTER INTERRUPT</span>
<span class="err">013644 000000                  TTY7B:  HLT                     ;ERROR! &#39;T&#39; BIT TRAPPED OUT OF WAIT</span>
<span class="err">013646 000424                          BR      TTY7EX          ;EXIT TEST</span>
<span class="err">013650 012737  000040  177566  TTY7A:  MOV     #40,@#177566    ;TYPE SPACE CHAR</span>
<span class="err">013656 012737  013674  000064          MOV     #TTY7C,@#TPVEC  ;REPOSITION TTY INT VECTOR</span>
<span class="err">013664 012766  000020  000002          MOV     #20,2(6)        ;PUT &#39;T&#39; BIT IN RETURN STATUS</span>
<span class="err">013672 000006                          RTT                     ;RETURN TO WAIT WITH &#39;T&#39; BIT SET</span>
<span class="err">                                                               ;AND WAIT FOR TTY INTERRUPT WHEN NULL</span>
<span class="err">                                                               ;CHARACTER IS TYPED</span>
<span class="err">013674 012737  013716  000014  TTY7C:  MOV     #TTY7D,@#BPTVEC ;REPOINT &#39;T&#39; BIT TRAP VECTOR AFTER</span>
<span class="err">                                                               ;TTY HAS INTERRUPTED</span>
<span class="err">013702 005037  177564                  CLR     @#TTCSR         ;DISABLE INTERRUPT ENABLE</span>
<span class="err">013706 012737  000015  177566          MOV     #15,@#177566</span>
<span class="err">013714 000006                          RTT                     ;RETURN TO INST FOLLOWING WAIT WITH &#39;T&#39;</span>
<span class="err">                                                               ;BIT SET</span>
<span class="err">013716 000240                  TTY7D:  NOP</span>
<span class="err">013720 012737  000016  000014  TTY7EX: MOV     #BPTVEC+2,@#BPTVEC;RESTORE VECTORS TO HALT AT</span>
<span class="err">013726 012737  000066  000064          MOV     #66,@#TPVEC     ;VECTOR +2</span>
<span class="err">013734 005302                          DEC     %2              ;CHECK INDICATOR</span>
<span class="err">013736 001401                          BEQ     .+4</span>
<span class="err">013740 000000                          HLT                     ;ERROR! DID NOT DO INC INST AFTER INTERRUPT</span>
</code></pre></div>
</td></tr></table>

<p>This test seems to be designed to return from an interrupt handler to a WAIT instruction, with the T bit set in
the PSW and a serial xmit interrupt pending.  It verifies that the WAIT still "waits" in this circumstance.  It also
verifies that a trace trap <em>does</em> occur after the immediately following INC instruction when the xmit interrupt
subsequently terminates the WAIT.</p>
<p>One potential problem with this test concerns the apparent assumption that enabling the xmit interrupt will cause an
immediate trap before the subsequent WAIT instruction.  This is true if the serial transmitter is empty, but if the
transmitter is ever full/busy when this code is entered this assumption may not hold.  Not sure yet if this will ever
be a problem for this test given the surrounding code.</p>
<p>In any case, as currently written this routine fails about 50% of the time on my 11/45.  The failure mode
is that the processor sits at the WAIT instruction, (address display 013640, PC+2).  Intervention with the
console halt switch (halt then back to enabl) breaks the WAIT microcode loop; console cont then takes us to the halt
at 013740 (address display 013742, PC+2).</p>
<p>The fact that the routine is tailing out through the halt at 013740 without hitting the halts at 013642 or 013644 is
interesting; this implies that the second serial xmit interrupt to TTY7C has executed.  This is verified by examining
the break trap from the console after the test hangs up on the WAIT -- in the failure case, it is already reset to
point to TTY7D.  So the failure mode seems to be that the return from the second xmit interrupt sometimes goes to the
WAIT instead of the subsequent INC.</p>
<p>Here is the microcode flow around the WAIT instruction.  The horizontal line across the top is the A fork:</p>
<p><img src='/images/pdp11/wait-microcode.png'/></p>
<p>Using the KM11, in the failure case I can see the T bit set and the microcode looping through states WAT.00, WAT.20, WAT.30, WAT.11, which seems expected.  I have also verified that executing a WAIT <em>without</em> the T bit set
loops through states WAT.00 and WAT.10.</p>
<p>Lastly, running on the RC maintenance clock at about half the usual clock frequency makes the failure case happen
almost 100% of the time.</p>
<p>Next I'll be needing to learn more about the BRQ logic, and in particular the mechanism by which the second xmit
interrupt nominally causes INTRF to be asserted.  Understanding that should lead me to some things to check with the
logic probe and analyzer...</p></div>
	
        <hr>

    </div>
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="https://fritzm.github.io/archives.html">Archives</a>
                <li><a href="https://fritzm.github.io/tags.html">Tags</a>



                <li><a href="https://fritzm.github.io/feeds/all.rss.xml" rel="alternate">RSS feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="https://fritzm.github.io/category/math.html">Math</a></li>
                <li><a href="https://fritzm.github.io/category/pdp-11.html">PDP-11</a></li>
                <li><a href="https://fritzm.github.io/category/programming.html">Programming</a></li>
                   
            </ul>
            </div>




            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="http://facebook.com/fritzmueller">facebook</a></li>
                <li><a href="http://twitter.com/infrafritz">twitter</a></li>
                <li><a href="http://instagram.com/infrafritz">Instagram</a></li>
                <li><a href="http://www.linkedin.com/pub/fritz-mueller/a/679/62/">LinkedIn</a></li>
                <li><a href="http://jsfiddle.net/user/fritzm/fiddles/">JSFiddle</a></li>
                <li><a href="https://github.com/fritzm">GitHub</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="https://fritzm.github.io">fritzm.github.io</a> &copy; Fritz Mueller 2020</p>
</footer>

</div> <!-- /container -->

<!-- Photoswipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://fritzm.github.io/theme/bootstrap-collapse.js"></script>
 
</body>
</html>