<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>fritzm.github.io</title>
    <meta name="description" content="">
    <meta name="author" content="Fritz Mueller">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://fritzm.github.io/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://fritzm.github.io/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://fritzm.github.io/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://fritzm.github.io/theme/local.css" rel="stylesheet">
    <link href="http://fritzm.github.io/theme/pygments.css" rel="stylesheet">

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="feeds/all.atom.xml" rel="alternate" title="fritzm.github.io" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://fritzm.github.io">fritzm.github.io</a>

        <div class="nav-collapse">
        <ul class="nav">

        </ul>
        </div>

    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">


<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-7.html"><h1>PDP-11/45: Diagnostics VII - KT11 MMU</h1></a>
Sat 13 August 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Moving on to the KT11 MMU: running the first diagnostic in the CKT suite, got error reports at 010340, 010560, and
011000.  Consulted the diagnostic listings, and these particular tests have to do with D-space translations from
kernel, supervisor, and user modes.  The D-space logic is largely on module SSR, so I swapped this out for a spare.
After that, I was able to pass the full suite of basic MMU tests:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>BEL</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>CKTAB0.BIC</td><td>017412</td><td>KT11-C basic logic part 1</td><td>pass</td></tr>
<tr><td>CKTBC0.BIC</td><td>015674</td><td>KT11-C basic logic part 2</td><td>pass</td></tr>
<tr><td>CKTCA0.BIC</td><td>023304</td><td>KT11-C access keys</td><td>pass</td></tr>
<tr><td>CKTDA0.BIC</td><td>016360</td><td>KT11-C MTPD and MTPI</td><td>pass</td></tr>
<tr><td>CKTEB0.BIC</td><td>015310</td><td>KT11-C MFPD and MFPI</td><td>pass</td></tr>
<tr><td>CKTFD0.BIC</td><td>016422</td><td>KT11-C aborts</td><td>pass</td></tr>
</tbody>
</table>

<p>Put the failing SSE module in the repair queue along with the other failed spares I've identified along the way, and
will return to troubleshoot/repair it later.  For now, things are looking pretty good with the CPU!  I still need to
run and pass the more heavyweight diagnostics: the 11/45 instruction exerciser, KT11 exerciser, and MS11-L exerciser.
All three of these still seem to have halts, but they are quite complicated diagnostics in comparison to the rest,
making use of additional peripherals, etc.  I'll need to study these a bit before I can be sure I am using them
correctly.  I have also skipped the power fail diagnostics for now as I will need to restore some core memory in order
for these to work correctly.</p>
<p>Next up will be to work on the FPU...</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-6.html"><h1>PDP-11/45: Diagnostics VI - GRA ALU PROM repair</h1></a>
Sun 07 August 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Data I/O Series 22 PROM programmer from eBay showed up, as well as some unprogrammed Signetics 82S123.  Punched in the
subsidiary ALU control ROM contents from the listing on GRAK in the 11/45 engineering drawings and burnt a new PROM.
Put a socket and the new PROM in place of the failed part on my original GRA, slotted it into the CPU, and success!
Diagnostic CKBOA0 now passes.  I will probably return to the other faulty GRA at a later point, as it is partially
diagnosed and I like to have spares working and ready to go.</p>
<p>Next time I'll be moving on to the CKT series of tests for the KT11 memory management cards...</p>
<p><a href="http://fritzm.github.io/images/pdp11/prom-programmer.jpg"><img src='/images/pdp11/prom-programmer_thumbnail_tall.jpg'/></a>
<a href="http://fritzm.github.io/images/pdp11/alu-prom-replaced.jpg"><img src='/images/pdp11/alu-prom-replaced_thumbnail_tall.jpg'/></a></p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-5.html"><h1>PDP-11/45: Diagnostics V - D0AA0-D0MA0, CKBOA0</h1></a>
Sun 31 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>The day gig has been keeping me pretty busy for the last couple of weeks, but had some time to work on the PDP-11
again this weekend, so here's an update.</p>
<p>Looking a little deeper at the diagnostics database over on retrocmp.com, I realized that I had skipped the entire
set of generic 11-family "D0" tests.  Downloaded and ran these via PDP11GUI and they all passed.  BEL character
patch locations, as described previously, are summarized here for future reference:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>BEL</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>D0AA0.BIN</td><td>016370</td><td>Branch</td><td>pass</td></tr>
<tr><td>D0BA0.BIN</td><td>004336</td><td>Con branch</td><td>pass</td></tr>
<tr><td>D0CA0.BIN</td><td>005526</td><td>Unary</td><td>pass</td></tr>
<tr><td>D0DA0.BIN</td><td>016370</td><td>Binary</td><td>pass</td></tr>
<tr><td>D0EA0.BIN</td><td>010562</td><td>Rotate/shift</td><td>pass</td></tr>
<tr><td>D0FA0.BIN</td><td>017224</td><td>CMP equality</td><td>pass</td></tr>
<tr><td>D0GA0.BIN</td><td>013650</td><td>CMP non-equality</td><td>pass</td></tr>
<tr><td>D0HA0.BIN</td><td>013434</td><td>Move</td><td>pass</td></tr>
<tr><td>D0IA0.BIN</td><td>014126</td><td>Bit set clear test</td><td>pass</td></tr>
<tr><td>D0JA0.BIN</td><td>007472</td><td>Add</td><td>pass</td></tr>
<tr><td>D0KA0.BIN</td><td>007124</td><td>Subtract</td><td>pass</td></tr>
<tr><td>D0LA0.BIN</td><td>015722</td><td>Jump</td><td>pass</td></tr>
<tr><td>D0MA0.BIN</td><td>003250</td><td>JSR RTS RTI</td><td>pass</td></tr>
</tbody>
</table>

<p>Of the "CKB" series of tests, CKBOA0 (11/45 states) is the only one I that is not yet passing.  Looking into
this a little further, the first failing sub-test is T65:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">010540</span> <span class="nt">010701</span>                  <span class="nt">T65</span><span class="o">:</span>    <span class="nt">SCOPE</span>                    <span class="o">;</span>
<span class="nt">010542</span> <span class="nt">012737</span>  <span class="nt">030000</span>  <span class="nt">177776</span>          <span class="nt">MOV</span>     <span class="nn">#PUM</span><span class="o">,@</span><span class="nn">#PSW</span>       <span class="o">;</span><span class="nt">KERNEL</span> <span class="nt">MODE</span><span class="o">,</span> <span class="nt">PREV</span> <span class="nt">USER</span> <span class="nt">MODE</span>
<span class="nt">010550</span> <span class="nt">012706</span>  <span class="nt">000500</span>                  <span class="nt">MOV</span>     <span class="nn">#KPTR</span><span class="o">,</span><span class="nt">KSP</span>        <span class="o">;</span><span class="nt">SET</span> <span class="nt">KERNEL</span> <span class="nt">STACK</span> <span class="nt">POINTER</span>
<span class="nt">010554</span> <span class="nt">012716</span>  <span class="nt">000700</span>                  <span class="nt">MOV</span>     <span class="nn">#UPTR</span><span class="o">,(</span><span class="nt">KSP</span><span class="o">)</span>
<span class="nt">010560</span> <span class="nt">106606</span>                          <span class="nt">MTPD</span>    <span class="nt">USP</span>              <span class="o">;</span><span class="nt">SET</span> <span class="nt">USER</span> <span class="nt">STATCK</span> <span class="nt">POINTER</span>
<span class="nt">010562</span> <span class="nt">005067</span>  <span class="nt">170110</span>                  <span class="nt">CLR</span>     <span class="nt">UPTR-2</span>
<span class="nt">010566</span> <span class="nt">052737</span>  <span class="nt">140000</span>  <span class="nt">177776</span>          <span class="nt">BIS</span>     <span class="nn">#UM</span><span class="o">,@</span><span class="nn">#PSW</span>        <span class="o">;</span><span class="nt">USER</span> <span class="nt">MODE</span><span class="o">,</span> <span class="nt">PREV</span> <span class="nt">USER</span> <span class="nt">MODE</span>
<span class="nt">010574</span> <span class="nt">106506</span>                          <span class="nt">MFPD</span>    <span class="nt">USP</span>              <span class="o">;</span><span class="nt">PUSH</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">ONTO</span> <span class="nt">USER</span> <span class="nt">STACK</span>
<span class="nt">010576</span> <span class="nt">042737</span>  <span class="nt">140000</span>  <span class="nt">177776</span>          <span class="nt">BIC</span>     <span class="nn">#UM</span><span class="o">,@</span><span class="nn">#PSW</span>        <span class="o">;</span><span class="nt">KERNEL</span> <span class="nt">MODE</span><span class="o">,</span> <span class="nt">PREV</span> <span class="nt">USER</span> <span class="nt">MODE</span>
<span class="nt">010604</span> <span class="nt">106506</span>                          <span class="nt">MFPD</span>    <span class="nt">USP</span>              <span class="o">;</span><span class="nt">PUSH</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">ONTO</span> <span class="nt">KERNEL</span> <span class="nt">STACK</span>
<span class="nt">010606</span> <span class="nt">022716</span>  <span class="nt">000676</span>                  <span class="nt">CMP</span>     <span class="nn">#UPTR-2</span><span class="o">,(</span><span class="nt">KSP</span><span class="o">)</span>    <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">THAT</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">WAS</span>
<span class="nt">010612</span> <span class="nt">001401</span>                          <span class="nt">BEQ</span>     <span class="o">.+</span><span class="nt">4</span>              <span class="o">;</span><span class="nt">PUSHED</span> <span class="nt">PROPERLY</span> <span class="o">(</span><span class="nt">ONCE</span><span class="o">)</span>
<span class="nt">010614</span> <span class="nt">000000</span>                          <span class="nt">HLT</span>                      <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span>
<span class="nt">010616</span> <span class="nt">022767</span>  <span class="nt">000700</span>  <span class="nt">170052</span>          <span class="nt">CMP</span>     <span class="nn">#UPTR</span><span class="o">,</span><span class="nt">UPTR-2</span>     <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">THAT</span> <span class="nt">USER</span> <span class="nt">STACK</span> <span class="nt">POINTER</span> <span class="nt">IS</span> <span class="nt">ON</span> <span class="nt">THE</span>
<span class="nt">010624</span> <span class="nt">001401</span>                          <span class="nt">BEQ</span>     <span class="o">.+</span><span class="nt">4</span>              <span class="o">;</span><span class="nt">USERS</span> <span class="nt">STACK</span>
<span class="nt">010626</span> <span class="nt">000000</span>                          <span class="nt">HLT</span>                      <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span>
</pre></div>
</td></tr></table>

<p>This runs amok on the MFPD instruction at 010574, which should push the user stack pointer onto the user stack.
Instead, the user stack pointer is pushed to memory at an incorrect address; 010676 instead of 000676.  This actually
overwrites subsequent test code. Since the value pushed is 000700, a hard-coded loop is created that prevents the
test from completing the pass even if resumed from halt.</p>
<p>The relevant states in the microcode flow here are MFP.80, MFP.90, and MFP.10:</p>
<p><img src='/images/pdp11/mfpd-microcode.png'/></p>
<p>Stopping at T2 of MFP.10 using the KM11, I can see that the correct value 000700 was fetched to DR (as displayed by
the console address lights), but the incorrect value of 010676 is appearing at the output of the ALU/shifter (as
displayed by the console data lights when set to data paths).  Throwing the DAP card out on extenders and taking
a look around with a logic probe revealed that the errant bit 12 is sourcing from the ALU.  At each slice of the ALU,
function selectors S3-S0 are correct, CIN is correct, and overall B-mux constant value "2" is correct.  The errant bit
is arriving to the ALU from the A-mux...</p>
<p>Chasing this upstream, A-mux selectors S1,S0 are correct, but the bad bit arrives to the mux input on GRAH SR12.  Hmmm,
maybe this is one of the things the "BAD" sticker on the GRA is referring to...  Next step is to throw the GRA on
the extender, and chase the signal back towards SR and the register files.  However, here I hit a snag: the M9301
monitor does not run correctly when the GRA is on the extender!  That's pretty weird.  Some investigation with the
KM11 and some hand-toggled instructions revealed that at least the Z status bit is not set correctly/reliably when
the card is on the extender.  Some of the Z bit logic lives on the GRA also, so I can take a look at that, but I am
now out of time for this weekend.  Next time!</p>
<p>A few other miscellaneous notes in wrap-up:</p>
<ul>
<li>
<p>I have been running with the spare GRA marked "BAD" because the first GRA I was using turned out to have a failed ALU
subsidiary PROM.  In the meantime I tracked down a PROM programmer and some compatible parts on eBay -- these should
arrive sometime this week at which point I should be able to repair the original board and give it another try.</p>
</li>
<li>
<p>The uPB feature of my home-brew KM11 really doesn't work quite right.  It often stops the machine at the requested
micro-state but on the wrong instruction (skipping the first occurrence of the target state seemingly).  This caused
me a great deal of confusion today, as I was stepping through flows at a different program location than I had assumed,
until I finally noticed the address lights on the console.</p>
</li>
<li>
<p>ESC key on the VT52 is non-functional, making it impractical to use for RT11.  The key mechanism looks okay from the
top (thanks for more helpful advice from the vcfed forum!).  I think I'll need to pull the keyboard PCB and re-flow the
solder on the affected mechanism as a next step.</p>
</li>
<li>
<p>Looking forward to checking out Vintage Computer Fest West sometime next weekend!</p>
</li>
</ul></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-4.html"><h1>PDP-11/45: Diagnostics IV - CKBME0</h1></a>
Sun 17 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Some progress with the CKBME0 diagnostic mentioned previously.  It seems the concern with how the test behaves wrt.
preconditions of the serial interface was well founded.</p>
<p>In order to debug more easily, I extracted the failing test and built a small loop around it, with a pass counter
and display register update, etc.  In the original test suite, a RESET instruction is executed immediately prior to
the failing test, and it takes some time to come around the failing test on each pass, so I included a RESET and
a delay loop in my test code as well.  I then got failure modes and rates consistent with the original test suite.</p>
<p>The experiments previously described had indicated timing sensitivity (e.g. running on the RC maintenance clock at 50%
clock speed changed the pass failure rate from ~50% to 100%) so I began to think more seriously about timing
between the processor and the serial card, and how the time taken to circulate the entire suite of tests could affect
the precondition of the serial interface when entering the test in subsequent passes.  A re-read of the DL11
documentation showed that the transmit data is also double-buffered; if the transmit shift register is empty, a
character written to the output buffer will be latched to the transmit shift register causing the output buffer to
go ready again almost immediately.</p>
<p>I inserted the following code before the BIS/WAIT sequence in the original diagnostic (listed previously), which
establishes consistent preconditions (shift register full, buffer empty) before the BIS.  Success rate went to 100%:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="nt">MOV</span>     <span class="nn">#40</span><span class="o">,@</span><span class="nn">#177566</span>    <span class="o">;</span><span class="nt">ENSURE</span> <span class="nt">XMIT</span> <span class="nt">SHIFT</span> <span class="nt">REGISTER</span> <span class="nt">HAS</span> <span class="nt">SOMETHING</span> <span class="nt">TO</span> <span class="nt">CHEW</span> <span class="nt">ON</span>
<span class="nt">L0</span><span class="o">:</span>     <span class="nt">TSTB</span>    <span class="o">@</span><span class="nn">#TTCSR</span>         <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">XMIT</span> <span class="nt">BUFFER</span>
        <span class="nt">BPL</span>     <span class="nt">L0</span>              <span class="o">;</span><span class="nt">LOOP</span> <span class="nt">UNTIL</span> <span class="nt">READY</span><span class="o">,</span> <span class="nt">ENSURES</span> <span class="nt">INT</span> <span class="nt">IMMEDIATELY</span> <span class="nt">AFTER</span> <span class="nt">BIS</span>
</pre></div>
</td></tr></table>

<p>I then further verified that the unmodified original diagnostic suite passes 100% if I turn the M7800 down to 4800
Baud.  Worth noting when trying to run these older diagnostics!</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/vt52-repair.html"><h1>PDP-11/45: VT52 repair</h1></a>
Sat 16 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Replacement oscillator arrived for the VT52, so spent some time getting it back going again.  Things got <em>much</em> better
with a stable timing chain, but some glitchiness remained -- tracked this down to the socketed microcode ROMS which
just required a reseat.</p>
<p>Here you can see the new oscillator fitted (silver rectangular can with tie-wrap).  The microcode ROMS are the four
socketed chips towards the right in the picture.  Interestingly, the schematic I have calls for 8 ROMS of half the size
of the ones that are in here, and indeed you can see the unpopulated spaces for these on the board.</p>
<p><a href="http://fritzm.github.io/images/pdp11/vt52-repair.jpg"><img src='/images/pdp11/vt52-repair_thumbnail_tall.jpg'/></a></p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-3.html"><h1>PDP-11/45: Diagnostics III - CKBME0</h1></a>
Sat 09 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Okay, digging into the CKBME0 traps diagnostic now in more detail.  Here I've transcribed the source of the failing
test from the older available diagnostic listing, then re-assembled it at the address matching the more modern
binary.  This makes it a little easier to follow along while debugging the newer binary:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">013604</span> <span class="nt">000230</span>                          <span class="nt">SPL</span>     <span class="nt">0</span>               <span class="o">;</span><span class="nt">SET</span> <span class="nt">PRIORITY</span> <span class="nt">LEVEL</span> <span class="nt">0</span>
<span class="nt">013606</span> <span class="nt">012706</span>  <span class="nt">000500</span>                  <span class="nt">MOV</span>     <span class="nn">#STKPTR</span><span class="o">,%</span><span class="nt">6</span>      <span class="o">;</span><span class="nt">SET</span> <span class="nt">STACK</span> <span class="nt">PTR</span>
<span class="nt">013612</span> <span class="nt">012737</span>  <span class="nt">013650</span>  <span class="nt">000064</span>          <span class="nt">MOV</span>     <span class="nn">#TTY7A</span><span class="o">,@</span><span class="nn">#TPVEC</span>  <span class="o">;</span><span class="nt">LOAD</span> <span class="nt">TTY</span> <span class="nt">INTERRUPT</span> <span class="nt">VECTOR</span>
<span class="nt">013620</span> <span class="nt">012737</span>  <span class="nt">013644</span>  <span class="nt">000014</span>          <span class="nt">MOV</span>     <span class="nn">#TTY7B</span><span class="o">,@</span><span class="nn">#BPTVEC</span> <span class="o">;</span><span class="nt">LOAD</span> <span class="s1">&#39;T&#39;</span> <span class="nt">BIT</span> <span class="nt">TRAP</span> <span class="nt">VECTOR</span>
<span class="nt">013626</span> <span class="nt">005002</span>                          <span class="nt">CLR</span>     <span class="o">%</span><span class="nt">2</span>              <span class="o">;</span><span class="nt">CLEAR</span> <span class="nt">INDICATOR</span>
<span class="nt">013630</span> <span class="nt">052737</span>  <span class="nt">000100</span>  <span class="nt">177564</span>          <span class="nt">BIS</span>     <span class="nn">#100</span><span class="o">,@</span><span class="nn">#TTCSR</span>    <span class="o">;</span><span class="nt">ALLOW</span> <span class="nt">INTERRUPT</span> <span class="nt">INTERRUPT</span> <span class="nt">OCCURS</span> <span class="nt">AFTER</span>
                                                               <span class="o">;</span><span class="nt">THIS</span> <span class="nt">INSTRUCTION</span> <span class="o">&amp;</span> <span class="nt">BEFORE</span> <span class="nt">NEXT</span>
<span class="nt">013636</span> <span class="nt">000001</span>                  <span class="nt">WAIT1</span><span class="o">:</span>  <span class="nt">WAIT</span>                    <span class="o">;</span><span class="nt">WAIT</span> <span class="nt">FOR</span> <span class="nt">AN</span> <span class="nt">INTERRUPT</span>
<span class="nt">013640</span> <span class="nt">005202</span>                          <span class="nt">INC</span>     <span class="o">%</span><span class="nt">2</span>              <span class="o">;</span><span class="nt">INCREMENT</span> <span class="nt">INDICATOR</span>
<span class="nt">013642</span> <span class="nt">000000</span>                          <span class="nt">HLT</span>                     <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span> <span class="nt">NO</span> <span class="s1">&#39;T&#39;</span> <span class="nt">TRAP</span> <span class="nt">AFTER</span> <span class="nt">INTERRUPT</span>
<span class="nt">013644</span> <span class="nt">000000</span>                  <span class="nt">TTY7B</span><span class="o">:</span>  <span class="nt">HLT</span>                     <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span> <span class="s1">&#39;T&#39;</span> <span class="nt">BIT</span> <span class="nt">TRAPPED</span> <span class="nt">OUT</span> <span class="nt">OF</span> <span class="nt">WAIT</span>
<span class="nt">013646</span> <span class="nt">000424</span>                          <span class="nt">BR</span>      <span class="nt">TTY7EX</span>          <span class="o">;</span><span class="nt">EXIT</span> <span class="nt">TEST</span>
<span class="nt">013650</span> <span class="nt">012737</span>  <span class="nt">000040</span>  <span class="nt">177566</span>  <span class="nt">TTY7A</span><span class="o">:</span>  <span class="nt">MOV</span>     <span class="nn">#40</span><span class="o">,@</span><span class="nn">#177566</span>    <span class="o">;</span><span class="nt">TYPE</span> <span class="nt">SPACE</span> <span class="nt">CHAR</span>
<span class="nt">013656</span> <span class="nt">012737</span>  <span class="nt">013674</span>  <span class="nt">000064</span>          <span class="nt">MOV</span>     <span class="nn">#TTY7C</span><span class="o">,@</span><span class="nn">#TPVEC</span>  <span class="o">;</span><span class="nt">REPOSITION</span> <span class="nt">TTY</span> <span class="nt">INT</span> <span class="nt">VECTOR</span>
<span class="nt">013664</span> <span class="nt">012766</span>  <span class="nt">000020</span>  <span class="nt">000002</span>          <span class="nt">MOV</span>     <span class="nn">#20</span><span class="o">,</span><span class="nt">2</span><span class="o">(</span><span class="nt">6</span><span class="o">)</span>        <span class="o">;</span><span class="nt">PUT</span> <span class="s1">&#39;T&#39;</span> <span class="nt">BIT</span> <span class="nt">IN</span> <span class="nt">RETURN</span> <span class="nt">STATUS</span>
<span class="nt">013672</span> <span class="nt">000006</span>                          <span class="nt">RTT</span>                     <span class="o">;</span><span class="nt">RETURN</span> <span class="nt">TO</span> <span class="nt">WAIT</span> <span class="nt">WITH</span> <span class="s1">&#39;T&#39;</span> <span class="nt">BIT</span> <span class="nt">SET</span>
                                                               <span class="o">;</span><span class="nt">AND</span> <span class="nt">WAIT</span> <span class="nt">FOR</span> <span class="nt">TTY</span> <span class="nt">INTERRUPT</span> <span class="nt">WHEN</span> <span class="nt">NULL</span>
                                                               <span class="o">;</span><span class="nt">CHARACTER</span> <span class="nt">IS</span> <span class="nt">TYPED</span>
<span class="nt">013674</span> <span class="nt">012737</span>  <span class="nt">013716</span>  <span class="nt">000014</span>  <span class="nt">TTY7C</span><span class="o">:</span>  <span class="nt">MOV</span>     <span class="nn">#TTY7D</span><span class="o">,@</span><span class="nn">#BPTVEC</span> <span class="o">;</span><span class="nt">REPOINT</span> <span class="s1">&#39;T&#39;</span> <span class="nt">BIT</span> <span class="nt">TRAP</span> <span class="nt">VECTOR</span> <span class="nt">AFTER</span>
                                                               <span class="o">;</span><span class="nt">TTY</span> <span class="nt">HAS</span> <span class="nt">INTERRUPTED</span>
<span class="nt">013702</span> <span class="nt">005037</span>  <span class="nt">177564</span>                  <span class="nt">CLR</span>     <span class="o">@</span><span class="nn">#TTCSR</span>         <span class="o">;</span><span class="nt">DISABLE</span> <span class="nt">INTERRUPT</span> <span class="nt">ENABLE</span>
<span class="nt">013706</span> <span class="nt">012737</span>  <span class="nt">000015</span>  <span class="nt">177566</span>          <span class="nt">MOV</span>     <span class="nn">#15</span><span class="o">,@</span><span class="nn">#177566</span>
<span class="nt">013714</span> <span class="nt">000006</span>                          <span class="nt">RTT</span>                     <span class="o">;</span><span class="nt">RETURN</span> <span class="nt">TO</span> <span class="nt">INST</span> <span class="nt">FOLLOWING</span> <span class="nt">WAIT</span> <span class="nt">WITH</span> <span class="s1">&#39;T&#39;</span>
                                                               <span class="o">;</span><span class="nt">BIT</span> <span class="nt">SET</span>
<span class="nt">013716</span> <span class="nt">000240</span>                  <span class="nt">TTY7D</span><span class="o">:</span>  <span class="nt">NOP</span>
<span class="nt">013720</span> <span class="nt">012737</span>  <span class="nt">000016</span>  <span class="nt">000014</span>  <span class="nt">TTY7EX</span><span class="o">:</span> <span class="nt">MOV</span>     <span class="nn">#BPTVEC</span><span class="o">+</span><span class="nt">2</span><span class="o">,@</span><span class="nn">#BPTVEC</span><span class="o">;</span><span class="nt">RESTORE</span> <span class="nt">VECTORS</span> <span class="nt">TO</span> <span class="nt">HALT</span> <span class="nt">AT</span>
<span class="nt">013726</span> <span class="nt">012737</span>  <span class="nt">000066</span>  <span class="nt">000064</span>          <span class="nt">MOV</span>     <span class="nn">#66</span><span class="o">,@</span><span class="nn">#TPVEC</span>     <span class="o">;</span><span class="nt">VECTOR</span> <span class="o">+</span><span class="nt">2</span>
<span class="nt">013734</span> <span class="nt">005302</span>                          <span class="nt">DEC</span>     <span class="o">%</span><span class="nt">2</span>              <span class="o">;</span><span class="nt">CHECK</span> <span class="nt">INDICATOR</span>
<span class="nt">013736</span> <span class="nt">001401</span>                          <span class="nt">BEQ</span>     <span class="o">.+</span><span class="nt">4</span>
<span class="nt">013740</span> <span class="nt">000000</span>                          <span class="nt">HLT</span>                     <span class="o">;</span><span class="nt">ERROR</span><span class="o">!</span> <span class="nt">DID</span> <span class="nt">NOT</span> <span class="nt">DO</span> <span class="nt">INC</span> <span class="nt">INST</span> <span class="nt">AFTER</span> <span class="nt">INTERRUPT</span>
</pre></div>
</td></tr></table>

<p>This test seems to be designed to return from an interrupt handler to a WAIT instruction, with the T bit set in
the PSW and a serial xmit interrupt pending.  It verifies that the WAIT still "waits" in this circumstance.  It also
verifies that a trace trap <em>does</em> occur after the immediately following INC instruction when the xmit interrupt
subsequently terminates the WAIT.</p>
<p>One potential problem with this test concerns the apparent assumption that enabling the xmit interrupt will cause an
immediate trap before the subsequent WAIT instruction.  This is true if the serial transmitter is empty, but if the
transmitter is ever full/busy when this code is entered this assumption may not hold.  Not sure yet if this will ever
be a problem for this test given the surrounding code.</p>
<p>In any case, as currently written this routine fails about 50% of the time on my 11/45.  The failure mode
is that the processor sits at the WAIT instruction, (address display 013640, PC+2).  Intervention with the
console halt switch (halt then back to enabl) breaks the WAIT microcode loop; console cont then takes us to the halt
at 013740 (address display 013742, PC+2).</p>
<p>The fact that the routine is tailing out through the halt at 013740 without hitting the halts at 013642 or 013644 is
interesting; this implies that the second serial xmit interrupt to TTY7C has executed.  This is verified by examining
the break trap from the console after the test hangs up on the WAIT -- in the failure case, it is already reset to
point to TTY7D.  So the failure mode seems to be that the return from the second xmit interrupt sometimes goes to the
WAIT instead of the subsequent INC.</p>
<p>Here is the microcode flow around the WAIT instruction.  The horizontal line across the top is the A fork:</p>
<p><img src='/images/pdp11/wait-microcode.png'/></p>
<p>Using the KM11, in the failure case I can see the T bit set and the microcode looping through states WAT.00, WAT.20, WAT.30, WAT.11, which seems expected.  I have also verified that executing a WAIT <em>without</em> the T bit set
loops through states WAT.00 and WAT.10.</p>
<p>Lastly, running on the RC maintenance clock at about half the usual clock frequency makes the failure case happen
almost 100% of the time.</p>
<p>Next I'll be needing to learn more about the BRQ logic, and in particular the mechanism by which the second xmit
interrupt nominally causes INTRF to be asserted.  Understanding that should lead me to some things to check with the
logic probe and analyzer...</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics-2.html"><h1>PDP-11/45: Diagnostics II</h1></a>
Mon 04 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Investigated some of the halted diagnostics a bit today.  CKBGB0 (SPL instruction test) was halting at 001404.
Looking at the sources, the diagnostic was waiting at this point for a transmit interrupt from the DL11 that didn't
seem to be arriving. Some troubleshooting turned up that the vector address on my DL11 was jumpered incorrectly.  Fixed this, and the diagnostic now passes.</p>
<p>CKBME0 (11/45 traps test) is a bit more complicated.  The halt address of 005320 here indicates that the floating
point coprocessor is detected but not trapping per design.  Pulled the floating point cards for now; the diagnostic
now runs through several passes successfully, but regularly hangs up at 013640.  Hitting the halt
switch when it is hung up displays 000342 in the address lights, then with a couple continues it will start up again,
run a bunch more passes, but sooner or later hang up at 013640 again with the same behavior.  This behavior is a
little more difficult to decode because the diagnostic itself is more complicated, and also the binary available from
classicmp is a later revision than the available source code so the addresses don't quite match up.  So I'll need to
spend a little more time reading the diagnostic sources and examining the disassembly in PDP11GUI to make sense of this
one.  And it looks like there will be some downstream work to debug the floating point unit as well; I haven't studied
its design yet at all.</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/diagnostics.html"><h1>PDP-11/45: Diagnostics with PDP11GUI</h1></a>
Sun 03 July 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Okay, now that serial is straightened out, on to running diagnostic tests via PDP11GUI.  PDP11GUI itself, as well as
a thorough and useful database of DEC diagnostic programs, are available at <a href="http://www.retrocmp.com/tools">http://www.retrocmp.com/tools</a>.</p>
<p>Since my home computer is a MacBook, I had intended to run PDP11GUI under Wine.  I ran into a problem with this where
PDP11GUI under Wine could not generate its pre-processed machine description temp file, seemingly because of some
incompatible behavior wrt. multiple backslashes in pathnames.  Rather than fight with this too long, I just sprang for
a Windows 10 license and installed a Windows 10 VM; it will come in handy for other Windows-only tools that have
been tweaky to use under Wine as well.</p>
<p>With PDP11GUI up and running under Windows, results of the initial set of 11/45 CPU diagnostics were very encouraging!
In summary:</p>
<style>
.diaglist { display: inline; border-collapse: collapse; margin-right: 1em; }
.diaglist caption { font-weight: bold; }
.diaglist tr:nth-child(even) { background-color: #f2f2f2; }
.diaglist th, .diaglist td { padding: 5px; }
.diaglist td { border: 1px solid lightgray; font-family: Menlo,Consolas,monospace; }
</style>

<table class="diaglist">
<thead>
<tr><th>Diagnostic</th><th>BEL</th><th>Description</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td>CKBAB0.BIC</td><td>002562</td><td>SXT instruction</td><td>pass</td></tr>
<tr><td>CKBBB0.BIC</td><td>003604</td><td>SOB instruction</td><td>pass</td></tr>
<tr><td>CKBCB0.BIC</td><td>007410</td><td>XOR instruction</td><td>pass</td></tr>
<tr><td>CKBDC0.BIC</td><td>007262</td><td>MARK instruction</td><td>pass</td></tr>
<tr><td>CKBEC0.BIC</td><td>002212</td><td>RTI/RTT instructions</td><td>pass</td></tr>
<tr><td>CKBFD0.BIC</td><td>002272</td><td>stack limit</td><td>pass</td></tr>
<tr><td>CKBGB0.BIC</td><td>001446</td><td>SPL instruction</td><td>halt 001404</td></tr>
<tr><td>CKBHB0.BIC</td><td>003762</td><td>11/45 registers</td><td>pass</td></tr>
<tr><td>CKBIB0.BIC</td><td>013746</td><td>ASH instruction</td><td>pass</td></tr>
<tr><td>CKBJA0.BIC</td><td>014722</td><td>ASHC instruction</td><td>pass</td></tr>
<tr><td>CKBKA0.BIC</td><td>014430</td><td>MUL instruction</td><td>pass</td></tr>
<tr><td>CKBLA0.BIC</td><td>011574</td><td>DIV instruction</td><td>pass</td></tr>
<tr><td>CKBME0.BIC</td><td>016000</td><td>11/45 traps</td><td>halt 005320</td></tr>
<tr><td>CKBNC0.BIC</td><td>004702</td><td>PIRQ instruction</td><td>pass</td></tr>
<tr><td>CKBOA0.BIC</td><td>013640</td><td>11/45 states</td><td>halt 000610</td></tr>
</tbody>
</table>

<p>Note that these tests are written to output an ASCII BEL to the console on each successful pass.  The terminal
built in to PDP11GUI doesn't sound when given a BEL, however, so it is convenient to patch the BEL literal in the
programs to a visible character (e.g. 000052, ASCII '*') before running them.  This may be done in the memory loader
window in PDP11GUI after "Load" but before "Deposit all".  The patch address I identified for each diagnostic is
listed in the table above as well for convenience.</p>
<p>So, out of this initial set of tests, only three halts to investigate.  I'll be posting more information here as I look
further into these.</p>
<p>Regarding the backplane SPC issue discussed in the previous post: Marty from the vcfed.org forum did some investigation
of his 11/45, and reports that he does have +15V (actually +12V on his system) distributed to pin CU1 on slots
26-28.  It seems to be wired over from slot 15 on his system, but it is not clear whether this was a factory wire,
an ECO, or a user mod.</p>
<p>Marty's 11/45 also has no power distributed to CA1 on this slots, so it's really looking to me like the reference
to that on page 5-10 of the 11/45 maintenance manual is a misprint.  Thanks to Marty for checking all this out!  I'd be
curious to hear from any other 11/45 owners out there regarding wiring of CU1 and CA1 on slots 26-28 in their systems.</p>
<p><a href="http://fritzm.github.io/images/pdp11/pdp11gui.jpg"><img src='/images/pdp11/pdp11gui_thumbnail_tall.jpg'/></a></p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/serial-console.html"><h1>PDP-11/45: Serial console and backplane SPC slots</h1></a>
Sun 26 June 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Hit a snag on the way to getting PDP11GUI hooked up: while the M9301 console emulator was working fine with the VT52,
I could not get serial communication to my laptop (MacBook Pro + Keyspan USA-19HS USB serial) to work as expected.  Some
detective work showed that the voltages from the EIA output drivers on the DL11 were way out of whack (+3V for mark,
which should have been a negative voltage).  Somehow the VT52 was able to still make sense out of this signaling,
though the laptop was not.</p>
<p>Some investigation of power to the DL11, which was sitting in one of the backplane SPC slots (26-28), showed that there
was no distribution of +15V to pin CU1 of these slots where the DL11 was expecting it.  So that explained the bad
driver output voltages.  Moved the DL11 over to the DD11 expansion backplane which does have +15V to that pin, and
serial to/from the laptop started working fine.</p>
<p>So this raises a bit of a question about the SPC slots on the 11/45 backplane.  Was EIA console serial from these slots
ever supported?  The configurations listed in the 11/45 engineering prints call out only DL11-A, the 20mA current
loop version, which doesn't have EIA drivers and thus doesn't need the +15V supply, so maybe not.  Was +15V distribution
perhaps added to these slots in subsequent revisions or via an ECO?  I'd like to track down a wire list for this or
later revision 11/45 backplanes, and/or a comprehensive list of KB11-A ECOs, but so far haven't seen traces of either
anywhere out there.</p>
<p>One other curiosity of these SPC slots that came up while investigating this: the power distribution table in
the 11/45 maintenance manual, EK-11045-MM-007, page 5-10, implies that +15V should be distributed to the SPC slots on
CA1.  This is suspicious to me (maybe a typo?) because all other SPC pinouts that I have seen use this pin and CB1
as NPR in/out.  And in checking my backplane, there is no power distribution to those pins.  But slots 27 and 28
(Unibus B) do have their CA1 pins bridged to one another, and their CB1 pins bridged to one another, with what look like
factory installed wire wraps.  This also seems unusual for NPR/NPG.  So, some mysteries remain about these slots...</p>
<p>In other news, the clock oscillator on the VT52 has given out, so that's down now until I can find a replacement.  They
are out of production and aren't easy to track down, but I do have one lead to follow so far.</p>
<p>Also, I pulled the suspected failed subsidiary ALU control ROM, tested it in isolation, and verified that it had indeed
failed.  This card is just a spare for me, but I'd like to go ahead and repair it since the fault is isolated.  With
some help from the classiccmp mailing list (thanks guys!) I have a recommendation for some vintage PROM programmers to
stalk on eBay, and some compatible parts, that would allow me to blow a replacement and make the repair.</p></div>
    <hr />
</div>



<div class='article'>
    <div class="content-title">
        <a href="http://fritzm.github.io/m9301-running.html"><h1>PDP-11/45: Running the M9301 console emulator</h1></a>
Thu 23 June 2016

by <a class="url fn" href="http://fritzm.github.io/author/fritz-mueller.html">Fritz Mueller</a>
 


    </div>

    <div><p>Replacement DRAMs showed up.  Pulled and replaced the two faulty ones on the MS11.  Pic below -- you can see the
replacements are socketed, and are the TI parts instead of the original ITT.  Full address space is working now!  Now
that bank 0 is repaired, trap vectors can conceivably work.</p>
<p>Jumpered and configured a DL11-E serial card for use as console, slotted in an M9301-YB bootstrap terminator, connected
up the VT52, powered up, and off it goes straight to the console emulator!  That means the basic instruction set tests
in the boot ROM are passing as well, which is great news.</p>
<p>Next step will be to hook up PDP11GUI and load some more in-depth diagnostics, in order to shake out any
remaining bugs with the CPU and memory system.  Will slot in the FPU at that point for testing and debug as well.</p>
<p><a href="http://fritzm.github.io/images/pdp11/ms11-repaired.jpg"><img src='/images/pdp11/ms11-repaired_thumbnail_tall.jpg'/></a>
<a href="http://fritzm.github.io/images/pdp11/m9301-running.jpg"><img src='/images/pdp11/m9301-running_thumbnail_tall.jpg'/></a></p></div>
    <hr />
</div>

<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="http://fritzm.github.io/author/fritz-mueller.html">1</a></li>
    <li class=""><a href="http://fritzm.github.io/author/fritz-mueller2.html">2</a></li>
    <li class=""><a href="http://fritzm.github.io/author/fritz-mueller3.html">3</a></li>

    <li class="next"><a href="http://fritzm.github.io/author/fritz-mueller2.html">Next &rarr;</a></li>

</ul>
</div>
  
        </div>

        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Site
                </li>

                <li><a href="http://fritzm.github.io/">Archives</a>
                <li><a href="http://fritzm.github.io/tags.html">Tags</a>



                <li><a href="http://fritzm.github.io/feeds/all.atom.xml" rel="alternate" type="application/atom+xml">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Categories
                </li>

                <li><a href="http://fritzm.github.io/category/math.html">Math</a></li>
                <li><a href="http://fritzm.github.io/category/pdp-11.html">PDP-11</a></li>
                <li><a href="http://fritzm.github.io/category/programming.html">Programming</a></li>
            </ul>
            </div>




            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Social
                </li>

                <li><a href="http://facebook.com/fritzmueller">facebook</a></li>
                <li><a href="http://twitter.com/infrafritz">twitter</a></li>
                <li><a href="http://instagram.com/infrafritz">Instagram</a></li>
                <li><a href="http://www.linkedin.com/pub/fritz-mueller/a/679/62/">LinkedIn</a></li>
                <li><a href="http://jsfiddle.net/user/fritzm/fiddles/">JSFiddle</a></li>
                <li><a href="https://github.com/fritzm">GitHub</a></li>
            </ul>
            </div>
            </div>

        </div>     </div>     </div> 
<footer>
<br />
<p><a href="http://fritzm.github.io">fritzm.github.io</a> &copy; Fritz Mueller 2012</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
</body>
</html>